<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì„¸ê³µì‚¬ v5.2 â€” ìƒê¸°ë¶€ ì „ëµ ë¶„ì„</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#F4F5F7;--white:#FFF;--black:#191F28;--g1:#333D4B;--g2:#4E5968;--g3:#8B95A1;--g4:#B0B8C1;--g5:#D1D6DB;--g6:#E5E8EB;--g7:#F2F4F6;
--blue:#3182F6;--blue-bg:#EBF4FF;--coral:#FF6B6B;--coral-bg:#FFF0F0;--green:#00C471;--green-bg:#E8FAF0;--purple:#7B61FF;--purple-bg:#F0EDFF;--orange:#FF9F43;--orange-bg:#FFF5EB;--teal:#22B8CF;--teal-bg:#E3FAFC;--gold:#FFB800;--gold-bg:#FFF8E1;
--sh:0 2px 8px rgba(0,0,0,0.04);--sh2:0 4px 16px rgba(0,0,0,0.06);
--r:20px;--rm:16px;--rs:12px;--rx:10px;
}
body{font-family:'Noto Sans KR',-apple-system,sans-serif;background:var(--bg);color:var(--black);line-height:1.6;-webkit-font-smoothing:antialiased}
.wrap{max-width:1080px;margin:0 auto;padding:0 24px 60px}

/* Header */
.hdr{padding:32px 0 12px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--bg);z-index:100}
.hdr h1{font-size:26px;font-weight:900;letter-spacing:-0.5px}
.hdr-badge{display:flex;align-items:center;gap:6px;padding:7px 14px;background:var(--blue-bg);border-radius:100px;font-size:12px;font-weight:700;color:var(--blue)}
.hdr-badge .dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:bk 1.5s infinite}
@keyframes bk{0%,100%{opacity:1}50%{opacity:.3}}

/* Class Banner */
.class-banner{background:linear-gradient(135deg,#0F3A8C 0%,#1B5BD6 40%,#3182F6 70%,#22B8CF 100%);border-radius:var(--r);padding:20px 24px;margin:0 0 12px;display:flex;align-items:center;gap:20px;color:#fff;position:relative;overflow:hidden;box-shadow:0 4px 20px rgba(49,130,246,0.3)}
.class-banner::before{content:'';position:absolute;top:-50px;right:-30px;width:180px;height:180px;background:rgba(255,255,255,0.05);border-radius:50%}
.cb-main{flex:1;min-width:0;z-index:1}.cb-class{font-size:30px;font-weight:900;letter-spacing:-1px;line-height:1.1}
.cb-meta{font-size:13px;font-weight:500;margin-top:4px;opacity:0.85;display:flex;align-items:center;gap:0}
.cb-school{font-weight:600}.cb-divider{margin:0 8px;opacity:0.5}.cb-teacher{font-weight:800}
.cb-stats{display:flex;align-items:center;gap:4px;flex-shrink:0;z-index:1}
.cb-stat{text-align:center;padding:8px 12px}.cb-stat-num{font-size:26px;font-weight:900;line-height:1}
.cb-stat-label{font-size:10px;font-weight:600;opacity:0.65;margin-top:2px}.cb-stat-sep{font-size:20px;opacity:0.3;font-weight:300}
.cb-edit{position:absolute;top:10px;right:12px;background:rgba(255,255,255,0.15);border:none;color:#fff;width:32px;height:32px;border-radius:8px;font-size:14px;cursor:pointer;z-index:2;display:flex;align-items:center;justify-content:center;transition:background .2s}
.cb-edit:hover{background:rgba(255,255,255,0.3)}
@media(max-width:600px){.class-banner{flex-wrap:wrap;padding:16px 18px;gap:8px}.cb-class{font-size:24px}.cb-meta{font-size:12px}}
.class-banner-empty{background:var(--g7);border:2px dashed var(--g5);border-radius:var(--r);padding:20px 24px;margin:0 0 12px;display:flex;align-items:center;gap:14px;color:var(--g2);font-size:14px}

/* Top cards scroll */
.top-scroll{display:flex;gap:12px;overflow-x:auto;padding:8px 0 16px;-webkit-overflow-scrolling:touch}
.top-scroll::-webkit-scrollbar{display:none}
.t-card{min-width:150px;padding:20px 18px;border-radius:var(--r);text-align:center;box-shadow:var(--sh2);flex-shrink:0;transition:transform .2s;cursor:default}
.t-card:hover{transform:translateY(-3px)}
.t-card .t-icon{font-size:36px;margin-bottom:10px}
.t-card .t-label{font-size:13px;font-weight:700;color:var(--g1)}
.t-card .t-sub{font-size:11px;color:var(--g3);margin-top:3px;font-weight:500}

/* 2-col layout for wide screens */
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:760px){.grid2{grid-template-columns:1fr}}

/* Card */
.card{background:var(--white);border-radius:var(--r);padding:24px;margin-top:14px;box-shadow:var(--sh);transition:box-shadow .3s}
.card:hover{box-shadow:var(--sh2)}
.card-top{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.c-icon{width:44px;height:44px;border-radius:var(--rs);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
.c-icon.blue{background:var(--blue-bg)}.c-icon.coral{background:var(--coral-bg)}.c-icon.green{background:var(--green-bg)}.c-icon.purple{background:var(--purple-bg)}.c-icon.orange{background:var(--orange-bg)}.c-icon.teal{background:var(--teal-bg)}
.c-title{font-size:17px;font-weight:800;letter-spacing:-.3px}
.c-desc{font-size:13px;color:var(--g3)}

/* Form */
label{font-size:13px;font-weight:600;color:var(--g2);display:block;margin-bottom:5px}
input[type=text],input[type=password],textarea,select{width:100%;padding:12px 14px;background:var(--g7);border:1.5px solid transparent;border-radius:var(--rx);font-size:15px;color:var(--black);font-family:inherit;transition:all .2s;-webkit-appearance:none}
input::placeholder,textarea::placeholder{color:var(--g4);font-weight:400}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--blue);background:var(--white);box-shadow:0 0 0 3px rgba(49,130,246,.1)}
textarea{resize:vertical;min-height:72px}
select{cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%238B95A1' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:34px}
.row{display:grid;gap:10px}.r2{grid-template-columns:1fr 1fr}.r3{grid-template-columns:1fr 1fr 1fr}.r4{grid-template-columns:1fr 1fr 1fr 1fr}.r5{grid-template-columns:1fr 1fr 1fr 1fr 1fr}
@media(max-width:600px){.r4,.r5{grid-template-columns:1fr 1fr}}
.stu-id{font-size:14px;font-weight:800;color:var(--blue);background:var(--blue-bg);padding:10px 16px;border-radius:var(--rx);text-align:center;margin-top:8px;letter-spacing:1px}

/* Btn */
.btn{padding:14px 24px;border:none;border-radius:var(--rs);font-size:15px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .2s;display:inline-flex;align-items:center;justify-content:center;gap:8px}
.btn:active{transform:scale(.97)}
.btn-blue{background:var(--blue);color:#fff}.btn-blue:hover{background:#2272E6}
.btn-blue:disabled{background:var(--g6);color:var(--g4);cursor:not-allowed;transform:none}
.btn-green{background:var(--green);color:#fff}.btn-green:hover{background:#00B065}
.btn-purple{background:var(--purple);color:#fff}.btn-purple:hover{background:#6B50EE}
.btn-ghost{background:var(--g7);color:var(--g1);font-weight:600}.btn-ghost:hover{background:var(--g6)}
.btn-sm{padding:10px 16px;font-size:13px;border-radius:var(--rx)}
.btn-full{width:100%}

/* API */
.api-row{display:flex;gap:8px;align-items:end}.api-row .f{flex:1}
.api-st{font-size:12px;font-weight:600;margin-top:6px}.api-ok{color:var(--green)}.api-no{color:var(--coral)}

/* Dropzone */
.dz{border:2px dashed var(--g5);border-radius:var(--r);padding:40px 20px;text-align:center;cursor:pointer;transition:all .3s;background:var(--g7)}
.dz:hover,.dz.drag{border-color:var(--blue);background:var(--blue-bg)}
.dz.done{border-color:var(--green);background:var(--green-bg);border-style:solid}
.dz-i{font-size:40px;margin-bottom:10px}
.dz-m{font-size:15px;font-weight:700}
.dz-s{font-size:13px;color:var(--g3);margin-top:4px}
.file-input{display:none}
.f-info{margin-top:10px;padding:12px 14px;background:var(--green-bg);border-radius:var(--rx);font-size:13px;color:var(--green);font-weight:600}

/* Preset */
.presets{display:flex;gap:8px}
.pre{flex:1;padding:14px;border:2px solid var(--g6);border-radius:var(--rs);background:var(--white);cursor:pointer;text-align:center;transition:all .2s}
.pre:hover{border-color:var(--g5);background:var(--g7)}
.pre.on{border-color:var(--ac,var(--blue));background:var(--abg,var(--blue-bg))}
.pre .em{font-size:24px;display:block;margin-bottom:6px}
.pre .tx{font-size:13px;font-weight:700;color:var(--g2)}.pre.on .tx{color:var(--ac,var(--blue))}
.ptags{display:flex;gap:6px;align-items:center;margin-top:12px;flex-wrap:wrap}
.ptag{padding:6px 14px;border-radius:100px;font-size:12px;font-weight:700}
.pt1{background:var(--blue-bg);color:var(--blue)}.pt2{background:var(--purple-bg);color:var(--purple)}.pt3{background:var(--g7);color:var(--g3)}
.pt-a{color:var(--g4);font-size:12px}

/* KW */
.kws{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
.kw{padding:8px 16px;border:1.5px solid var(--g6);border-radius:100px;font-size:13px;font-weight:500;color:var(--g2);cursor:pointer;transition:all .2s;user-select:none;background:var(--white)}
.kw:hover{border-color:var(--g4)}.kw.on{border-color:var(--blue);background:var(--blue-bg);color:var(--blue);font-weight:600}

/* Progress */
.pw{margin:16px 0;display:none}
.ptr{width:100%;height:6px;background:var(--g6);border-radius:3px;overflow:hidden}
.pfl{height:100%;background:linear-gradient(90deg,var(--blue),var(--purple));border-radius:3px;transition:width .6s;width:0}
.ptx{text-align:center;font-size:14px;color:var(--g3);margin-top:10px;font-weight:600}

/* Tabs */
.tabs{display:flex;gap:4px;background:var(--g7);border-radius:var(--rs);padding:4px;margin-bottom:20px;overflow-x:auto}
.tab{padding:11px 16px;cursor:pointer;font-size:13px;font-weight:500;color:var(--g3);border-radius:var(--rx);white-space:nowrap;transition:all .2s;text-align:center;flex:1}
.tab:hover{color:var(--g2)}.tab.on{background:var(--white);color:var(--black);font-weight:700;box-shadow:var(--sh)}
.tc{display:none}.tc.on{display:block}

/* Report */
.rb{background:var(--g7);border-radius:var(--rs);padding:18px;margin-bottom:10px}
.rb h4{font-size:14px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.rb p{font-size:14px;color:var(--g2);line-height:1.75}
.opt{border-radius:var(--rs);padding:18px;margin:10px 0;background:var(--white);box-shadow:var(--sh);border:1px solid var(--g6);transition:all .3s}
.opt:hover{box-shadow:var(--sh2);transform:translateY(-1px)}
.oh{font-weight:700;font-size:14px;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.ob{font-size:13px;color:var(--g2);line-height:1.8;white-space:pre-wrap}
.of{display:flex;gap:12px;margin-top:10px;flex-wrap:wrap}
.of span{font-size:12px;color:var(--g3);font-weight:500}
.badge{display:inline-flex;padding:4px 10px;border-radius:100px;font-size:11px;font-weight:700}
.b-bl{background:var(--blue-bg);color:var(--blue)}.b-pu{background:var(--purple-bg);color:var(--purple)}
.b-gr{background:var(--green-bg);color:var(--green)}.b-co{background:var(--coral-bg);color:var(--coral)}
.b-or{background:var(--orange-bg);color:var(--orange)}.b-gy{background:var(--g7);color:var(--g3)}
.cg{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:600px){.cg{grid-template-columns:1fr}}
.ci{padding:16px;border-radius:var(--rs);background:var(--white);box-shadow:var(--sh);border:1px solid var(--g6)}
.ci strong{font-size:13px;display:block;margin-bottom:8px}
.ci p{font-size:12px;color:var(--g2);line-height:1.65;margin:4px 0}
.tbl{width:100%;border-collapse:separate;border-spacing:0;font-size:13px;border-radius:var(--rx);overflow:hidden;border:1px solid var(--g6)}
.tbl th{padding:10px 14px;background:var(--g7);color:var(--g2);font-weight:700;text-align:left}
.tbl td{padding:10px 14px;border-top:1px solid var(--g6);color:var(--g2)}
.tbl tr:hover td{background:var(--g7)}

/* Student list */
.sl{max-height:240px;overflow-y:auto;border-radius:var(--rx);margin-top:10px}
.si{padding:12px 4px;display:flex;justify-content:space-between;align-items:center;font-size:14px;border-bottom:1px solid var(--g6)}
.si:last-child{border:none}
.si .num{font-weight:800;color:var(--blue);margin-right:8px;font-size:13px;background:var(--blue-bg);padding:3px 8px;border-radius:6px}
.si .meta{color:var(--g3);font-size:12px;font-weight:500}

.actions{display:flex;gap:10px;flex-wrap:wrap;margin:16px 0}
.result-section{display:none}
.hidden{display:none}
@media print{body{background:#fff}.no-print{display:none!important}.card{box-shadow:none;border:1px solid #eee}}
</style>
</head>
<body>
<div class="wrap">

<!-- í™˜ê²½ ê²½ê³  -->
<div id="envWarn" style="display:none;background:var(--orange-bg);border:1.5px solid var(--orange);border-radius:var(--rs);padding:12px 16px;margin-bottom:10px;font-size:12px;color:var(--g1);line-height:1.6"></div>

<!-- í•™ê¸‰ ë°°ë„ˆ -->
<div class="class-banner" id="classBanner" style="display:none">
<div class="cb-main"><div class="cb-class" id="cbClass"></div><div class="cb-meta"><span class="cb-school" id="cbSchool"></span><span class="cb-divider">Â·</span>ë‹´ì„ <span class="cb-teacher" id="cbTeacher"></span> ì„ ìƒë‹˜</div></div>
<div class="cb-stats"><div class="cb-stat"><div class="cb-stat-num" id="cbCount">0</div><div class="cb-stat-label">ì™„ë£Œ</div></div><div class="cb-stat-sep">/</div><div class="cb-stat"><div class="cb-stat-num" id="cbTotal">30</div><div class="cb-stat-label">ì „ì²´</div></div></div>
<button class="cb-edit" onclick="toggleClassSetup()">âš™ï¸</button>
</div>
<div class="class-banner-empty" id="classBannerEmpty" style="display:none"><div style="font-size:24px">ğŸ«</div><div><strong>í•™ê¸‰ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”</strong><br><span style="font-size:12px;opacity:.7">ì•„ë˜ì—ì„œ í•™êµ, í•™ë…„, ë°˜, ë‹´ì„êµì‚¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”</span></div></div>

<div class="hdr">
<h1>ğŸ“Š ì„¸ê³µì‚¬ â€” ìƒê¸°ë¶€ ì „ëµ ë¶„ì„</h1>
<div class="hdr-badge"><span class="dot"></span>v5.2</div>
</div>

<!-- Flow Steps -->
<div class="top-scroll no-print">
<div class="t-card" style="background:linear-gradient(135deg,#E8F0FE,#D2E3FC)"><div class="t-icon"><svg width="32" height="32" viewBox="0 0 32 32" fill="none"><rect x="6" y="4" width="20" height="24" rx="3" fill="#4285F4" opacity=".15"/><rect x="8" y="6" width="16" height="20" rx="2" fill="#4285F4" opacity=".3"/><path d="M12 14h8M12 18h6" stroke="#1A73E8" stroke-width="1.5" stroke-linecap="round"/><circle cx="22" cy="24" r="5" fill="#1A73E8"/><path d="M20.5 24l1 1 2-2" stroke="#fff" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg></div><div class="t-label">PDF ì—…ë¡œë“œ</div><div class="t-sub">ìƒê¸°ë¶€ ë„£ê¸°</div></div>
<div class="t-card" style="background:linear-gradient(135deg,#F3E8FF,#E9D5FF)"><div class="t-icon"><svg width="32" height="32" viewBox="0 0 32 32" fill="none"><rect x="4" y="8" width="24" height="16" rx="4" fill="#7C3AED" opacity=".15"/><circle cx="12" cy="16" r="3" fill="#7C3AED" opacity=".4"/><circle cx="20" cy="16" r="3" fill="#7C3AED" opacity=".4"/><path d="M10 13c2-2 8-2 12 0" stroke="#7C3AED" stroke-width="1.3" stroke-linecap="round"/><path d="M10 19c2 2 8 2 12 0" stroke="#7C3AED" stroke-width="1.3" stroke-linecap="round"/></svg></div><div class="t-label">AI ë¶„ì„</div><div class="t-sub">Claude ì—°ë™</div></div>
<div class="t-card" style="background:linear-gradient(135deg,#D1FAE5,#A7F3D0)"><div class="t-icon"><svg width="32" height="32" viewBox="0 0 32 32" fill="none"><rect x="5" y="4" width="22" height="24" rx="3" fill="#059669" opacity=".2"/><path d="M10 12h12M10 16h10M10 20h8" stroke="#059669" stroke-width="1.5" stroke-linecap="round"/><path d="M22 18l-2 8h8l-2-8" fill="#059669" opacity=".3"/><circle cx="24" cy="22" r="1" fill="#059669"/></svg></div><div class="t-label">PDF ë³´ê³ ì„œ</div><div class="t-sub">ë°”ë¡œ í”„ë¦°íŠ¸</div></div>
<div class="t-card" style="background:linear-gradient(135deg,#FFF7ED,#FED7AA)"><div class="t-icon"><svg width="32" height="32" viewBox="0 0 32 32" fill="none"><rect x="4" y="6" width="24" height="20" rx="3" fill="#EA580C" opacity=".15"/><path d="M4 12h24M12 6v20M20 6v20" stroke="#EA580C" stroke-width="1.2" opacity=".3"/><rect x="13" y="14" width="6" height="4" rx="1" fill="#EA580C" opacity=".5"/></svg></div><div class="t-label">ì—‘ì…€ ì €ì¥</div><div class="t-sub">ëˆ„ì  ê´€ë¦¬</div></div>
<div class="t-card" style="background:linear-gradient(135deg,#FFF1F2,#FECDD3)"><div class="t-icon"><svg width="32" height="32" viewBox="0 0 32 32" fill="none"><path d="M6 24V10a4 4 0 014-4h12a4 4 0 014 4v8a4 4 0 01-4 4H12l-6 6v-4z" fill="#E11D48" opacity=".15"/><circle cx="12" cy="14" r="1.5" fill="#E11D48" opacity=".5"/><circle cx="16" cy="14" r="1.5" fill="#E11D48" opacity=".5"/><circle cx="20" cy="14" r="1.5" fill="#E11D48" opacity=".5"/></svg></div><div class="t-label">ìƒë‹´ ê°€ì´ë“œ</div><div class="t-sub">ì¦‰ì‹œ í™œìš©</div></div>
<div class="t-card" style="background:linear-gradient(135deg,#E0F2FE,#BAE6FD)"><div class="t-icon"><svg width="32" height="32" viewBox="0 0 32 32" fill="none"><path d="M8 26V8a2 2 0 012-2h8l6 6v14a2 2 0 01-2 2H10a2 2 0 01-2-2z" fill="#0284C7" opacity=".15"/><path d="M18 6v6h6" stroke="#0284C7" stroke-width="1.3"/><path d="M12 16l2 2 4-4" stroke="#0284C7" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 22h8" stroke="#0284C7" stroke-width="1.3" stroke-linecap="round"/></svg></div><div class="t-label">ì„¸íŠ¹ ì˜ˆì‹œ</div><div class="t-sub">1ì•ˆ / 2ì•ˆ</div></div>
</div>

<!-- 2-col grid for wide screens -->
<div class="grid2">

<!-- API -->
<div class="card no-print">
<div class="card-top"><div class="c-icon blue"><svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 2a4 4 0 014 4v2h1a3 3 0 013 3v8a3 3 0 01-3 3H7a3 3 0 01-3-3v-8a3 3 0 013-3h1V6a4 4 0 014-4zm0 2a2 2 0 00-2 2v2h4V6a2 2 0 00-2-2z" fill="#3182F6"/></svg></div><div><div class="c-title">API ì—°ê²°</div><div class="c-desc">Anthropic API Key</div></div></div>
<div class="api-row"><div class="f"><input type="password" id="apiKey" placeholder="sk-ant-..."/></div><button class="btn btn-blue btn-sm" onclick="saveKey()">ì €ì¥</button></div>
<div style="margin-top:8px"><label>ëª¨ë¸ ì„ íƒ</label><select id="modelSel" style="font-size:13px">
<option value="claude-sonnet-4-5-20250929" selected>Sonnet 4.5 (ìµœì‹ )</option>
<option value="claude-sonnet-4-20250514">Sonnet 4</option>
<option value="claude-haiku-4-5-20251001">Haiku 4.5 (ë¹ ë¦„/ì €ë ´)</option>
</select></div>
<div class="api-st" id="apiSt"></div>
</div>

<!-- PDF -->
<div class="card no-print">
<div class="card-top"><div class="c-icon coral"><svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M6 2h9l5 5v13a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2z" fill="#FF6B6B" opacity=".2"/><path d="M14 2v5h5" stroke="#FF6B6B" stroke-width="1.5"/><path d="M9 13l3 3 3-3M12 16V9" stroke="#FF6B6B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div><div><div class="c-title">ìƒê¸°ë¶€ ì—…ë¡œë“œ</div><div class="c-desc">ê°œë³„ PDF ë˜ëŠ” í´ë” ì¼ê´„</div></div></div>
<div class="dz" id="dz" onclick="document.getElementById('fi').click()">
<div class="dz-i">ğŸ“</div><div class="dz-m">PDF íŒŒì¼ ì„ íƒ (ê°œë³„)</div><div class="dz-s">1, 2í•™ë…„ ìƒê¸°ë¶€ í¬í•¨</div>
</div>
<input type="file" id="fi" class="file-input" accept=".pdf"/>
<div style="display:flex;gap:8px;margin-top:10px">
<button class="btn btn-ghost btn-sm" onclick="selectFolder()" style="flex:1;border:1.5px dashed var(--purple);color:var(--purple)">ğŸ“‚ í´ë” í†µì§¸ë¡œ ì½ê¸° (ì¼ê´„)</button>
<button class="btn btn-ghost btn-sm" onclick="selectMultiFiles()" style="flex:1;border:1.5px dashed var(--teal);color:var(--teal)">ğŸ“‘ íŒŒì¼ ì—¬ëŸ¬ê°œ ì„ íƒ</button>
</div>
<input type="file" id="fiMulti" class="file-input" accept=".pdf" multiple/>
<div id="fI" class="hidden f-info"></div>
</div>

</div>

<!-- Class Setup -->
<div class="card no-print" id="classSetupCard" style="border:2px solid var(--blue);background:linear-gradient(135deg,#FAFBFF,#F0F4FF)">
<div class="card-top"><div class="c-icon blue">ğŸ«</div><div><div class="c-title">í•™ê¸‰ ì„¤ì •</div><div class="c-desc">í•œ ë²ˆ ì„¤ì •í•˜ë©´ í•™ìƒ ë°ì´í„°ê°€ ì´ í•™ê¸‰ì— ëˆ„ì ë©ë‹ˆë‹¤</div></div></div>
<div class="row r5">
<div><label>í•™ë…„</label><select id="sGrade"><option value="3">3í•™ë…„</option></select></div>
<div><label>ë°˜</label><select id="sClass"><option value="">ì„ íƒ</option></select></div>
<div><label>ë‹´ì„êµì‚¬</label><input type="text" id="sTeacher" placeholder="í™ê¸¸ë™"/></div>
<div><label>í•™êµëª…</label><input type="text" id="sSchool" placeholder="â—‹â—‹ê³ ë“±í•™êµ"/></div>
<div><label>í•™ìƒìˆ˜</label><select id="sTotalStu"><option value="25">25ëª…</option><option value="28">28ëª…</option><option value="30" selected>30ëª…</option><option value="32">32ëª…</option><option value="33">33ëª…</option><option value="34">34ëª…</option><option value="35">35ëª…</option><option value="36">36ëª…</option><option value="40">40ëª…</option></select></div>
</div>
<div style="display:flex;gap:8px;margin-top:10px">
<button class="btn btn-blue btn-sm" onclick="saveClassInfo()">ğŸ’¾ í•™ê¸‰ ì €ì¥</button>
<button class="btn btn-ghost btn-sm" onclick="resetClass()" style="font-size:12px">ğŸ—‘ï¸ ì´ í•™ê¸‰ ë°ì´í„° ì´ˆê¸°í™”</button>
<button class="btn btn-ghost btn-sm" onclick="resetAll()" style="font-size:12px;color:var(--coral)">âš ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
</div>
<div id="classStatus" style="margin-top:8px;font-size:12px;font-weight:600"></div>
</div>

<!-- Student Info -->
<div class="card no-print">
<div class="card-top"><div class="c-icon green">ğŸ‘¤</div><div><div class="c-title">í•™ìƒ ì •ë³´</div><div class="c-desc">PDF ì—…ë¡œë“œ ì‹œ ìë™ ì¶”ì¶œ Â· ìˆ˜ì • ê°€ëŠ¥</div></div></div>
<div class="row r5">
<div><label>ë²ˆí˜¸</label><select id="sNo"><option value="">ì„ íƒ</option></select></div>
<div><label>ì´ë¦„</label><input type="text" id="sName" placeholder="í™ê¸¸ë™"/></div>
<div><label>í¬ë§ ì§„ë¡œ</label><input type="text" id="sCareer" placeholder="ê°„í˜¸ì‚¬"/></div>
<div><label>ë™ì•„ë¦¬ëª…</label><input type="text" id="sClub" placeholder="ê³¼í•™íƒêµ¬ë°˜"/></div>
</div>
<div style="margin-top:10px;padding:12px 16px;background:linear-gradient(135deg,#F8F9FA 0%,#EDF2FF 50%,#F3F0FF 100%);border-radius:12px;border:1px solid var(--g6)">
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
<span style="font-size:12px;font-weight:800;color:var(--g2)">ğŸ“Š ë‚´ì‹  ë“±ê¸‰</span>
<span id="naesinStatus" style="font-size:10px;color:var(--g4);font-weight:600">PDF ì—…ë¡œë“œ ì‹œ ìë™ ê³„ì‚°</span>
</div>
<div class="row r4" style="gap:8px">
<div style="flex:1">
<label style="font-size:10px;color:#3182F6;font-weight:700">ì „ì²´êµê³¼</label>
<input type="number" id="sNaesinAll" min="1" max="9" step="0.1" style="text-align:center;font-weight:800;font-size:16px;color:#3182F6;border:2px solid #DDE2E8;border-radius:10px;padding:10px 4px;width:100%;background:white;transition:all .2s" onfocus="this.style.borderColor='#3182F6';this.style.boxShadow='0 0 0 3px rgba(49,130,246,0.15)'" onblur="this.style.borderColor=this.value?'#3182F6':'#DDE2E8';this.style.background=this.value?'#EBF4FF':'white';this.style.boxShadow='none'"/>
</div>
<div style="flex:1">
<label style="font-size:10px;color:#7B61FF;font-weight:700">êµ­ì˜ìˆ˜ì‚¬</label>
<input type="number" id="sNaesinMSS" min="1" max="9" step="0.1" style="text-align:center;font-weight:800;font-size:16px;color:#7B61FF;border:2px solid #DDE2E8;border-radius:10px;padding:10px 4px;width:100%;background:white;transition:all .2s" onfocus="this.style.borderColor='#7B61FF';this.style.boxShadow='0 0 0 3px rgba(123,97,255,0.15)'" onblur="this.style.borderColor=this.value?'#7B61FF':'#DDE2E8';this.style.background=this.value?'#F0EDFF':'white';this.style.boxShadow='none'"/>
</div>
<div style="flex:1">
<label style="font-size:10px;color:#22B8CF;font-weight:700">êµ­ì˜ìˆ˜ê³¼</label>
<input type="number" id="sNaesinMSN" min="1" max="9" step="0.1" style="text-align:center;font-weight:800;font-size:16px;color:#22B8CF;border:2px solid #DDE2E8;border-radius:10px;padding:10px 4px;width:100%;background:white;transition:all .2s" onfocus="this.style.borderColor='#22B8CF';this.style.boxShadow='0 0 0 3px rgba(34,184,207,0.15)'" onblur="this.style.borderColor=this.value?'#22B8CF':'#DDE2E8';this.style.background=this.value?'#E3FAFC':'white';this.style.boxShadow='none'"/>
</div>
<div style="flex:1.2">
<label style="font-size:10px;color:var(--g3);font-weight:700">ë°˜ì˜ ê¸°ì¤€</label>
<select id="sNaesinType" style="width:100%;padding:10px 4px;border-radius:10px;border:2px solid var(--g5);font-size:12px;font-weight:700;background:white">
<option value="all">ì „ì²´êµê³¼</option><option value="mss">êµ­ì˜ìˆ˜ì‚¬</option><option value="msn">êµ­ì˜ìˆ˜ê³¼</option><option value="best">ìë™ ìµœìœ ë¦¬</option>
</select>
</div>
</div>
<div style="font-size:9px;color:var(--g4);margin-top:6px;text-align:right">âš ï¸ AI ìë™ ì¶”ì¶œê°’ â€” ì˜¤ì°¨ ê°€ëŠ¥, êµì‚¬ í™•ì¸ í›„ ìˆ˜ì •í•˜ì„¸ìš”</div>
</div>
<div class="row r2" style="margin-top:8px">
<div><label>í¬ë§ ëŒ€í•™</label><input type="text" id="sUniv" placeholder="í•œì–‘ëŒ€, ê²½ë¶ëŒ€ (ì„ íƒ)"/></div>
<div><label>í¬ë§ ì „ê³µ</label><input type="text" id="sMajor" placeholder="í–‰ì •í•™ê³¼, ê²½ì°°í•™ê³¼ (ì„ íƒ)"/></div>
</div>
<div style="margin-top:8px"><label>í•™ë²ˆ ë¯¸ë¦¬ë³´ê¸°</label><div class="stu-id" id="stuIdPreview">3 - -- - --</div></div>
</div>
</div>

<!-- Priority + KW side by side on wide -->
<div class="grid2">

<div class="card no-print">
<div class="card-top"><div class="c-icon purple">ğŸ¯</div><div><div class="c-title">ì „ëµ ë°©í–¥ ì„¤ì •</div><div class="c-desc">ê¸°ì¬ì˜ˆì‹œÂ·ì„¸íŠ¹Â·ìƒë‹´ ë°©í–¥ë§Œ ë³€ê²½ Â· ì ìˆ˜ì— ì˜í–¥ ì—†ìŒ</div></div></div>
<div class="presets">
<div class="pre" onclick="setP('top')" id="pTop" style="--ac:#3182F6;--abg:#EBF4FF"><span class="em">ğŸ†</span><span class="tx">í•™ì—… ì¤‘ì‹¬</span></div>
<div class="pre" onclick="setP('mid')" id="pMid" style="--ac:#7B61FF;--abg:#F0EDFF"><span class="em">ğŸ¯</span><span class="tx">ì§„ë¡œ ì¤‘ì‹¬</span></div>
<div class="pre" onclick="setP('cus')" id="pCus" style="--ac:#4E5968;--abg:#F2F4F6"><span class="em">âš™ï¸</span><span class="tx">ì§ì ‘ì„¤ì •</span></div>
</div>
<div id="cusP" class="hidden" style="margin-top:10px">
<div class="row r3">
<div><label>1ìˆœìœ„</label><select id="p1" onchange="upP()"><option>í•™ì—…</option><option>ì§„ë¡œ</option><option>ê³µë™ì²´</option></select></div>
<div><label>2ìˆœìœ„</label><select id="p2" onchange="upP()"><option>ì§„ë¡œ</option><option>í•™ì—…</option><option>ê³µë™ì²´</option></select></div>
<div><label>3ìˆœìœ„</label><select id="p3" disabled><option>ê³µë™ì²´</option></select></div>
</div>
</div>
<div class="ptags" id="ptags">
<span class="ptag pt1" id="t1">1ìˆœìœ„ í•™ì—…</span><span class="pt-a">â†’</span>
<span class="ptag pt2" id="t2">2ìˆœìœ„ ì§„ë¡œ</span><span class="pt-a">â†’</span>
<span class="ptag pt3" id="t3">3ìˆœìœ„ ê³µë™ì²´</span>
</div>
</div>

<div class="card no-print">
<div class="card-top"><div class="c-icon orange">ğŸ·ï¸</div><div><div class="c-title">í‚¤ì›Œë“œ ì„ íƒ</div><div class="c-desc">ë³´ê³ ì„œì— ë°˜ì˜í•  í‚¤ì›Œë“œ</div></div></div>
<div class="kws" id="kwG"></div>
<label style="margin-top:6px">ì§ì ‘ ì…ë ¥</label>
<input type="text" id="kwC" placeholder="ESGê²½ì˜, ë¹…ë°ì´í„° (ì‰¼í‘œ êµ¬ë¶„)"/>
</div>

</div>

<!-- Memo -->
<div class="card no-print">
<div class="card-top"><div class="c-icon teal">ğŸ’¡</div><div><div class="c-title">ìƒë‹´ ë©”ëª¨</div><div class="c-desc">ì„ íƒ Â· ì¶”ê°€ ì •ë³´</div></div></div>
<textarea id="memo" placeholder="í•™ìƒ íŠ¹ì´ì‚¬í•­, ê°•ì¡° í¬ì¸íŠ¸, ë³´ì™„í•  ì  ë“±"></textarea>
</div>

<!-- Go -->
<button class="btn btn-blue btn-full no-print" id="goBtn" onclick="analyze()" disabled style="margin-top:14px;padding:16px;font-size:16px;border-radius:var(--r)">ğŸ” AI ì¢…í•© ë¶„ì„ ì‹œì‘</button>
<button class="btn btn-ghost btn-full no-print" id="reBtn" onclick="reAnalyze()" style="display:none;margin-top:6px;padding:12px;font-size:14px;border-radius:var(--r);border:1.5px solid var(--purple);color:var(--purple)">ğŸ”„ ë¶€ë¶„ ì¬ë¶„ì„ (ê¸°ì¬ì˜ˆì‹œÂ·ì„¸íŠ¹Â·ìƒë‹´ë§Œ Â· í† í° ì ˆì•½)</button>
<div class="pw no-print" id="pW"><div class="ptr"><div class="pfl" id="pF"></div></div><div class="ptx" id="pT"></div></div>
<div id="errMsg" style="display:none;margin:10px 0;padding:14px 18px;background:#FFF0F0;border:1.5px solid #FF6B6B;border-radius:12px;color:#FF6B6B;font-size:14px;font-weight:600" class="no-print"></div>

<!-- Results -->
<div class="result-section" id="resS">
<div class="card">
<div class="tabs">
<div class="tab on" onclick="st('ov')">ğŸ“Š ì¢…í•©</div>
<div class="tab" onclick="st('jh')">ğŸ“ ììœ¨Â·ì§„ë¡œ</div>
<div class="tab" onclick="st('se')">ğŸ“˜ êµê³¼ì„¸íŠ¹</div>
<div class="tab" onclick="st('cl')">ğŸ« ë™ì•„ë¦¬</div>
<div class="tab" onclick="st('co')">ğŸ’¬ ìƒë‹´</div>
</div>
<div class="tc on" id="tc-ov"></div>
<div class="tc" id="tc-jh"></div>
<div class="tc" id="tc-se"></div>
<div class="tc" id="tc-cl"></div>
<div class="tc" id="tc-co"></div>
</div>
<!-- v4.2: êµì‚¬ ìƒë‹´ ê¸°ë¡ -->
<div class="card no-print" id="teacherNoteArea" style="display:none;margin-top:14px;background:linear-gradient(135deg,#FFFBF5,#FFF8F0);border:2px solid var(--orange)">
<div class="card-top"><div class="c-icon orange">âœï¸</div><div><div class="c-title">êµì‚¬ ìƒë‹´ ê¸°ë¡</div><div class="c-desc">í•™ìƒë³„ ìë™ì €ì¥ Â· ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹œ ë°˜ì˜</div></div></div>
<textarea id="teacherNoteInput" style="min-height:120px" placeholder="ìƒë‹´ ë‚´ìš©, ê´€ì°°ì‚¬í•­, í•™ë¶€ëª¨ ë©´ë‹´ ë‚´ìš©, ì¶”ê°€ ì§€ë„ ê³„íš ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”." oninput="saveTeacherNote()"></textarea>
<div id="tnStatus" style="font-size:11px;color:var(--green);font-weight:600;margin-top:4px;min-height:16px"></div>
</div>
<div class="actions no-print">
<button class="btn btn-green" onclick="dlPDF()" style="flex:1">ğŸ“„ ì´ í•™ìƒ PDF</button>
<button class="btn btn-purple" onclick="dlXL()" style="flex:1">ğŸ“Š ì—‘ì…€ ì €ì¥</button>
<button class="btn btn-ghost" onclick="next()" style="flex:1">â¡ï¸ ë‹¤ìŒ í•™ìƒ</button>
</div>
</div>

<!-- Student Summary -->
<div class="card no-print">
<div class="card-top"><div class="c-icon green">ğŸ“‹</div><div><div class="c-title">ë¶„ì„ ì™„ë£Œ í•™ìƒ</div><div class="c-desc" id="stuCnt">0ëª… ì™„ë£Œ</div></div></div>
<div id="batchStatus" style="display:none;margin-bottom:10px;padding:12px 16px;background:var(--blue-bg);border-radius:var(--rx);font-size:13px;color:var(--blue);font-weight:600"><span id="batchText"></span><div style="margin-top:6px;height:4px;background:var(--g6);border-radius:2px;overflow:hidden"><div id="batchBar" style="height:100%;background:var(--blue);border-radius:2px;transition:width .5s;width:0"></div></div></div>
<div class="sl" id="stuL"><div style="padding:20px;color:var(--g4);text-align:center;font-size:14px">ì•„ì§ ë¶„ì„ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</div></div>
<div class="actions" style="margin-top:12px">
<button class="btn btn-blue btn-sm" id="batchBtn" onclick="runBatch()" style="flex:1;display:none">ğŸš€ ì¼ê´„ ë¶„ì„ ì‹œì‘</button>
<button class="btn btn-purple btn-sm" onclick="dlAll()" style="flex:1">ğŸ“Š ì „ì²´ ì—‘ì…€</button>
<button class="btn btn-green btn-sm" onclick="dlAllPDF()" style="flex:1">ğŸ“„ ì „ì²´ PDF ë¬¶ìŒ</button>
</div>
<div style="font-size:11px;color:var(--g3);margin-top:8px;text-align:center">ğŸ’¡ í•™ìƒ ì´ë¦„ì„ í´ë¦­í•˜ë©´ ë³´ê³ ì„œë¥¼ ë‹¤ì‹œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
</div>

</div>

<script>
let pdf='',key='',pri=['í•™ì—…','ì§„ë¡œ','ê³µë™ì²´'],selKW=[],stu={},cur=null,classInfo={};
let batchQueue=[],isBatchRunning=false;
const KW=['ìê¸°ì£¼ë„í•™ìŠµ','ë¹„íŒì ì‚¬ê³ ','ë°ì´í„°ë¶„ì„','ë¦¬ë”ì‹­','í˜‘ì—…','ë¬¸ì œí•´ê²°','ë°œí‘œë ¥','ë´‰ì‚¬í™œë™','ìœµí•©ì‚¬ê³ ','ì°½ì˜ì„±','ì˜ì‚¬ì†Œí†µ','ê¸€ë¡œë²Œì—­ëŸ‰','ë””ì§€í„¸ë¦¬í„°ëŸ¬ì‹œ','ì—°êµ¬ì—­ëŸ‰','ì§„ë¡œíƒìƒ‰','ë©˜í† ë§','í”„ë¡œì íŠ¸ê¸°íš','ë…ì„œí™œë™'];

(function(){
// file:// í™˜ê²½ ê°ì§€ ë° worker ì„¤ì •
if(window.location.protocol==='file:'){
pdfjsLib.GlobalWorkerOptions.workerSrc='';
pdfjsLib.disableWorker=true;
const w=document.getElementById('envWarn');
w.style.display='block';
w.innerHTML='<div style="display:flex;justify-content:space-between;align-items:start"><div><strong style="color:var(--orange)">âš ï¸ ë¡œì»¬ íŒŒì¼ ëª¨ë“œ</strong> â€” file:// ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ëŒ€ë¶€ë¶„ ì •ìƒ ë™ì‘í•˜ì§€ë§Œ, ë¬¸ì œê°€ ìƒê¸°ë©´:<br>í„°ë¯¸ë„: <code style="background:#fff;padding:2px 6px;border-radius:4px">python -m http.server 8000</code> â†’ <code style="background:#fff;padding:2px 6px;border-radius:4px">localhost:8000</code></div><button onclick="this.parentElement.parentElement.style.display=\'none\'" style="background:none;border:none;cursor:pointer;font-size:18px;padding:0 0 0 12px;color:var(--g3)">âœ•</button></div>';
}else{
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
}
// ë°˜ 01~15
const sc=document.getElementById('sClass');for(let i=1;i<=15;i++){const o=document.createElement('option');o.value=String(i).padStart(2,'0');o.textContent=i+'ë°˜';sc.appendChild(o)}
// ë²ˆí˜¸ 01~40
const sn=document.getElementById('sNo');for(let i=1;i<=40;i++){const o=document.createElement('option');o.value=String(i).padStart(2,'0');o.textContent=i+'ë²ˆ';sn.appendChild(o)}
// í•™ë²ˆ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
['sGrade','sClass','sNo'].forEach(id=>document.getElementById(id).addEventListener('change',updPreview));

const g=document.getElementById('kwG');KW.forEach(k=>{const d=document.createElement('div');d.className='kw';d.textContent=k;d.onclick=()=>{d.classList.toggle('on');d.classList.contains('on')?selKW.push(k):selKW=selKW.filter(x=>x!==k)};g.appendChild(d)});
const sv=localStorage.getItem('sgb_key');if(sv){key=sv;document.getElementById('apiKey').value=sv;apiOk()}

// ë‹¤ì¤‘íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
document.getElementById('fiMulti').addEventListener('change',e=>{
if(e.target.files.length)addFilesToBatch(Array.from(e.target.files));
});

// í•™ê¸‰ ì •ë³´ ë¡œë“œ
loadClassInfo();

chk();setP('top');
})();

// === í´ë” ì¼ê´„ ì—…ë¡œë“œ (í¬ë¡¬/ì—£ì§€) ===
async function selectFolder(){
if(!window.showDirectoryPicker){alert('ğŸ“‚ í´ë” ì„ íƒì€ í¬ë¡¬/ì—£ì§€ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì§€ì›ë©ë‹ˆë‹¤.\n\nëŒ€ì‹  [íŒŒì¼ ì—¬ëŸ¬ê°œ ì„ íƒ] ë²„íŠ¼ì„ ì´ìš©í•´ì£¼ì„¸ìš”.');return}
try{
const dir=await window.showDirectoryPicker();
const files=[];
for await(const entry of dir.values()){
if(entry.kind==='file'&&entry.name.toLowerCase().endsWith('.pdf')){
const f=await entry.getFile();files.push(f);
}
}
if(!files.length){alert('í´ë”ì— PDF íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');return}
addFilesToBatch(files);
alert(`âœ… ${files.length}ê°œ PDFë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.\n\ní•™ìƒ ëª©ë¡ì—ì„œ [ğŸš€ ì¼ê´„ ë¶„ì„ ì‹œì‘]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`);
}catch(e){if(e.name!=='AbortError')console.warn(e)}
}

// === íŒŒì¼ ì—¬ëŸ¬ê°œ ì„ íƒ ===
function selectMultiFiles(){document.getElementById('fiMulti').click()}

// === íŒŒì¼ë“¤ì„ ë°°ì¹˜ íì— ì¶”ê°€ ===
async function addFilesToBatch(files){
const pdfFiles=files.filter(f=>f.type==='application/pdf'||f.name.toLowerCase().endsWith('.pdf'));
if(!pdfFiles.length){alert('PDF íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');return}
let added=0;
for(const f of pdfFiles){
try{
// PDFì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
const ab=await f.arrayBuffer();
const p=await pdfjsLib.getDocument({data:ab}).promise;
let txt='';
for(let i=1;i<=p.numPages;i++){const pg=await p.getPage(i);const tc=await pg.getTextContent();txt+=tc.items.map(x=>x.str).join(' ')+'\n'}
if(txt.length<50)continue;
// íŒŒì¼ëª…ì—ì„œ í•™ë²ˆ/ì´ë¦„ ì¶”ì¶œ ì‹œë„
let fname=f.name.replace('.pdf','').replace('.PDF','');
let sid='',sname=fname;
const m1=fname.match(/(\d{5,6})/);
if(m1)sid=m1[1];
const m2=fname.match(/([ê°€-í£]{2,4})/);
if(m2)sname=m2[1];
// ë°°ì¹˜ íì— ì¶”ê°€
batchQueue.push({fileName:f.name,text:txt,pages:p.numPages,size:f.size,sid:sid,name:sname,status:'wait'});
added++;
}catch(e){console.warn('íŒŒì¼ ì²˜ë¦¬ ì‹¤íŒ¨:',f.name,e)}
}
if(added>0){
document.getElementById('batchBtn').style.display='';
rBatch();
}
}

// === ë°°ì¹˜ í ë Œë”ë§ ===
function rBatch(){
if(!batchQueue.length)return;
const l=document.getElementById('stuL');
const existing=Object.values(stu).sort((a,b)=>a.sid.localeCompare(b.sid));
const okCount=existing.filter(s=>s.result&&!s.result._err).length;
// ê¸°ì¡´ ì™„ë£Œ í•™ìƒ + ë°°ì¹˜ ëŒ€ê¸° í•™ìƒ í•©ì³ì„œ í‘œì‹œ
let html='';
// ë°°ì¹˜ ëŒ€ê¸°ì—´ ë¨¼ì €
const waitCount=batchQueue.filter(q=>q.status==='wait').length;
if(waitCount>0){
html+=`<div style="padding:8px 12px;background:var(--purple-bg);border-radius:8px;margin-bottom:8px;font-size:12px;font-weight:700;color:var(--purple)">ğŸ“‚ ì¼ê´„ ì—…ë¡œë“œ ëŒ€ê¸°: ${batchQueue.length}ëª… (ëŒ€ê¸° ${waitCount}ëª…)</div>`;
}
batchQueue.forEach((q,i)=>{
const stClr=q.status==='wait'?'var(--g3)':q.status==='run'?'var(--blue)':q.status==='done'?'var(--green)':'var(--coral)';
const stTxt=q.status==='wait'?'ëŒ€ê¸°':q.status==='run'?'ë¶„ì„ì¤‘...':q.status==='done'?'ì™„ë£Œ':'ì˜¤ë¥˜';
const stBg=q.status==='run'?'var(--blue-bg)':q.status==='done'?'var(--green-bg)':q.status==='err'?'var(--coral-bg)':'var(--g7)';
html+=`<div class="si" style="background:${q.status==='run'?'var(--blue-bg)':'transparent'}">
<span><span style="font-size:11px;padding:3px 8px;border-radius:6px;font-weight:700;background:${stBg};color:${stClr};margin-right:8px">${stTxt}</span><strong>${q.name||q.fileName}</strong></span>
<span class="meta">${q.sid||''} Â· ${q.pages||'?'}p</span></div>`;
});
// ê¸°ì¡´ ì™„ë£Œ í•™ìƒ
existing.forEach(s=>{
const hasErr=!s.result||s.result._err;
html+=`<div class="si" style="cursor:pointer${hasErr?';opacity:.5':''}" onclick="viewStudent('${s.sid}')">
<span><span class="num">${s.sid}</span><strong>${s.name}</strong>${hasErr?'<span style="color:var(--coral);font-size:11px;margin-left:6px">âš  ì¬ë¶„ì„ í•„ìš”</span>':''}</span>
<span style="display:flex;align-items:center;gap:8px">
<span class="meta">${s.career} Â· ${s.date}</span>
${hasErr?'':'<button class="btn btn-sm" style="padding:4px 10px;font-size:11px;background:var(--green-bg);color:var(--green);border:none;border-radius:6px;cursor:pointer" onclick="event.stopPropagation();dlStudentPDF(\''+s.sid+'\')">PDF</button>'}
</span></div>`;
});
l.innerHTML=html||'<div style="padding:20px;color:var(--g4);text-align:center;font-size:14px">ì•„ì§ ë¶„ì„ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</div>';
document.getElementById('stuCnt').textContent=okCount+'ëª… ì™„ë£Œ'+(batchQueue.length?` Â· ëŒ€ê¸° ${waitCount}ëª…`:'');
document.getElementById('cbCount').textContent=okCount;
}

// === ë°°ì¹˜ ë¶„ì„ ì‹¤í–‰ ===
async function runBatch(){
if(isBatchRunning){alert('ì´ë¯¸ ë¶„ì„ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.');return}
if(!key){alert('âŒ API Keyë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”');return}
const waiting=batchQueue.filter(q=>q.status==='wait');
if(!waiting.length){alert('ëŒ€ê¸° ì¤‘ì¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');return}
isBatchRunning=true;
const btn=document.getElementById('batchBtn');
btn.textContent='â³ ë¶„ì„ ì§„í–‰ ì¤‘...';btn.disabled=true;
const bs=document.getElementById('batchStatus');bs.style.display='block';
const total=waiting.length;
let done=0;
for(let i=0;i<batchQueue.length;i++){
const q=batchQueue[i];
if(q.status!=='wait')continue;
q.status='run';rBatch();
document.getElementById('batchText').textContent=`ğŸ¤– ${q.name||q.fileName} ë¶„ì„ ì¤‘... (${done+1}/${total})`;
document.getElementById('batchBar').style.width=((done/total)*100)+'%';
try{
// í•™ìƒ ì •ë³´ ì„¤ì •
const nm=q.name||'í•™ìƒ';
const cr='ë¯¸ì •';
const cl='ë¯¸ì •';
const kw=[...selKW];const kc=document.getElementById('kwC').value.trim();if(kc)kw.push(...kc.split(',').map(s=>s.trim()).filter(Boolean));
const me='';
// v4.2: pdf ë³€ìˆ˜ë¥¼ try ì•ˆì—ì„œ êµì²´, finallyì—ì„œ ë³µì›
const origPdf=pdf;
pdf=q.text;
const prompt=bp(nm,cr,cl,kw,me);
const r=await fetch('https://api.anthropic.com/v1/messages',{
method:'POST',
headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
body:JSON.stringify({model:document.getElementById('modelSel')?.value||'claude-sonnet-4-5-20250929',max_tokens:32000,stream:true,messages:[{role:'user',content:prompt}]})
});
if(!r.ok)throw new Error('API ì˜¤ë¥˜ ('+r.status+')');
const reader=r.body.getReader();const decoder=new TextDecoder();let fullText='',buffer='';
while(true){
const{done:d,value}=await reader.read();if(d)break;
buffer+=decoder.decode(value,{stream:true});
const lines=buffer.split('\n');buffer=lines.pop()||'';
for(const line of lines){
if(!line.startsWith('data:'))continue;const data=line.substring(5).trim();
if(data==='[DONE]'||!data)continue;
try{const evt=JSON.parse(data);if(evt.type==='content_block_delta'&&evt.delta?.text)fullText+=evt.delta.text;}catch(pe){}
}
}
// íŒŒì‹±
const sid=q.sid||getStuId()||('30'+String(i+1).padStart(3,'0'));
const result=pr(fullText,nm,cr,cl,sid,kw);
// AIê°€ ì¶”ì¶œí•œ ì´ë¦„/ë‚´ì‹  ë°˜ì˜
if(!result._err&&result.student_info){
if(result.student_info.name)q.name=result.student_info.name;
if(result.student_info.career_hope)cr=result.student_info.career_hope;
}
const _bNa=result.student_info?.naesin_all||0;
const _bNm=result.student_info?.naesin_mss||0;
const _bNn=result.student_info?.naesin_msn||0;
// ë‚´ì‹  ë°˜ì˜í•˜ì—¬ ì¢…í•© í‰ì  ì¬ê³„ì‚°
if(result.overview&&result.overview._gbGpa>0&&_bNa>0){
const _bSel=Math.min(...[_bNa,_bNm,_bNn].filter(v=>v>0))||_bNa;
result.overview.gpa=calcTotalGpa(result.overview._gbGpa,_bSel);
result.overview.tier=getTier(result.overview.gpa);
result.overview.naesin=_bSel;result.overview.naesinAll=_bNa;result.overview.naesinMSS=_bNm;result.overview.naesinMSN=_bNn;
result.overview.naesinType='ìë™ìµœìœ ë¦¬';
result.overview.gpa_brief=`ìƒê¸°ë¶€ í‰ì  ${result.overview._gbGpa.toFixed(1)}, ë‚´ì‹ (ìë™ìµœìœ ë¦¬) ${_bSel.toFixed(1)}ë“±ê¸‰ ë°˜ì˜ ê¸°ë°˜. ${result.overview.tier}.`;
}
stu[sid]={name:q.name||nm,career:cr,club:cl,sid,naesin:_bNa,naesinAll:_bNa,naesinMSS:_bNm,naesinMSN:_bNn,naesinType:'best',date:new Date().toLocaleDateString('ko-KR'),result,teacherNote:''};
saveClassStudents();
q.status='done';done++;
}catch(e){
console.error('ë°°ì¹˜ ë¶„ì„ ì‹¤íŒ¨:',q.fileName,e);
q.status='err';done++;
}finally{pdf=origPdf;}
rBatch();rStu();updateBanner();
// API ì†ë„ ì¡°ì ˆ (1ì´ˆ ë”œë ˆì´)
await new Promise(r=>setTimeout(r,1000));
}
document.getElementById('batchText').textContent=`âœ… ì „ì²´ ë¶„ì„ ì™„ë£Œ! (${total}ëª…)`;
document.getElementById('batchBar').style.width='100%';
btn.textContent='ğŸš€ ì¼ê´„ ë¶„ì„ ì‹œì‘';btn.disabled=false;
isBatchRunning=false;
// ë°°ì¹˜ í ì •ë¦¬ (ì™„ë£Œëœ ê²ƒ ì œê±°)
batchQueue=batchQueue.filter(q=>q.status!=='done');
if(!batchQueue.length)btn.style.display='none';
rBatch();rStu();updateBanner();
}

function getStuId(){
const g=document.getElementById('sGrade').value;
const c=document.getElementById('sClass').value;
const n=document.getElementById('sNo').value;
if(!c||!n)return'';
return g+c+n;
}
function updPreview(){
const id=getStuId();
const g=document.getElementById('sGrade').value;
const c=document.getElementById('sClass').value;
const n=document.getElementById('sNo').value;
document.getElementById('stuIdPreview').textContent=id?id:`${g} - ${c||'--'} - ${n||'--'}`;
}

// === í•™ê¸‰ ê´€ë¦¬ ===
function getClassKey(){
const g=document.getElementById('sGrade').value;
const c=document.getElementById('sClass').value;
return `sgb_class_${g}_${c}`;
}

function saveClassInfo(){
const g=document.getElementById('sGrade').value;
const c=document.getElementById('sClass').value;
const t=document.getElementById('sTeacher').value.trim();
const s=document.getElementById('sSchool').value.trim();
if(!c){alert('ë°˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”');return}
if(!t){alert('ë‹´ì„êµì‚¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');return}
classInfo={grade:g,cls:c,teacher:t,school:s,totalStudents:parseInt(document.getElementById('sTotalStu').value)||30};
localStorage.setItem('sgb_classInfo',JSON.stringify(classInfo));
loadClassStudents();
updateBanner();
}

function updateBanner(){
const ban=document.getElementById('classBanner'),emp=document.getElementById('classBannerEmpty'),setup=document.getElementById('classSetupCard');
if(!classInfo.cls){
ban.style.display='none';emp.style.display='flex';setup.style.display='';
return;
}
ban.style.display='flex';
emp.style.display='none';
setup.style.display='none';
document.getElementById('cbSchool').textContent=classInfo.school||'í•™êµëª… ë¯¸ì„¤ì •';
document.getElementById('cbClass').textContent=`${classInfo.grade}í•™ë…„ ${parseInt(classInfo.cls)}ë°˜`;
document.getElementById('cbTeacher').textContent=classInfo.teacher||'ë¯¸ì„¤ì •';
document.getElementById('cbCount').textContent=Object.keys(stu).filter(k=>stu[k].result&&!stu[k].result._err).length;
document.getElementById('cbTotal').textContent=classInfo.totalStudents||30;
}

function toggleClassSetup(){
const c=document.getElementById('classSetupCard');
c.style.display=c.style.display==='none'?'':'none';
}

function loadClassInfo(){
try{
const ci=localStorage.getItem('sgb_classInfo');
if(ci){
classInfo=JSON.parse(ci);
document.getElementById('sGrade').value=classInfo.grade||'3';
document.getElementById('sClass').value=classInfo.cls||'';
document.getElementById('sTeacher').value=classInfo.teacher||'';
document.getElementById('sSchool').value=classInfo.school||'';
if(classInfo.totalStudents)document.getElementById('sTotalStu').value=classInfo.totalStudents;
loadClassStudents();
updateBanner();
}else{
document.getElementById('classBannerEmpty').style.display='flex';
}
}catch(e){document.getElementById('classBannerEmpty').style.display='flex'}
}

function loadClassStudents(){
const k=getClassKey();
try{
const ss=localStorage.getItem(k);
if(ss){stu=JSON.parse(ss);rStu()}else{stu={};rStu()}
}catch(e){stu={};rStu()}
}

function saveClassStudents(){
const k=getClassKey();
try{localStorage.setItem(k,JSON.stringify(stu))}catch(e){console.warn('í•™ìƒ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨')}
}

function resetClass(){
if(!confirm('ì •ë§ë¡œ ì´ í•™ê¸‰ì˜ ëª¨ë“  í•™ìƒ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)'))return;
const k=getClassKey();
localStorage.removeItem(k);
stu={};cur=null;rStu();updateBanner();
document.getElementById('classStatus').innerHTML='<span style="color:var(--coral)">âœ“ í•™ê¸‰ ë°ì´í„° ì´ˆê¸°í™”ë¨</span>';
}

function resetAll(){
if(!confirm('âš ï¸ ëª¨ë“  ë°ì´í„°(í•™ê¸‰ì •ë³´, APIí‚¤, ì „ì²´ í•™ìƒ ë¶„ì„ê²°ê³¼)ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.\n\nì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
// sgb_ ì ‘ë‘ì‚¬ í‚¤ ì „ë¶€ ì‚­ì œ
const keys=[];
for(let i=0;i<localStorage.length;i++){
const k=localStorage.key(i);
if(k&&k.startsWith('sgb_'))keys.push(k);
}
keys.forEach(k=>localStorage.removeItem(k));
// ìƒíƒœ ì´ˆê¸°í™”
key='';pdf='';stu={};cur=null;classInfo={};
location.reload();
}

// === v4.2: êµì‚¬ ìƒë‹´ ê¸°ë¡ ì €ì¥/ë¡œë“œ ===
let _tnTimer=null;
function saveTeacherNote(){
clearTimeout(_tnTimer);
_tnTimer=setTimeout(()=>{
const sid=getStuId();
if(sid&&stu[sid]){
stu[sid].teacherNote=document.getElementById('teacherNoteInput').value;
saveClassStudents();
document.getElementById('tnStatus').textContent='âœ“ ìë™ ì €ì¥ë¨ ('+new Date().toLocaleTimeString('ko-KR')+')';
}
},500);
}
function loadTeacherNote(sid){
const ta=document.getElementById('teacherNoteInput');
const area=document.getElementById('teacherNoteArea');
if(!ta||!area)return;
if(stu[sid]){
ta.value=stu[sid].teacherNote||'';
area.style.display='';
document.getElementById('tnStatus').textContent='';
}else{
ta.value='';
area.style.display='none';
}
}

// === í•™ìƒ í´ë¦­ â†’ ë³´ê³ ì„œ ì¬ì—´ëŒ ===
function viewStudent(sid){
const s=stu[sid];
if(!s||!s.result)return;
// êµ¬ ë²„ì „ ë°ì´í„°ê°€ _errì¸ ê²½ìš° ìƒˆ íŒŒì„œë¡œ ì¬íŒŒì‹± ì‹œë„
if(s.result._err&&s.result._raw){
const reparsed=pr(s.result._raw,s.name||'',s.career||'',s.club||'',sid,[]);
if(!reparsed._err){
s.result=reparsed;
saveClassStudents();
rStu();updateBanner();
}
}
cur=s.result;
// í•™ìƒ ì •ë³´ ì±„ìš°ê¸°
document.getElementById('sNo').value=sid.substring(3,5);
document.getElementById('sName').value=s.name||'';
document.getElementById('sCareer').value=s.career||'';
document.getElementById('sClub').value=s.club||'';
// v5.0 ë‚´ì‹  3ì¹¸ ë¡œë“œ (êµ¬ ë²„ì „ í˜¸í™˜: naesinë§Œ ìˆìœ¼ë©´ ì „ì²´êµê³¼ì— ë„£ê¸°)
if(s.naesinAll||s.naesinMSS||s.naesinMSN){
document.getElementById('sNaesinAll').value=s.naesinAll||'';
document.getElementById('sNaesinMSS').value=s.naesinMSS||'';
document.getElementById('sNaesinMSN').value=s.naesinMSN||'';
document.getElementById('sNaesinType').value=s.naesinType||'all';
}else if(s.naesin){
document.getElementById('sNaesinAll').value=s.naesin;
document.getElementById('sNaesinMSS').value='';
document.getElementById('sNaesinMSN').value='';
document.getElementById('sNaesinType').value='all';
}
document.getElementById('sUniv').value=s.univ||'';
document.getElementById('sMajor').value=s.major||'';
updPreview();
// ê²°ê³¼ í‘œì‹œ ì „ì— ì ìˆ˜ ì¬ê³„ì‚° (ì´ì „ ë²„ì „ ìºì‹œ í˜¸í™˜)
injectScores(cur);
// ë‚´ì‹  ë°˜ì˜ ì¬ê³„ì‚°
const _nd=getNaesinData();
if(cur.overview&&cur.overview._gbGpa>0&&_nd.selected>0){
cur.overview.gpa=calcTotalGpa(cur.overview._gbGpa,_nd.selected);
cur.overview.tier=getTier(cur.overview.gpa);
cur.overview.naesin=_nd.selected;
cur.overview.naesinType=_nd.typeLabel;
}
rR(cur);
// v4.2: êµì‚¬ ë©”ëª¨ ë¡œë“œ
loadTeacherNote(sid);
// ìŠ¤í¬ë¡¤
document.getElementById('resS').scrollIntoView({behavior:'smooth'});
}

// === ê°œë³„ í•™ìƒ PDF (í•™ìƒ ëª©ë¡ì—ì„œ) ===
function dlStudentPDF(sid){
const s=stu[sid];
if(!s||!s.result||s.result._err)return;
const prevCur=cur;
cur=s.result;
dlPDF();
cur=prevCur;
}

// === ì „ì²´ í•™ìƒ PDF ë¬¶ìŒ ===
function dlAllPDF(){
const students=Object.values(stu).filter(s=>s.result&&!s.result._err).sort((a,b)=>a.sid.localeCompare(b.sid));
if(!students.length){alert('ë¶„ì„ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤');return}
if(students.length>=10&&!confirm(`${students.length}ëª… ë³´ê³ ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.\në¸Œë¼ìš°ì €ê°€ ëŠë ¤ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê³„ì†?`))return;
const prevCur=cur;
const w=window.open('','_blank');
let allHtml='';
students.forEach((s,i)=>{
cur=s.result;
const m=cur._m;
allHtml+=buildPDFContent(cur);
if(i<students.length-1)allHtml+='<div style="page-break-after:always"></div>';
});
cur=prevCur;
const ci=classInfo;
w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${ci.school||''} ${ci.grade||'3'}í•™ë…„ ${parseInt(ci.cls)||''}ë°˜ ìƒê¸°ë¶€ ì „ì²´ ë³´ê³ ì„œ</title>
${getPDFStyles()}
</head><body>
<div class="cover"><h1>ğŸ“Š ìƒê¸°ë¶€ ì „ëµ ë¶„ì„ ë³´ê³ ì„œ</h1>
<div class="sub">${ci.school||''} ${ci.grade||'3'}í•™ë…„ ${parseInt(ci.cls)||''}ë°˜ Â· ë‹´ì„: ${ci.teacher||''} Â· ${students.length}ëª…</div></div>
<div style="page-break-after:always"></div>
${allHtml}
</body></html>`);
w.document.close();setTimeout(()=>w.print(),1000);
}

function saveKey(){
key=document.getElementById('apiKey').value.trim();
if(!key){document.getElementById('apiSt').innerHTML='<span class="api-no">í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</span>';return}
if(!key.startsWith('sk-ant-')){document.getElementById('apiSt').innerHTML='<span class="api-no">âš ï¸ sk-ant-ë¡œ ì‹œì‘í•˜ëŠ” í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</span>';return}
localStorage.setItem('sgb_key',key);apiOk();chk();
console.log('[saveKey] í‚¤ ì €ì¥ ì™„ë£Œ, ê¸¸ì´:',key.length);
}
function apiOk(){document.getElementById('apiSt').innerHTML='<span class="api-ok">âœ“ ì €ì¥ ì™„ë£Œ</span>'}

const dz=document.getElementById('dz'),fi=document.getElementById('fi');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag')});
dz.addEventListener('dragleave',()=>dz.classList.remove('drag'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('drag');e.dataTransfer.files[0]&&hf(e.dataTransfer.files[0])});
fi.addEventListener('change',e=>e.target.files[0]&&hf(e.target.files[0]));

async function hf(f){
if(f.type!=='application/pdf'){alert('PDFë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤');return}
dz.classList.add('done');dz.querySelector('.dz-i').textContent='âœ…';
dz.querySelector('.dz-m').textContent=f.name;dz.querySelector('.dz-s').textContent='ì¶”ì¶œ ì¤‘...';
try{const b=await f.arrayBuffer();const p=await pdfjsLib.getDocument({data:b}).promise;let t='';
for(let i=1;i<=p.numPages;i++){const pg=await p.getPage(i);const tc=await pg.getTextContent();t+=tc.items.map(x=>x.str).join(' ')+'\n'}
pdf=t;
console.log('[PDF] í…ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ, ê¸¸ì´:',pdf.length);
if(pdf.length<50){dz.querySelector('.dz-s').textContent='âš ï¸ í…ìŠ¤íŠ¸ê°€ ê±°ì˜ ì¶”ì¶œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìŠ¤ìº” PDFì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤';return}
dz.querySelector('.dz-s').textContent=`${p.numPages}p Â· ${pdf.length.toLocaleString()}ì`;
// í•™ìƒ ì •ë³´ ìë™ ì¶”ì¶œ
autoFillStudent(t);
document.getElementById('fI').classList.remove('hidden');
document.getElementById('fI').textContent=`âœ“ ${f.name} Â· ${(f.size/1024).toFixed(0)}KB Â· ${p.numPages}í˜ì´ì§€`;chk()
}catch(e){dz.querySelector('.dz-s').textContent='âœ• '+e.message}}

function setP(t){document.querySelectorAll('.pre').forEach(b=>{b.classList.remove('on');b.style.borderColor='var(--g6)';b.style.background='var(--white)';b.querySelector('.tx').style.color='var(--g2)'});document.getElementById('cusP').classList.add('hidden');
if(t==='top'){pri=['í•™ì—…','ì§„ë¡œ','ê³µë™ì²´'];const el=document.getElementById('pTop');el.classList.add('on');el.style.borderColor='#3182F6';el.style.background='#EBF4FF';el.querySelector('.tx').style.color='#3182F6'}
else if(t==='mid'){pri=['ì§„ë¡œ','í•™ì—…','ê³µë™ì²´'];const el=document.getElementById('pMid');el.classList.add('on');el.style.borderColor='#7B61FF';el.style.background='#F0EDFF';el.querySelector('.tx').style.color='#7B61FF'}
else{const el=document.getElementById('pCus');el.classList.add('on');el.style.borderColor='#4E5968';el.style.background='#F2F4F6';el.querySelector('.tx').style.color='#4E5968';document.getElementById('cusP').classList.remove('hidden');upP()}rPr()}
function upP(){const a=document.getElementById('p1').value,b=document.getElementById('p2').value,c=['í•™ì—…','ì§„ë¡œ','ê³µë™ì²´'].find(x=>x!==a&&x!==b)||'ê³µë™ì²´';document.getElementById('p3').innerHTML=`<option>${c}</option>`;pri=[a,b,c];rPr()}
function rPr(){document.getElementById('t1').textContent='1ìˆœìœ„ '+pri[0];document.getElementById('t2').textContent='2ìˆœìœ„ '+pri[1];document.getElementById('t3').textContent='3ìˆœìœ„ '+pri[2]}
function chk(){
const ready=!!(key&&pdf);
const btn=document.getElementById('goBtn');
btn.disabled=!ready;
if(!ready){
let msg=[];
if(!key)msg.push('API Key í•„ìš”');
if(!pdf)msg.push('PDF ì—…ë¡œë“œ í•„ìš”');
btn.textContent='âš ï¸ '+msg.join(' + ');
}else{
btn.textContent='ğŸ” AI ì¢…í•© ë¶„ì„ ì‹œì‘';
}
}

async function analyze(){
let sid=getStuId()||'30101';
let nm=document.getElementById('sName').value.trim()||'í•™ìƒ';
let cr=document.getElementById('sCareer').value.trim()||'ë¯¸ì •';
let cl=document.getElementById('sClub').value.trim()||'ë¯¸ì •';
const me=document.getElementById('memo').value.trim();
const kw=[...selKW];const kc=document.getElementById('kwC').value.trim();if(kc)kw.push(...kc.split(',').map(s=>s.trim()).filter(Boolean));

if(!key){alert('âŒ API Keyë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”');return}
if(!pdf){alert('âŒ PDFë¥¼ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”');return}

document.getElementById('pW').style.display='block';document.getElementById('goBtn').disabled=true;
document.getElementById('errMsg').style.display='none';
showStatus('ğŸ“„ PDF ë¶„ì„ ì¤‘...',10);

try{
showStatus('ğŸ¤– AI ì‹¬ì¸µ ë¶„ì„ ì¤‘... (1~3ë¶„ ì†Œìš”)',30);

const body={model:document.getElementById('modelSel')?.value||'claude-sonnet-4-5-20250929',max_tokens:32000,stream:true,messages:[{role:'user',content:bp(nm,cr,cl,kw,me)}]};

const r=await fetch('https://api.anthropic.com/v1/messages',{
method:'POST',
headers:{
'Content-Type':'application/json',
'x-api-key':key,
'anthropic-version':'2023-06-01',
'anthropic-dangerous-direct-browser-access':'true'
},
body:JSON.stringify(body)
});

if(!r.ok){
let errMsg='API ì˜¤ë¥˜ ('+r.status+')';
try{const e=await r.json();errMsg=e.error?.message||errMsg}catch(ex){}
throw new Error(errMsg);
}

// ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬
showStatus('ğŸ¤– AI ë¶„ì„ ì¤‘... 0ì ìˆ˜ì‹ ',35);
const reader=r.body.getReader();
const decoder=new TextDecoder();
let fullText='';
let buffer='';
let stopReason='';

while(true){
const{done,value}=await reader.read();
if(done)break;
buffer+=decoder.decode(value,{stream:true});

const lines=buffer.split('\n');
buffer=lines.pop()||'';

for(const line of lines){
if(!line.startsWith('data:'))continue;
const data=line.substring(5).trim();
if(data==='[DONE]'||!data)continue;
try{
const evt=JSON.parse(data);
if(evt.type==='content_block_delta'&&evt.delta?.text){
fullText+=evt.delta.text;
const pct=Math.min(35+Math.floor((fullText.length/10000)*55),90);
showStatus(`ğŸ¤– AI ë¶„ì„ ì¤‘... ${fullText.length.toLocaleString()}ì ìˆ˜ì‹ `,pct);
}
if(evt.type==='message_delta'&&evt.delta?.stop_reason){
stopReason=evt.delta.stop_reason;
}
}catch(pe){}
}
}

const tx=fullText;
if(stopReason==='max_tokens'){
showStatus('âš ï¸ AI ì‘ë‹µì´ ê¸¸ì´ ì œí•œìœ¼ë¡œ ì˜ë ¸ìŠµë‹ˆë‹¤. ë¶ˆì™„ì „í•œ ê²°ê³¼ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',92);
}else{
showStatus('ğŸ“‹ ë³´ê³ ì„œ ìƒì„± ì¤‘...',90);
}
cur=pr(tx,nm,cr,cl,sid,kw);

// v5.0: ë‚´ì‹  ë°˜ì˜í•˜ì—¬ ì¢…í•© í‰ì  ê³„ì‚°
if(cur&&!cur._err&&cur.overview){
const nd=getNaesinData();
const gbGpa=cur.overview._gbGpa||0;
if(gbGpa>0){
cur.overview.gpa_gb=gbGpa;
cur.overview.gpa=calcTotalGpa(gbGpa,nd.selected);
cur.overview.tier=getTier(cur.overview.gpa);
cur.overview.naesin=nd.selected;
cur.overview.naesinType=nd.typeLabel;
cur.overview.naesinAll=nd.all;
cur.overview.naesinMSS=nd.mss;
cur.overview.naesinMSN=nd.msn;
if(!cur.overview.gpa_brief||cur.overview.gpa_brief===''){
cur.overview.gpa_brief=`ìƒê¸°ë¶€ í‰ì  ${gbGpa.toFixed(1)}${nd.selected>0?', ë‚´ì‹ ('+nd.typeLabel+') '+nd.selected.toFixed(1)+'ë“±ê¸‰ ë°˜ì˜':''} ê¸°ë°˜. ${cur.overview.tier}.`;
}
}
}

// AIê°€ ì¶”ì¶œí•œ í•™ìƒ ì •ë³´ë¡œ ë¹ˆ í•„ë“œ ì±„ìš°ê¸°
if(!cur._err&&cur.student_info){
const si=cur.student_info;
if(si.name&&!document.getElementById('sName').value)document.getElementById('sName').value=si.name;
if(si.class_num&&!document.getElementById('sClass').value){
document.getElementById('sClass').value=String(parseInt(si.class_num)).padStart(2,'0');
}
if(si.student_num&&!document.getElementById('sNo').value){
document.getElementById('sNo').value=String(parseInt(si.student_num)).padStart(2,'0');
}
if(si.career_hope&&!document.getElementById('sCareer').value)document.getElementById('sCareer').value=si.career_hope;
// v5.0: AIê°€ ê³„ì‚°í•œ ë‚´ì‹  3ì¢… ìë™ ì±„ìš°ê¸° (ë¹ˆ ì¹¸ë§Œ)
if(si.naesin_all&&si.naesin_all>0&&!document.getElementById('sNaesinAll').value){
document.getElementById('sNaesinAll').value=si.naesin_all;
const el=document.getElementById('sNaesinAll');el.style.borderColor='#3182F6';el.style.background='#EBF4FF';
}
if(si.naesin_mss&&si.naesin_mss>0&&!document.getElementById('sNaesinMSS').value){
document.getElementById('sNaesinMSS').value=si.naesin_mss;
const el=document.getElementById('sNaesinMSS');el.style.borderColor='#7B61FF';el.style.background='#F0EDFF';
}
if(si.naesin_msn&&si.naesin_msn>0&&!document.getElementById('sNaesinMSN').value){
document.getElementById('sNaesinMSN').value=si.naesin_msn;
const el=document.getElementById('sNaesinMSN');el.style.borderColor='#22B8CF';el.style.background='#E3FAFC';
}
// AI ë¶„ì„ìœ¼ë¡œ ë‚´ì‹ ì´ ì±„ì›Œì¡Œìœ¼ë©´ ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
const hasAnyNaesin=document.getElementById('sNaesinAll').value||document.getElementById('sNaesinMSS').value||document.getElementById('sNaesinMSN').value;
if(hasAnyNaesin){
const nStat=document.getElementById('naesinStatus');
if(nStat){nStat.textContent='âœ… AI ë¶„ì„ìœ¼ë¡œ ì¶”ì¶œ ì™„ë£Œ (êµì‚¬ í™•ì¸ í•„ìš”)';nStat.style.color='#22B8CF';}
}
updPreview();
nm=document.getElementById('sName').value||nm;
cr=document.getElementById('sCareer').value||cr;
cl=document.getElementById('sClub').value||cl;
sid=getStuId()||sid;
if(cur._m){cur._m.nm=nm;cur._m.cr=cr;cur._m.cl=cl;cur._m.sid=sid;}
}

// v5.0: ë‚´ì‹  ìë™ì±„ìš°ê¸° í›„ ì¢…í•© í‰ì  ì¬ê³„ì‚°
if(cur&&!cur._err&&cur.overview){
const nd2=getNaesinData();
const gbGpa2=cur.overview._gbGpa||cur.overview.gpa_gb||0;
if(gbGpa2>0){
cur.overview.gpa_gb=gbGpa2;
cur.overview.gpa=calcTotalGpa(gbGpa2,nd2.selected);
cur.overview.tier=getTier(cur.overview.gpa);
cur.overview.naesin=nd2.selected;
cur.overview.naesinType=nd2.typeLabel;
cur.overview.naesinAll=nd2.all;
cur.overview.naesinMSS=nd2.mss;
cur.overview.naesinMSN=nd2.msn;
cur.overview.gpa_brief=`ìƒê¸°ë¶€ í‰ì  ${gbGpa2.toFixed(1)}${nd2.selected>0?', ë‚´ì‹ ('+nd2.typeLabel+') '+nd2.selected.toFixed(1)+'ë“±ê¸‰ ë°˜ì˜':''} ê¸°ë°˜. ${cur.overview.tier}.`;
}
}

const _nd=getNaesinData();
const _univ=document.getElementById('sUniv')?.value||'';
const _major=document.getElementById('sMajor')?.value||'';
stu[sid]={name:nm,career:cr,club:cl,sid,univ:_univ,major:_major,naesin:_nd.selected,naesinAll:_nd.all,naesinMSS:_nd.mss,naesinMSN:_nd.msn,naesinType:_nd.type,date:new Date().toLocaleDateString('ko-KR'),result:cur,teacherNote:(stu[sid]&&stu[sid].teacherNote)||''};
saveClassStudents();
rR(cur);rStu();updateBanner();loadTeacherNote(sid);showStatus('âœ… ë¶„ì„ ì™„ë£Œ!',100);
document.getElementById('reBtn').style.display='';
setTimeout(()=>{document.getElementById('pW').style.display='none';document.getElementById('goBtn').disabled=false;document.getElementById('goBtn').textContent='ğŸ” AI ì¢…í•© ë¶„ì„ ì‹œì‘'},1500);

}catch(e){
showStatus('âŒ ì˜¤ë¥˜: '+e.message,0);
const errDiv=document.getElementById('errMsg');
if(errDiv){errDiv.textContent='âš ï¸ '+e.message;errDiv.style.display='block'}
document.getElementById('goBtn').disabled=false;
document.getElementById('goBtn').textContent='ğŸ” AI ì¢…í•© ë¶„ì„ ì‹œì‘ (ì¬ì‹œë„)';
}}
function showStatus(t,p){document.getElementById('pF').style.width=p+'%';document.getElementById('pT').textContent=t;console.log('[status]',p+'%',t)}
// spëŠ” showStatusë¡œ ëŒ€ì²´ë¨

// === v5.0: ë¶€ë¶„ ì¬ë¶„ì„ (ê¸°ì¬ì˜ˆì‹œÂ·ì„¸íŠ¹ì¶”ì²œÂ·ìƒë‹´ë§Œ, ì ìˆ˜/rating_matrix ìœ ì§€) ===
async function reAnalyze(){
if(!cur||cur._err){alert('ë¨¼ì € ì „ì²´ ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');return}
if(!pdf){alert('PDFê°€ ì—†ìŠµë‹ˆë‹¤. ì „ì²´ ë¶„ì„ì„ ë‹¤ì‹œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');return}
const nm=document.getElementById('sName').value||'í•™ìƒ';
const cr=document.getElementById('sCareer').value||'ë¯¸ì •';
const cl=document.getElementById('sClub').value||'';
const sid=getStuId();
const kw=getKW();
const me=document.getElementById('memo').value;
const nd=getNaesinData();

// ê¸°ì¡´ ê²°ê³¼ì—ì„œ ë³´ì¡´í•  ë°ì´í„°
const keepRM=JSON.stringify(cur.rating_matrix||{});
const keepOv=JSON.stringify({summary:cur.overview?.summary,change_analysis:cur.overview?.change_analysis,scores:cur.overview?.scores,_gbGpa:cur.overview?._gbGpa,gpa_gb:cur.overview?.gpa_gb,competencies:cur.overview?.competencies,keywords:cur.overview?.keywords});

const rePrompt=`ë‹¹ì‹ ì€ ëŒ€í•œë¯¼êµ­ ê³ ë“±í•™êµ ìƒê¸°ë¶€ ì „ë¬¸ ë¶„ì„ê°€ì…ë‹ˆë‹¤.
ì´ë¯¸ 1ì°¨ ë¶„ì„ì´ ì™„ë£Œëœ í•™ìƒì˜ ë³´ê³ ì„œë¥¼ **ì „ëµ ë°©í–¥ ë³€ê²½**ì— ë”°ë¼ ë¶€ë¶„ ì¬ìƒì„±í•©ë‹ˆë‹¤.

[í•™ìƒ ì •ë³´]
- ì´ë¦„: ${nm} | ì§„ë¡œ: ${cr} | ë™ì•„ë¦¬: ${cl}
- í‚¤ì›Œë“œ: ${kw.join(', ')||'ë¯¸ì§€ì •'}
${me?'- ë©”ëª¨: '+me:''}
- ì „ëµ ì´ˆì : ${pri[0]} ì¤‘ì‹¬

[âš ï¸ ìœ ì§€í•  ë°ì´í„° â€” ì ˆëŒ€ ë³€ê²½í•˜ì§€ ë§ˆì„¸ìš”]
rating_matrix: ${keepRM}
overview í•µì‹¬: ${keepOv}

[ì¬ìƒì„± ëŒ€ìƒë§Œ JSONìœ¼ë¡œ ì¶œë ¥]
1. jarhaeng: ììœ¨/ì§„ë¡œ/ë™ì•„ë¦¬/í–‰ë°œ ê¸°ì¬ì˜ˆì‹œ (option1 ì•ˆì „í˜•, option2 ë„ì „í˜•)
   - ì „ëµ ì´ˆì (${pri[0]})ì— ë§ì¶° ê¸°ì¬ì˜ˆì‹œ ì¬ì‘ì„±
   - ë“±ê¸‰(grade)ê³¼ evaluationì€ ìœ ì§€, option1/option2ì˜ text/focus/supplementë§Œ ì¬ì‘ì„±
   - ë°”ì´íŠ¸ ì œí•œ: ììœ¨1500B, ì§„ë¡œ2100B, ë™ì•„ë¦¬1500B, í–‰ë°œ1500B
   - âš ï¸ ë¯¸ë˜í˜•/ê°€ì •ë²• í†¤ í•„ìˆ˜! ì™„ë£Œí˜• ê¸ˆì§€!
2. setuk: ì„¸íŠ¹ ë°©í–¥ (direction + subjects 3~4ê°œ)
3. counsel: ìƒë‹´ ê°€ì´ë“œ (points 3ê°œ, questions 3ê°œ, parent 2ê°œ)

[ìƒê¸°ë¶€ ì›ë¬¸]
${pdf.length>30000?pdf.substring(0,30000)+'\n[âš  ì›ë¬¸ ì¼ë¶€ ìƒëµ]':pdf}

[í•„ìˆ˜ ê·œì¹™]
- JSONë§Œ ì¶œë ¥
- jarhaeng, setuk, counsel 3ê°œ ì„¹ì…˜ë§Œ ì¶œë ¥
- ë‹¤ë¥¸ ì„¹ì…˜(student_info, rating_matrix, overview, subject_analysis, club) ì¶œë ¥ ê¸ˆì§€

{"jarhaeng":{...},"setuk":{...},"counsel":{...}}`;

document.getElementById('reBtn').disabled=true;
document.getElementById('reBtn').textContent='ğŸ”„ ì¬ë¶„ì„ ì¤‘...';
document.getElementById('pW').style.display='';
showStatus('ğŸ”„ ë¶€ë¶„ ì¬ë¶„ì„ ì¤‘... (ê¸°ì¬ì˜ˆì‹œÂ·ì„¸íŠ¹Â·ìƒë‹´)',10);

try{
const apiKey=document.getElementById('apiKey').value;
const body={model:document.getElementById('modelSel')?.value||'claude-sonnet-4-5-20250929',max_tokens:16000,stream:true,messages:[{role:'user',content:rePrompt}]};
const resp=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify(body)});
const reader=resp.body.getReader();const dec=new TextDecoder();let tx='';
while(true){
const{done,value}=await reader.read();
if(done)break;
const chunk=dec.decode(value,{stream:true});
const lines=chunk.split('\n');
for(const line of lines){
if(!line.startsWith('data: '))continue;
try{
const d=JSON.parse(line.slice(6));
if(d.type==='content_block_delta'&&d.delta?.text){tx+=d.delta.text;showStatus(`ğŸ”„ ì¬ë¶„ì„ ì¤‘... (${tx.length}ì)`,30+Math.min(tx.length/5000*50,50))}
}catch(e){}
}
}
showStatus('ğŸ“‹ ê²°ê³¼ ë³‘í•© ì¤‘...',85);

// ë¶€ë¶„ ê²°ê³¼ íŒŒì‹±
let partial;
try{
let cleaned=tx.replace(/```json\s*/gi,'').replace(/```\s*/gi,'').trim();
const s=cleaned.indexOf('{'),e=cleaned.lastIndexOf('}');
if(s>=0&&e>s)cleaned=cleaned.substring(s,e+1);
partial=JSON.parse(cleaned);
}catch(pe){
showStatus('âŒ ì¬ë¶„ì„ íŒŒì‹± ì‹¤íŒ¨',0);
document.getElementById('reBtn').disabled=false;
document.getElementById('reBtn').textContent='ğŸ”„ ë¶€ë¶„ ì¬ë¶„ì„ (ê¸°ì¬ì˜ˆì‹œÂ·ì„¸íŠ¹Â·ìƒë‹´ë§Œ Â· í† í° ì ˆì•½)';
return;
}

// ê¸°ì¡´ ê²°ê³¼ì— ë³‘í•©
if(partial.jarhaeng)cur.jarhaeng=partial.jarhaeng;
if(partial.setuk)cur.setuk=partial.setuk;
if(partial.counsel)cur.counsel=partial.counsel;

// ë‚´ì‹  ì¬ê³„ì‚° (ë‚´ì‹  ê¸°ì¤€ì´ ë°”ë€Œì—ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
if(cur.overview&&cur.overview._gbGpa>0){
cur.overview.gpa=calcTotalGpa(cur.overview._gbGpa,nd.selected);
cur.overview.tier=getTier(cur.overview.gpa);
cur.overview.naesin=nd.selected;
cur.overview.naesinType=nd.typeLabel;
cur.overview.naesinAll=nd.all;
cur.overview.naesinMSS=nd.mss;
cur.overview.naesinMSN=nd.msn;
cur.overview.gpa_brief=`ìƒê¸°ë¶€ í‰ì  ${cur.overview._gbGpa.toFixed(1)}${nd.selected>0?', ë‚´ì‹ ('+nd.typeLabel+') '+nd.selected.toFixed(1)+'ë“±ê¸‰ ë°˜ì˜':''} ê¸°ë°˜. ${cur.overview.tier}.`;
}

// ì €ì¥ ë° ë Œë”ë§
const _nd2=getNaesinData();
stu[sid]={...stu[sid],result:cur,naesin:_nd2.selected,naesinAll:_nd2.all,naesinMSS:_nd2.mss,naesinMSN:_nd2.msn,naesinType:_nd2.type,date:new Date().toLocaleDateString('ko-KR')};
saveClassStudents();
rR(cur);showStatus('âœ… ë¶€ë¶„ ì¬ë¶„ì„ ì™„ë£Œ!',100);
setTimeout(()=>{document.getElementById('pW').style.display='none'},1500);
}catch(e){showStatus('âŒ ì˜¤ë¥˜: '+e.message,0)}
document.getElementById('reBtn').disabled=false;
document.getElementById('reBtn').textContent='ğŸ”„ ë¶€ë¶„ ì¬ë¶„ì„ (ê¸°ì¬ì˜ˆì‹œÂ·ì„¸íŠ¹Â·ìƒë‹´ë§Œ Â· í† í° ì ˆì•½)';
}

// PDFì—ì„œ í•™ìƒ ì •ë³´ ìë™ ì¶”ì¶œ (ì´ë¦„, í•™ë²ˆë§Œ â€” ì§„ë¡œ/ë™ì•„ë¦¬ëŠ” ì˜¤íƒ ë§ì•„ì„œ AIì—ê²Œ ë§¡ê¹€)
function autoFillStudent(txt){
try{
// === ì´ë¦„ ì¶”ì¶œ ===
const namePatterns=[
/ì„±\s*ëª…\s*[:\s]*([ê°€-í£]{2,4})/,
/ì´\s*ë¦„\s*[:\s]*([ê°€-í£]{2,4})/,
/([ê°€-í£]{2,4})\s*í•™ìƒì˜?\s*(ì„±ì¥|í•™êµìƒí™œ|ìƒê¸°ë¶€)/,
/í•™\s*ì \s*ì‚¬\s*í•­[^ê°€-í£]*([ê°€-í£]{2,4})/,
/\d{5,6}\s*([ê°€-í£]{2,4})/,
/\d{1,2}\s*ë°˜\s*\d{1,2}\s*ë²ˆ?\s*([ê°€-í£]{2,4})/,
];
let foundName='';
for(const p of namePatterns){
const m=txt.match(p);
if(m&&m[1]&&m[1].length>=2&&m[1].length<=4){foundName=m[1];break}
}
if(foundName&&!document.getElementById('sName').value)document.getElementById('sName').value=foundName;

// === í•™ë…„ë°˜ë²ˆí˜¸ ì¶”ì¶œ ===
const gradePatterns=[
/(\d)\s*í•™\s*ë…„\s*(\d{1,2})\s*ë°˜\s*(\d{1,2})\s*ë²ˆ/,
/(\d)-(\d{1,2})-(\d{1,2})/,
/(\d)í•™ë…„\s*(\d{1,2})ë°˜\s*(\d{1,2})ë²ˆ/,
];
let fg='',fc='',fn='';
for(const p of gradePatterns){
const m=txt.match(p);
if(m){fg=m[1];fc=m[2];fn=m[3];break}
}
if(!fc){
const m=txt.match(/(\d)(\d{2})(\d{2})\s*[ê°€-í£]{2,4}/);
if(m){
const parsedClass=parseInt(m[2]);
const parsedNo=parseInt(m[3]);
// ë°˜ì´ 1~15, ë²ˆí˜¸ê°€ 1~40 ë²”ìœ„ì¼ ë•Œë§Œ ìœ íš¨
if(parsedClass>=1&&parsedClass<=15&&parsedNo>=1&&parsedNo<=40){
fg=m[1];fc=m[2];fn=m[3];
}
}
}
if(fc&&!document.getElementById('sNo').value){
document.getElementById('sGrade').value=fg||'3';
document.getElementById('sClass').value=String(parseInt(fc)).padStart(2,'0');
document.getElementById('sNo').value=String(parseInt(fn)).padStart(2,'0');
updPreview();
}

// === ì§„ë¡œ ì¶”ì¶œ (í¬ë§ë¶„ì•¼/í¬ë§ì§„ë¡œ íŒ¨í„´) ===
if(!document.getElementById('sCareer').value){
const careerPatterns=[
/í¬ë§\s*ë¶„ì•¼\s*[:\s]*([ê°€-í£a-zA-Z\/Â·]{2,15})/,
/í¬ë§\s*ì§„ë¡œ\s*[:\s]*([ê°€-í£a-zA-Z\/Â·]{2,15})/,
/ì§„ë¡œ\s*í¬ë§\s*[:\s]*([ê°€-í£a-zA-Z\/Â·]{2,15})/,
/ì¥ë˜\s*í¬ë§\s*[:\s]*([ê°€-í£a-zA-Z\/Â·]{2,15})/,
];
for(const p of careerPatterns){
const cm=txt.match(p);
if(cm&&cm[1]){
const career=cm[1].trim();
if(career.length>=2&&career.length<=15){
document.getElementById('sCareer').value=career;
filled.push('ì§„ë¡œ');
break;
}
}
}
}
// === ë™ì•„ë¦¬ëŠ” ìë™ì¶”ì¶œí•˜ì§€ ì•ŠìŒ (ì˜¤íƒ ë§ì•„ì„œ AI ë¶„ì„ í›„ ì±„ì›€) ===

// === v5.0: ë‚´ì‹  3ì¢… ìë™ íŒŒì‹± ===
try{
const nStat=document.getElementById('naesinStatus');
if(nStat)nStat.textContent='ğŸ”„ ì„±ì í‘œ ë¶„ì„ ì¤‘...';
if(nStat)nStat.style.color='var(--blue)';

const gradeRows=[];

// êµ­ì˜ìˆ˜ì‚¬ê³¼ ê³¼ëª© ë¶„ë¥˜
const korSubjects=['êµ­ì–´','ë¬¸í•™','ë…ì„œ','í™”ë²•ê³¼ì‘ë¬¸','í™”ë²•','ì‘ë¬¸','ì–¸ì–´ì™€ë§¤ì²´','ì–¸ì–´','ë§¤ì²´','ë…ì„œì™€ë¬¸ë²•','ì‹¤ìš©êµ­ì–´','ì‹¬í™”êµ­ì–´','ê³ ì „ì½ê¸°','ê³ ì „ê³¼ìœ¤ë¦¬'];
const engSubjects=['ì˜ì–´','ì˜ì–´â… ','ì˜ì–´â…¡','ì˜ì–´1','ì˜ì–´2','ì˜ì–´íšŒí™”','ì‹¤ìš©ì˜ì–´','ì˜ì–´ë…í•´ì™€ì‘ë¬¸','ì§„ë¡œì˜ì–´','ì˜ë¯¸ë¬¸í•™ì½ê¸°'];
const mathSubjects=['ìˆ˜í•™','ìˆ˜í•™â… ','ìˆ˜í•™â…¡','ìˆ˜í•™1','ìˆ˜í•™2','ë¯¸ì ë¶„','í™•ë¥ ê³¼í†µê³„','ê¸°í•˜','ì‹¤ìš©ìˆ˜í•™','ê²½ì œìˆ˜í•™','ìˆ˜í•™ê³¼ì œíƒêµ¬','ì¸ê³µì§€ëŠ¥ìˆ˜í•™'];
const socSubjects=['í•œêµ­ì‚¬','ì‚¬íšŒ','í†µí•©ì‚¬íšŒ','ì‚¬íšŒë¬¸í™”','ì‚¬íšŒÂ·ë¬¸í™”','ì •ì¹˜ì™€ë²•','ê²½ì œ','ìƒí™œê³¼ìœ¤ë¦¬','ìœ¤ë¦¬ì™€ì‚¬ìƒ','í•œêµ­ì§€ë¦¬','ì„¸ê³„ì§€ë¦¬','ë™ì•„ì‹œì•„ì‚¬','ì„¸ê³„ì‚¬','ì—¬í–‰ì§€ë¦¬','ì‚¬íšŒë¬¸ì œíƒêµ¬'];
const sciSubjects=['ê³¼í•™','í†µí•©ê³¼í•™','ë¬¼ë¦¬í•™â… ','ë¬¼ë¦¬í•™â…¡','ë¬¼ë¦¬í•™1','ë¬¼ë¦¬í•™2','í™”í•™â… ','í™”í•™â…¡','í™”í•™1','í™”í•™2','ìƒëª…ê³¼í•™â… ','ìƒëª…ê³¼í•™â…¡','ìƒëª…ê³¼í•™1','ìƒëª…ê³¼í•™2','ì§€êµ¬ê³¼í•™â… ','ì§€êµ¬ê³¼í•™â…¡','ì§€êµ¬ê³¼í•™1','ì§€êµ¬ê³¼í•™2','ê³¼í•™íƒêµ¬ì‹¤í—˜','ë¬¼ë¦¬','í™”í•™','ìƒëª…ê³¼í•™','ì§€êµ¬ê³¼í•™','ìœµí•©ê³¼í•™'];

// ë””ë²„ê·¸: ì„±ì í‘œ ì˜ì—­ ì¶”ì¶œ
const scoreIdx=txt.search(/í•™ê¸°\s*(êµê³¼|ê³¼ëª©|í•™ì |ë‹¨ìœ„)/);
const scoreArea=scoreIdx>=0?txt.substring(scoreIdx, Math.min(scoreIdx+1500, txt.length)):txt.substring(0,800);
console.log('[ë‚´ì‹ íŒŒì‹±] ì„±ì í‘œ ì˜ì—­ ë°œê²¬:', scoreIdx>=0?'ìœ„ì¹˜ '+scoreIdx:'âŒ ëª»ì°¾ìŒ');
console.log('[ë‚´ì‹ íŒŒì‹±] ì„±ì í‘œ í…ìŠ¤íŠ¸ ìƒ˜í”Œ:', scoreArea.substring(0,600));

// ë‹¤ì–‘í•œ ì •ê·œì‹ íŒ¨í„´ (ì‹¤ì œ ìƒê¸°ë¶€ í˜•ì‹ ê¸°ë°˜)
// ì‹¤ì œ í˜•ì‹: ê³¼ëª©ëª… í•™ì ìˆ˜ ì›ì ìˆ˜/í‰ê· (í‘œí¸) ì„±ì·¨ë„(ìˆ˜ê°•ììˆ˜) ì„ì°¨ë“±ê¸‰
// ì˜ˆ: êµ­ì–´ 3 73/67.7(16.4) C(232) 5
// ì˜ˆ: ìˆ˜í•™â…¡ 4 88/77.4(11.1) B(223) 3
// ì˜ˆ: ì‚¬íšŒÂ·ë¬¸í™” 4 84/66.0(16.7) B(81) 3
// P(pass) ê³¼ëª©ì€ ì„ì°¨ë“±ê¸‰ ì—†ìŒ â†’ ì œì™¸
const patterns=[
// íŒ¨í„´A: ê³¼ëª©ëª… í•™ì ìˆ˜ ì›ì ìˆ˜/í‰ê· (í‘œí¸) ì„±ì·¨ë„(ìˆ˜ê°•ììˆ˜) ì„ì°¨ë“±ê¸‰
/([ê°€-í£a-zA-Zâ… â…¡Â·\s]{2,15}?)\s+(\d)\s+\d{1,3}\s*\/\s*[\d.]+\s*\(\s*[\d.]+\s*\)\s+[A-E]\s*\(\s*\d+\s*\)\s+(\d)/g,
// íŒ¨í„´B: íƒ­/ì—¬ëŸ¬ê³µë°± êµ¬ë¶„ ë²„ì „
/([ê°€-í£a-zA-Zâ… â…¡Â·\s]{2,15}?)\s{2,}(\d)\s{2,}\d{1,3}\s*\/\s*[\d.]+\s*\(\s*[\d.]+\s*\)\s+[A-E]\s*\(\s*\d+\s*\)\s+(\d)/g,
// íŒ¨í„´C: ë” ìœ ì—° - ì„±ì·¨ë„ ì—†ì´ ë°”ë¡œ ë“±ê¸‰ (ì¼ë¶€ PDF ì¶”ì¶œ í˜•íƒœ)
/([ê°€-í£a-zA-Zâ… â…¡Â·]{2,12}(?:\s*[â… â…¡I1-9])?)\s+(\d)\s+\d{2,3}\s*\/\s*[\d.]+\s*\([\d.]+\)\s+\w\s*\(\d+\)\s+(\d)/g,
];

for(const pat of patterns){
let m;
pat.lastIndex=0;
while((m=pat.exec(txt))!==null){
const subj=m[1].trim();
const unit=parseInt(m[2]);
const grade=parseInt(m[3]);
if(unit>=1&&unit<=6&&grade>=1&&grade<=9&&subj.length>=2){
if(!gradeRows.find(r=>r.subj===subj&&r.unit===unit&&r.grade===grade)){
gradeRows.push({subj,unit,grade});
}
}
}
if(gradeRows.length>=5)break;
}

// íŒ¨í„´ ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ: ë¼ì¸ ê¸°ë°˜ íŒŒì‹± (PDF.jsê°€ í‘œë¥¼ ì¤„ ë‹¨ìœ„ë¡œ ì¶”ì¶œí•˜ëŠ” ê²½ìš°)
if(gradeRows.length<3){
console.log('[ë‚´ì‹ íŒŒì‹±] ì •ê·œì‹ ì‹¤íŒ¨, ë¼ì¸ ê¸°ë°˜ íŒŒì‹± ì‹œë„...');
const allSubjects=[...korSubjects,...engSubjects,...mathSubjects,...socSubjects,...sciSubjects,'ì •ë³´','ë³´ê±´','ê¸°ìˆ ê°€ì •','ê¸°ìˆ Â·ê°€ì •','ì œ2ì™¸êµ­ì–´','ì¼ë³¸ì–´','ì¤‘êµ­ì–´','í•œë¬¸','ì§„ë¡œì™€ì§ì—…','ìŒì•…','ë¯¸ìˆ ','ì²´ìœ¡'];
const lines=txt.split(/\n/);
for(let i=0;i<lines.length;i++){
const line=lines[i].trim();
// ê³¼ëª©ëª…ì´ í¬í•¨ëœ ì¤„ì—ì„œ ìˆ«ìë“¤ ì¶”ì¶œ
for(const subName of allSubjects){
if(line.includes(subName)){
// ê°™ì€ ì¤„ ë˜ëŠ” ì¸ì ‘ ì¤„ì—ì„œ í•™ì ìˆ˜, ì„ì°¨ë“±ê¸‰ ì°¾ê¸°
const context=line+' '+(lines[i+1]||'')+' '+(lines[i-1]||'');
// í•™ì ìˆ˜(1~6) ì›ì ìˆ˜/í‰ê· (í‘œí¸) ì„±ì·¨ë„(ìˆ˜ê°•ììˆ˜) ì„ì°¨ë“±ê¸‰(1~9) íŒ¨í„´
const rm=context.match(new RegExp(subName.replace(/[Â·\s]/g,'\\s*')+'[^\\d]*(\\d)\\s+\\d{2,3}\\s*\\/\\s*[\\d.]+\\s*\\([\\d.]+\\)\\s+[A-EP]\\s*\\(\\d+\\)\\s+(\\d)'));
if(rm){
const unit=parseInt(rm[1]);
const grade=parseInt(rm[2]);
if(unit>=1&&unit<=6&&grade>=1&&grade<=9){
if(!gradeRows.find(r=>r.subj===subName))gradeRows.push({subj:subName,unit,grade});
}
}
break;
}
}
}
} // if(gradeRows.length<3) ë‹«ê¸°

console.log('[ë‚´ì‹ íŒŒì‹±] ë°œê²¬ëœ ê³¼ëª©:', gradeRows.length, gradeRows.map(r=>r.subj+'('+r.unit+'ë‹¨ìœ„,'+r.grade+'ë“±ê¸‰)'));

if(gradeRows.length>=3){
const classify=(subj)=>{
const s=subj.replace(/\s/g,'');
return{
isKor:korSubjects.some(k=>s.includes(k.replace(/\s/g,''))),
isEng:engSubjects.some(k=>s.includes(k.replace(/\s/g,''))),
isMath:mathSubjects.some(k=>s.includes(k.replace(/\s/g,''))),
isSoc:socSubjects.some(k=>s.includes(k.replace(/\s/g,''))),
isSci:sciSubjects.some(k=>s.includes(k.replace(/\s/g,'')))
};
};

let sumAll=0,unitAll=0,sumMSS=0,unitMSS=0,sumMSN=0,unitMSN=0;
gradeRows.forEach(r=>{
sumAll+=r.grade*r.unit;unitAll+=r.unit;
const c=classify(r.subj);
if(c.isKor||c.isEng||c.isMath||c.isSoc){sumMSS+=r.grade*r.unit;unitMSS+=r.unit;}
if(c.isKor||c.isEng||c.isMath||c.isSci){sumMSN+=r.grade*r.unit;unitMSN+=r.unit;}
});

const nAll=unitAll>0?Math.round(sumAll/unitAll*10)/10:0;
const nMSS=unitMSS>0?Math.round(sumMSS/unitMSS*10)/10:0;
const nMSN=unitMSN>0?Math.round(sumMSN/unitMSN*10)/10:0;

if(nAll>0&&!document.getElementById('sNaesinAll').value){
document.getElementById('sNaesinAll').value=nAll;
const el=document.getElementById('sNaesinAll');el.style.borderColor='#3182F6';el.style.background='#EBF4FF';
}
if(nMSS>0&&!document.getElementById('sNaesinMSS').value){
document.getElementById('sNaesinMSS').value=nMSS;
const el=document.getElementById('sNaesinMSS');el.style.borderColor='#7B61FF';el.style.background='#F0EDFF';
}
if(nMSN>0&&!document.getElementById('sNaesinMSN').value){
document.getElementById('sNaesinMSN').value=nMSN;
const el=document.getElementById('sNaesinMSN');el.style.borderColor='#22B8CF';el.style.background='#E3FAFC';
}
if(nStat){nStat.textContent='âœ… '+gradeRows.length+'ê³¼ëª© ì¶”ì¶œ ì™„ë£Œ (êµì‚¬ í™•ì¸ í•„ìš”)';nStat.style.color='var(--teal)';}
filled.push('ë‚´ì‹ ('+gradeRows.length+'ê³¼ëª©)');
console.log('[ë‚´ì‹ íŒŒì‹± ì„±ê³µ]','ì „ì²´:'+nAll,'êµ­ì˜ìˆ˜ì‚¬:'+nMSS,'êµ­ì˜ìˆ˜ê³¼:'+nMSN);
}else{
if(nStat){nStat.textContent='âš ï¸ ì„±ì í‘œ ìë™ ì¶”ì¶œ ì‹¤íŒ¨ â€” ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”';nStat.style.color='var(--orange)';}
console.log('[ë‚´ì‹ íŒŒì‹±] ê³¼ëª© ë¶€ì¡±(',gradeRows.length,'ê°œ) â€” ì§ì ‘ ì…ë ¥ í•„ìš”');
}
}catch(ne){
console.warn('[ë‚´ì‹ íŒŒì‹± ì‹¤íŒ¨]',ne);
const nStat=document.getElementById('naesinStatus');
if(nStat){nStat.textContent='âš ï¸ ìë™ ì¶”ì¶œ ì‹¤íŒ¨ â€” ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”';nStat.style.color='var(--orange)';}
}

chk();
const filled=[];
if(foundName)filled.push('ì´ë¦„');
if(fc)filled.push('í•™ë²ˆ');
if(filled.length){
const sub=dz.querySelector('.dz-s');
if(sub)sub.textContent+=` Â· ìë™ì¶”ì¶œ: ${filled.join(', ')} âœ“`;
}
}catch(e){console.warn('[autoFill]',e)}
}

function bp(nm,cr,cl,kw,me){
const _univ=document.getElementById('sUniv')?.value||'';
const _major=document.getElementById('sMajor')?.value||'';
return`ë‹¹ì‹ ì€ ëŒ€í•œë¯¼êµ­ ê³ ë“±í•™êµ í•™êµìƒí™œê¸°ë¡ë¶€(ìƒê¸°ë¶€) ì „ë¬¸ ë¶„ì„ê°€ì´ì í•™ìƒë¶€ì¢…í•©ì „í˜• í‰ê°€ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
í•™ìƒì˜ 1~2í•™ë…„ ìƒê¸°ë¶€ë¥¼ ëƒ‰ì •í•˜ê³  ê°ê´€ì ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ 3í•™ë…„ ì „ëµ ë³´ê³ ì„œë¥¼ JSONìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.

[í•™ìƒ ì •ë³´]
- ì´ë¦„: ${nm} | ì§„ë¡œ: ${cr} | ë™ì•„ë¦¬: ${cl}
${_univ||_major?`- í¬ë§ ëŒ€í•™/ì „ê³µ: ${_univ||'ë¯¸ì •'} ${_major||'ë¯¸ì •'}
  âš ï¸ ëŒ€í•™ë³„ í‰ê°€ íŠ¹ì„± ë°˜ì˜ í•„ìˆ˜:
  - ì´ ëŒ€í•™ì˜ í•™ìƒë¶€ì¢…í•©ì „í˜•ì—ì„œ ì¤‘ì‹œí•˜ëŠ” ì¸ì¬ìƒÂ·í•µì‹¬ì—­ëŸ‰ì„ íŒŒì•…í•˜ì—¬ ì „ì²´ ë¶„ì„ì— ë°˜ì˜
  - í•´ë‹¹ í•™ê³¼ì˜ êµê³¼ ì—°ê³„ë¥¼ íŒŒì•…í•˜ì—¬ ì„¸íŠ¹/ê¸°ì¬ì˜ˆì‹œ ë°©í–¥ ì„¤ì •
  - ì˜ˆ: ê²½ë¶ëŒ€ í–‰ì •í•™ê³¼ â†’ 'ì§€ì—­ì‚¬íšŒ ê¸°ì—¬' ì—­ëŸ‰ ì¤‘ì‹œ, ì‚¬íšŒê³¼í•™ ë°©ë²•ë¡ Â·ì •ì±…ë¶„ì„ êµê³¼ ì—°ê³„
  - ì˜ˆ: í•œì–‘ëŒ€ í–‰ì •í•™ê³¼ â†’ ì‹¤ìš©ì  ë¬¸ì œí•´ê²° ê°•ì¡°, ë°ì´í„° ë¶„ì„Â·í–‰ì •ë²• êµê³¼ ì—°ê³„
  - 3í•™ë…„ ì „ëµÂ·ì„¸íŠ¹Â·ê¸°ì¬ì˜ˆì‹œë¥¼ ì´ ëŒ€í•™/ì „ê³µ í•©ê²©ì— ìµœì í™”í•  ê²ƒ`:''}
- í‚¤ì›Œë“œ: ${kw.join(', ')||'ë¯¸ì§€ì •'}
${me?'- ë©”ëª¨: '+me:''}
- ì „ëµ ì´ˆì : ${pri[0]} ì¤‘ì‹¬ (ê¸°ì¬ì˜ˆì‹œÂ·ì„¸íŠ¹ì¶”ì²œÂ·ìƒë‹´ë°©í–¥ì„ ì´ ì—­ëŸ‰ ì¤‘ì‹¬ìœ¼ë¡œ ì‘ì„±. âš ï¸ ì ìˆ˜/ë“±ê¸‰ íŒì •ì—ëŠ” ì˜í–¥ ì—†ìŒ!)
- âš ï¸ ì „ê³µ ë§¥ë½ ì¼ê´€ì„±: ì´ í•™ìƒì˜ í¬ë§ ì§„ë¡œÂ·í•™ê³¼ì— ë§ì§€ ì•ŠëŠ” ì¡°ì–¸ ê¸ˆì§€! (ì˜ˆ: í–‰ì •í•™ê³¼ì¸ë° "ìì—°ê³¼í•™ ì‹¬í™”" ì¡°ì–¸ ê¸ˆì§€, ê°„í˜¸í•™ê³¼ì¸ë° "ì‚¬íšŒê³¼í•™ ë°©ë²•ë¡  ì‹¬í™”" ê¸ˆì§€)

[2026 ëŒ€ì… ì œë„ í•µì‹¬]
- í‰ê°€ ì—­ëŸ‰: í•™ì—…ì—­ëŸ‰(ì„±ì·¨ë„Â·íƒœë„Â·íƒêµ¬ë ¥), ì§„ë¡œì—­ëŸ‰(êµê³¼ì´ìˆ˜Â·ì§„ë¡œíƒìƒ‰), ê³µë™ì²´ì—­ëŸ‰(í˜‘ì—…Â·ë‚˜ëˆ”Â·ì„±ì‹¤Â·ë¦¬ë”ì‹­)
- êµì‚¬ì¶”ì²œì„œÂ·ìê¸°ì†Œê°œì„œ íì§€ â†’ ìƒê¸°ë¶€ë§Œìœ¼ë¡œ í‰ê°€
- í–‰ë°œ 3í•™ë…„: í•™ì¢… ìˆ˜ì‹œ ë¯¸ë°˜ì˜(1~2í•™ë…„ë§Œ ì œê³µ), ì •ì‹œ í•™ìƒë¶€ë°˜ì˜ ëŒ€í•™(ì„œìš¸ëŒ€ ë“±)ì—ì„œë§Œ í™œìš©
- ë¹„êµê³¼(ììœ¨ë™ì•„ë¦¬Â·êµë‚´ìˆ˜ìƒÂ·ë…ì„œÂ·ê°œì¸ë´‰ì‚¬) ëŒ€í•™ ë¯¸ì œê³µ

[ë“±ê¸‰ íŒì • ê¸°ì¤€ â€” 5ë‹¨ê³„ S+/S/A/B/C]
S+(5.0): ë…ìì  ë°©ë²•ë¡ (ì½”ë”©/ì‹¤í—˜ì„¤ê³„/ë°ì´í„° ì§ì ‘ ìƒì„±), ëŒ€í•™ í•™ë¶€ ìˆ˜ì¤€ ì—°êµ¬, ë°©ë²•ë¡ Â·ë„êµ¬Â·ê²°ê³¼ 3ì  ì„¸íŠ¸ + í›„ì†ì—°êµ¬ ì§ˆë¬¸ + êµê³¼ ê°œë… ì¬í•´ì„Â·ì¬êµ¬ì„±. ë§¤ìš° ë“œë¬¾.
S(4.5): ì´ë¡  ì—°ê²° íƒ„íƒ„ + í›„ì†ì—°êµ¬ + êµ¬ì²´ì  ì‚¬ë¡€ ë¶„ì„. ë…ì„œâ†’ê°œë… ì ìš©â†’ì¬í•´ì„ ìˆ˜ì¤€. êµê³¼ ì‹¬í™” í™œë™ì´ ëª…í™•. ìƒìœ„ 5~10%.
A(4.0): êµê³¼ ì—°ê³„ íƒêµ¬ + ë…ì„œ í™•ì¥ + ë…¼ë¦¬ì  ë¶„ì„. êµ¬ì²´ì  ë°ì´í„° ì œì‹œ + ë¶„ì„ê¸°ì¤€ 2~3ê°œ + ê²°ê³¼ë¬¼ ëª…í™•. ìƒìœ„ 20~30%.
B(3.0): ìˆ˜ì—… ë‚´ í™œë™ ì¶©ì‹¤ + ê¸°ë³¸ì  ì—°ê³„, ë™ê¸°+ìˆ˜í–‰+ëŠë‚€ì  êµ¬ì¡°. "~ì•Œê²Œ ë¨", "~ì— ê´€ì‹¬ì„ ê°–ê²Œ ë¨" ìˆ˜ì¤€. ê°€ì¥ í”í•œ ë“±ê¸‰.
C(2.0): í”¼ìƒì  ì°¸ì—¬, ìˆ˜ë™ì  ì°¸ì—¬ ê¸°ë¡, ë³µë¶™Â·ì„±ì  ë‚˜ì—´, êµ¬ì²´ì„± ì—†ìŒ. íŠ¹ê¸°í•  ë‚´ìš© ì—†ìŒ.

[ë°”ì´íŠ¸ ì œí•œ] í•œê¸€1ì=3B, ì˜ë¬¸/ìˆ«ì=1B
ììœ¨:1500B | ì§„ë¡œ:2100B | ë™ì•„ë¦¬:1500B | í–‰ë°œ:1500B

[ìƒê¸°ë¶€ ì›ë¬¸]
${pdf.length>45000?pdf.substring(0,45000)+'\n[âš  ì›ë¬¸ ì¼ë¶€ ìƒëµ]':pdf}

[ë¶„ì„ ì§€ì¹¨]

0. student_info: ìƒê¸°ë¶€ì—ì„œ ì´ë¦„/í•™ë…„/ë°˜/ë²ˆí˜¸/ì§„ë¡œ/ë™ì•„ë¦¬ ì¶”ì¶œ + ë‚´ì‹  ê³„ì‚°
- ìƒê¸°ë¶€ ì„±ì í‘œì—ì„œ ê³¼ëª©ë³„ ì„ì°¨ë“±ê¸‰ê³¼ ë‹¨ìœ„ìˆ˜ë¥¼ ì½ì–´ ì•„ë˜ ê³„ì‚°:
  * naesin_all: ì „ì²´ êµê³¼ í‰ê·  ë“±ê¸‰ (ëª¨ë“  ê³¼ëª©, ë‹¨ìœ„ìˆ˜ ê°€ì¤‘í‰ê· , ì†Œìˆ˜ì  ì²«ì§¸ìë¦¬)
  * naesin_mss: êµ­ì–´+ì˜ì–´+ìˆ˜í•™+ì‚¬íšŒ ê³„ì—´ ê³¼ëª© í‰ê·  ë“±ê¸‰ (í•œêµ­ì‚¬/ì‚¬íšŒë¬¸í™”/ì •ì¹˜ì™€ë²•/ê²½ì œ/ìƒí™œê³¼ìœ¤ë¦¬/í•œêµ­ì§€ë¦¬/ì„¸ê³„ì§€ë¦¬/ë™ì•„ì‹œì•„ì‚¬/ì„¸ê³„ì‚¬/ìœ¤ë¦¬ì™€ì‚¬ìƒ í¬í•¨)
  * naesin_msn: êµ­ì–´+ì˜ì–´+ìˆ˜í•™+ê³¼í•™ ê³„ì—´ ê³¼ëª© í‰ê·  ë“±ê¸‰ (ë¬¼ë¦¬/í™”í•™/ìƒëª…ê³¼í•™/ì§€êµ¬ê³¼í•™/í†µí•©ê³¼í•™ í¬í•¨)
  * grade_trend: í•™ê¸°ë³„ ë‚´ì‹  ë“±ê¸‰ ì¶”ì´ ë°°ì—´ (ë§¤ìš° ì¤‘ìš”!)
    ê° í•™ê¸°ë³„ë¡œ: {"semester":"1-1", "all":0, "mss":0, "msn":0, "key_subjects":[{"name":"ê³¼ëª©ëª…","grade":ë“±ê¸‰ìˆ«ì}]}
    ì˜ˆ: [{"semester":"1-1","all":4.2,"mss":3.8,"msn":4.5,"key_subjects":[{"name":"êµ­ì–´","grade":3},{"name":"ìˆ˜í•™","grade":5}]}, ...]
    - 1-1, 1-2, 2-1, 2-2 ì´ 4í•™ê¸°
    - all/mss/msn: í•´ë‹¹ í•™ê¸°ì˜ í‰ê· ë“±ê¸‰ (ë‹¨ìœ„ìˆ˜ ê°€ì¤‘í‰ê· )
    - key_subjects: í•´ë‹¹ í•™ê¸°ì˜ ì£¼ìš” ê³¼ëª©ë³„ ë“±ê¸‰ (êµ­ì–´/ì˜ì–´/ìˆ˜í•™ + ì‚¬íšŒorê³¼í•™ ê³„ì—´ 2~3ê°œ)
    - ì„ì°¨ë“±ê¸‰ì´ ì—†ëŠ” ê³¼ëª©(A/B ì„±ì·¨í‰ê°€ì œ)ì€ ì œì™¸
- ê³„ì‚° ì‹œ ë‹¨ìœ„ìˆ˜ ê°€ì¤‘í‰ê·  ì‚¬ìš©.
- 1í•™ë…„+2í•™ë…„ ì „ì²´ í¬í•¨ (í•™ê¸°ë³„ë¡œ ë¶„ë¦¬).

0.5 rating_matrix: ì˜ì—­Ã—ì—­ëŸ‰ 2ì°¨ì› ë“±ê¸‰ ë§¤íŠ¸ë¦­ìŠ¤ â€” ë°˜ë“œì‹œ ë¨¼ì € ì‘ì„±!
ì•„ë˜ 12ì¹¸ì— ëŒ€í•´ ê°ê° S+/S/A/B/C ë“±ê¸‰ì„ íŒì •í•˜ë¼.

         | ììœ¨(jayul) | ì§„ë¡œ(jinro) | êµê³¼ì„¸íŠ¹(subject) | ë™ì•„ë¦¬(club) |
---------|-------------|-------------|-------------------|--------------|
í•™ì—…(academic)  |             |             |                   |              |
ì§„ë¡œ(career)    |             |             |                   |              |
ê³µë™ì²´(community)|            |             |                   |              |

- ê° ì¹¸: í•´ë‹¹ ì˜ì—­ì—ì„œ í•´ë‹¹ ì—­ëŸ‰ì´ ë“œëŸ¬ë‚˜ëŠ” ì •ë„
- êµê³¼ì„¸íŠ¹(subject)ì€ ì „ì²´ êµê³¼ì„¸íŠ¹ì„ ì¢…í•©í•œ ë“±ê¸‰
- 12ì¹¸ ëª¨ë‘ ì±„ìš¸ ê²ƒ. ê·¼ê±° ë¶€ì¡±í•˜ë©´ Bë¡œ ê¸°ë³¸ê°’
- í”„ë¡œê·¸ë¨ì´ ì´ ë§¤íŠ¸ë¦­ìŠ¤ì—ì„œ ê°€ì¤‘í‰ê· ìœ¼ë¡œ ì ìˆ˜ë¥¼ ìë™ ì‚°ì¶œí•¨
- âš ï¸ ë“±ê¸‰ì€ ëƒ‰ì •í•˜ê²Œ! S+ëŠ” ë§¤ìš° ë“œë¬¼ê³ , ëŒ€ë¶€ë¶„ì€ A~Bê°€ ì ì ˆ

1. overview: ì¢…í•© ë¶„ì„ â€” ê°€ì¥ ì¤‘ìš”! ì¶©ì‹¤í•˜ê²Œ!
- summary: ì „ì²´ ì„±ì¥ ì„œì‚¬ 5~7ë¬¸ì¥. 1í•™ë…„ì—ì„œ ì–´ë–»ê²Œ ì‹œì‘í•´ì„œ, 2í•™ë…„ì—ì„œ ì–´ë–»ê²Œ ë°œì „í–ˆëŠ”ì§€.
  âš ï¸ í¬ë§ ëŒ€í•™ì´ ìˆìœ¼ë©´, ê·¸ ëŒ€í•™ì˜ ì¸ì¬ìƒÂ·í•µì‹¬ì—­ëŸ‰Â·ì „í˜• íŠ¹ì§•ì„ ë°˜ì˜í•˜ì—¬ ë¶„ì„í•  ê²ƒ.
- change_analysis: 1í•™ë…„â†’2í•™ë…„ ë³€í™” ë¶„ì„ 3~5ë¬¸ì¥.
- grade3_direction: 3í•™ë…„ ì „ëµ ë°©í–¥ 3~5ë¬¸ì¥.
  âš ï¸ 3ëŒ€ ì—­ëŸ‰(í•™ì—…/ì§„ë¡œ/ê³µë™ì²´) ì¤‘ ë¶€ì¡±í•œ ë¶€ë¶„ì„ 3í•™ë…„ì— ì–´ë–»ê²Œ ë³´ì™„í• ì§€ êµ¬ì²´ì ìœ¼ë¡œ!
  âš ï¸ í¬ë§ ëŒ€í•™ì´ ìˆìœ¼ë©´, ê·¸ ëŒ€í•™ì—ì„œ ì¤‘ì‹œí•˜ëŠ” ì—­ëŸ‰ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì „ëµ ì œì‹œ.
- strengths: ê°•ì  3ê°œ (ê° 2ë¬¸ì¥, êµ¬ì²´ì  ê·¼ê±°)
- improvements: ë³´ì™„ì  2ê°œ (êµ¬ì²´ì  ëŒ€ì•ˆ í¬í•¨)
- âš ï¸ gpa, gpa_brief, tier, scores í•„ë“œëŠ” 0 ë˜ëŠ” ë¹ˆë¬¸ìì—´ë¡œ ë¹„ì›Œë‘ì„¸ìš”. í”„ë¡œê·¸ë¨ì´ ìë™ ê³„ì‚°.
- score_brief: AIê°€ ì§ì ‘ ì‘ì„± â€” ê° ì—­ëŸ‰ì˜ í•µì‹¬ íŠ¹ì§•ê³¼ í˜„ ìˆ˜ì¤€ì„ êµ¬ì²´ì ìœ¼ë¡œ í•œì¤„ (ì˜ˆ: "êµê³¼ ê°œë…ì˜ ì§„ë¡œ ì ìš©ì´ ë›°ì–´ë‚˜ë‚˜, ìì—°ê³¼í•™ íƒêµ¬ì™€ ì—°ê³„ ë³´ì™„ í•„ìš”")
- competencies: 3ëŒ€ ì—­ëŸ‰ë³„ grade1(1í•™ë…„ 3ë¬¸ì¥), grade2(2í•™ë…„ 3ë¬¸ì¥), growth(ë³€í™” 2ë¬¸ì¥), grade3_focus(3í•™ë…„ ì§‘ì¤‘ 2ë¬¸ì¥)
- keywords: í•µì‹¬ í‚¤ì›Œë“œ 3~5ê°œ

2. subject_analysis: êµê³¼ ì„¸íŠ¹ ì „ë°˜ ë¶„ì„ â€” í•µì‹¬!
- overall_grade: êµê³¼ ì„¸íŠ¹ ì „ë°˜ ë“±ê¸‰ (S+/S/A/B/C)
- overall_score: êµê³¼ ì„¸íŠ¹ ì „ë°˜ í‰ì  (5.0 ë§Œì )
- s_elements: S+/Së“±ê¸‰ ìš”ì†Œ â€” êµ¬ì²´ì  ê³¼ëª©ëª…+ë‚´ìš© í¬í•¨í•˜ì—¬ ê¸°ìˆ 
- a_elements: Aë“±ê¸‰ ìš”ì†Œ â€” ë™ì¼ í˜•ì‹
- b_elements: Bë“±ê¸‰ ìš”ì†Œ â€” íšŸìˆ˜ì™€ ì£¼ìš” íŒ¨í„´
- c_elements: Cë“±ê¸‰ ìš”ì†Œ â€” íšŸìˆ˜ì™€ ì£¼ìš” íŒ¨í„´
- analysis: ì¢…í•© ë¶„ì„ 3~4ë¬¸ì¥
- subject_cards: ê³¼ëª©ë³„ ì„¸íŠ¹ ë¶„ì„ ì¹´ë“œ ë°°ì—´. ê° ì¹´ë“œ:
  {"name":"ê³¼ëª©ëª…","grade":"S+/S/A/B/C","grade_num":"í•™ë…„","summary":"í•µì‹¬ ë‚´ìš©ê³¼ ë“±ê¸‰ ê·¼ê±° 2~3ë¬¸ì¥","highlight":"ê°€ì¥ ì¸ìƒì  í™œë™"}
  â†’ ì„¸íŠ¹ ê¸°ë¡ì´ ìˆëŠ” ê³¼ëª©ë§Œ (6~12ê°œ)
- strong_subjects: ìš°ìˆ˜ ê³¼ëª© 2~3ê°œ(ê³¼ëª©ëª…ë§Œ)
- weak_subjects: ë³´ì™„ í•„ìš” ê³¼ëª© 2~3ê°œ(ê³¼ëª©ëª…ë§Œ)

3. jarhaeng: ììœ¨/ì§„ë¡œ/ë™ì•„ë¦¬/í–‰ë°œ ê¸°ì¬ ì˜ˆì‹œ â€” ê°€ì¥ ì¤‘ìš”!
ê° ì˜ì—­ë³„:
- grade: 1~2í•™ë…„ í•´ë‹¹ ì˜ì—­ ê¸°ë¡ ë“±ê¸‰ (S+/S/A/B/C)
- evaluation: âš ï¸ ë§¤ìš° ìƒì„¸í•˜ê²Œ! ìµœì†Œ 5ë¬¸ì¥. ë°˜ë“œì‹œ ì•„ë˜ 4ìš”ì†Œ í¬í•¨:
  â‘  í˜„ì¬ ë“±ê¸‰ íŒì • ê·¼ê±°: ì™œ ì´ ë“±ê¸‰ì¸ì§€ êµ¬ì²´ì  í™œë™/ë‚´ìš©ìœ¼ë¡œ ì„¤ëª… (ì˜ˆ: "1í•™ë…„ ëª¨ì˜êµ­ì œíšŒì˜ ê²½í—˜+2í•™ë…„ ë²”ì£„í†µê³„ ë¶„ì„ì´ ê²°í•©ë˜ì–´ ì§„ë¡œ íƒìƒ‰ì˜ ê¹Šì´ê°€ Aê¸‰")
  â‘¡ í˜„ì¬ ê¸°ë¡ì˜ êµ¬ì²´ì  ê°•ì  (ê³¼ëª©ëª…Â·í™œë™ëª… í¬í•¨)
  â‘¢ í˜„ì¬ ê¸°ë¡ì˜ ì•½ì Â·ë¹ˆ ê³³ (êµ¬ì²´ì ìœ¼ë¡œ ë­ê°€ ë¹ ì ¸ìˆëŠ”ì§€)
  â‘£ 3í•™ë…„ì— ì´ ë“±ê¸‰ì„ í•œ ë‹¨ê³„ ëŒì–´ì˜¬ë¦¬ë ¤ë©´ (Aâ†’Së¡œ ê°€ë ¤ë©´ ë­˜ í•´ì•¼ í•˜ëŠ”ì§€)
- s_elements: Sê¸‰ ìš”ì†Œ (êµ¬ì²´ì  í™œë™ëª… í¬í•¨, ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)
- a_elements: Aê¸‰ ìš”ì†Œ (êµ¬ì²´ì  í™œë™ëª… í¬í•¨, ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)
- b_elements: Bê¸‰ ìš”ì†Œ (êµ¬ì²´ì  í™œë™ëª… í¬í•¨, ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)
- c_elements: Cê¸‰ ìš”ì†Œ (êµ¬ì²´ì  í™œë™ëª… í¬í•¨, ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)
- option1: ì•ˆì „í˜•(Aë“±ê¸‰ ê¸°ì¤€) â€” í˜„ì‹¤ì  ê¸°ì¬
- option2: ë„ì „í˜•(Së“±ê¸‰ ê¸°ì¤€) â€” ì‹¬í™” íƒêµ¬ ê¸°ì¬
  * ê³µí†µ í•„ë“œ: title, text, focus, supplement
  * text ê·œì¹™:
    âš ï¸ 3í•™ë…„ í™œë™ì´ë¯€ë¡œ ë°˜ë“œì‹œ ì¡°ê±´ë¶€ ì œì•ˆ í˜•ì‹!
    "~í•  ê²½ìš°", "~í•œë‹¤ë©´", "~ì„ ê³„íší•˜ê³  ìˆìœ¼ë©°" ë“± ë¯¸ë˜í˜•Â·ê°€ì •ë²• í†¤.
    ì ˆëŒ€ ì™„ë£Œí˜•("~í•˜ì˜€ìŒ","~ìˆ˜í–‰í•¨") ê¸ˆì§€!
    ë°”ì´íŠ¸ ì œí•œ ë‚´ ì™„ì„± ë¬¸ì¥. êµ¬ì²´ì  í™œë™ëª…/ì—­í• /ê³¼ì •/ì˜ˆìƒê²°ê³¼ í•„ìˆ˜.
  * âš ï¸ 3í•™ë…„ í™œë™ ì œì•ˆ ì›ì¹™ (ë§¤ìš° ì¤‘ìš”!):
    1) 1~2í•™ë…„ í™œë™ì˜ ì—°ì¥ì„ /ë§ˆë¬´ë¦¬/ì‹¬í™”ê°€ ê¸°ë³¸. ì™„ì „íˆ ìƒˆë¡œìš´ ì£¼ì œ ì‹œì‘ ê¸ˆì§€!
    2) ì„±ì·¨ê¸°ì¤€ êµê³¼ ì—°ê³„ê°€ ìš°ì„  (ì˜ˆ: ê²½ì œ ìˆ˜ì—…ì—ì„œ ë°°ìš´ ìˆ˜ìš”ê³µê¸‰ â†’ ì‹¤ì¦ ë¶„ì„). ì „ê³µ ì‹¬í™”ëŠ” ë³´ì¡°ì .
    3) ê³ ë“±í•™ìƒ ìˆ˜ì¤€ì— ë§ëŠ” í˜„ì‹¤ì  í™œë™ ì œì•ˆ. ëŒ€í•™ì› ìˆ˜ì¤€ ì—°êµ¬ ì œì•ˆ ê¸ˆì§€.
    4) 1~2í•™ë…„ì—ì„œ ì´ë¯¸ í•œ í™œë™ì„ "í™•ì¥Â·ì‹¬í™”Â·ì²´ê³„í™”"í•˜ëŠ” ë°©í–¥ì´ ê°€ì¥ ìì—°ìŠ¤ëŸ¬ì›€.
- hangbal íŠ¹ë³„ ê·œì¹™: 3í•™ë…„ í–‰ë°œì€ í•™ì¢… ìˆ˜ì‹œ ë¯¸ë°˜ì˜. ê¸°ë¡ ê´€ë¦¬ ì°¨ì›ì—ì„œ ì„±ì‹¤í•˜ê²Œ ì‘ì„±í•˜ë˜, "ì •ì‹œëŒ€ë¹„"ë¼ëŠ” í‘œí˜„ì€ ì‚¬ìš©í•˜ì§€ ë§ ê²ƒ.

4. setuk: 3í•™ë…„ ì„¸íŠ¹ ë°©í–¥ â€” âš ï¸ í•µì‹¬ ê·œì¹™!
- direction: ì „ì²´ ë°©í–¥ 2~3ë¬¸ì¥ (ëŒ€í•™/ì „ê³µ íŠ¹ì„± ë°˜ì˜)
- subjects: 3~5ê°œ ê³¼ëª©. name, theme, reason, keywords(3ê°œ)
  âš ï¸ ë°˜ë“œì‹œ "3í•™ë…„ì— ìƒˆë¡œ ìˆ˜ê°•í•˜ëŠ” ê³¼ëª©"ë§Œ ì œì•ˆ! 1~2í•™ë…„ì— ì´ë¯¸ ì´ìˆ˜í•œ ê³¼ëª© ê¸ˆì§€!
  ì˜ˆ: 1í•™ë…„ ìˆ˜í•™/í†µí•©ì‚¬íšŒ/í†µí•©ê³¼í•™, 2í•™ë…„ ìˆ˜í•™â…¡/ì •ì¹˜ì™€ë²•/ì‚¬íšŒë¬¸í™” ì´ìˆ˜ â†’ 3í•™ë…„ ì œì•ˆì€ í™”ë²•ê³¼ì‘ë¬¸/ê²½ì œ/ìƒí™œê³¼ìœ¤ë¦¬/í™•ë¥ ê³¼í†µê³„/ë¯¸ì ë¶„ ë“± ì•„ì§ ì•ˆ ë“¤ì€ ê²ƒ
  âš ï¸ ì§„ë¡œì„ íƒê³¼ëª©(ì‚¬íšŒê³¼ì œì—°êµ¬/ì—¬í–‰ì§€ë¦¬/ì‚¬íšŒë¬¸ì œíƒêµ¬ ë“±) ë°˜ë“œì‹œ 1ê°œ ì´ìƒ í¬í•¨!
  âš ï¸ í•™ìƒì˜ ì „ê³µ ê³„ì—´ì— ë§ëŠ” ê³¼ëª©ë§Œ ì œì•ˆ (í–‰ì •í•™ â†’ ê²½ì œÂ·ì •ì¹˜ì™€ë²•Â·ì‚¬íšŒë¬¸í™”, ê°„í˜¸ â†’ ìƒëª…ê³¼í•™â…¡Â·í™”í•™â…¡)

5. club: ë™ì•„ë¦¬ í”„ë¡œì íŠ¸ ê³„íš
- name, overview(1~2í•™ë…„ ë¶„ì„ 2~3ë¬¸ì¥), goal(3í•™ë…„ ëª©í‘œ 2ë¬¸ì¥)
- projects: í”„ë¡œì íŠ¸ 2~3ê°œ ì œì•ˆ
  âš ï¸ ë°˜ë“œì‹œ 1~2í•™ë…„ ë™ì•„ë¦¬ í™œë™ì˜ ì—°ì¥ì„ ì—ì„œ ì œì•ˆ! ì™„ì „íˆ ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ ê¸ˆì§€.
  1~2í•™ë…„ì—ì„œ í•œ ê²ƒì„ "ì²´ê³„í™”Â·ì‹¬í™”Â·ê²°ê³¼ë¬¼ ì™„ì„±" ë°©í–¥ìœ¼ë¡œ.
  ì„±ì·¨ê¸°ì¤€ êµê³¼ ì—°ê³„ ìš°ì„ , ì „ê³µ ì‹¬í™”ëŠ” ë³´ì¡°.
  {"title":"","concept":"1~2í•™ë…„ í™œë™ê³¼ì˜ ì—°ê²°ê³ ë¦¬ + ì§„ë¡œ ì—°ê³„ 2~3ë¬¸ì¥","steps":["ë‹¨ê³„1","ë‹¨ê³„2","ë‹¨ê³„3","ë‹¨ê³„4","ë‹¨ê³„5"],"record_points":"ê¸°ëŒ€ ì—­ëŸ‰ 2ë¬¸ì¥"}
- quarterly: 3ê°œ ë¶„ê¸°

6. counsel: ìƒë‹´ ê°€ì´ë“œ â€” âš ï¸ í¬ë§ ëŒ€í•™ì´ ìˆìœ¼ë©´ ë°˜ë“œì‹œ ì…ì‹œ ë¶„ì„ í¬í•¨!
- points: í•µì‹¬ 3ê°œ (ê° 1~2ë¬¸ì¥)
- grade_analysis: ì„±ì  ë¶„ì„ í¬ì¸íŠ¸ 2~3ê°œ (ê° 1~2ë¬¸ì¥)
  âš ï¸ ë°˜ë“œì‹œ í•™ê¸°ë³„ ë‚´ì‹  ì¶”ì´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ!
  ì˜ˆ: "1-1 â†’ 2-2 ì „ì²´êµê³¼ 4.2â†’3.5ë¡œ ê¾¸ì¤€íˆ ìƒìŠ¹", "ìˆ˜í•™ 5ë“±ê¸‰â†’3ë“±ê¸‰ ê¸‰ìƒìŠ¹, í•™ìŠµë²• ë³€í™” í™•ì¸ í•„ìš”"
  ì·¨ì•½ ê³¼ëª©, ìƒìŠ¹/í•˜ë½ ê³¼ëª©, 3í•™ë…„ ëª©í‘œ ë“±ê¸‰ í¬í•¨
- univ_analysis: ëŒ€í•™ ì…ì‹œ ë¶„ì„ (í¬ë§ ëŒ€í•™ì´ ìˆì„ ë•Œë§Œ, ì—†ìœ¼ë©´ ë¹ˆ ê°ì²´ {})
  âš ï¸ ë°˜ë“œì‹œ í•´ë‹¹ ëŒ€í•™Â·í•™ê³¼ì˜ ìµœì‹  ì…ì‹œ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒì„¸ ë¶„ì„!
  {
    "univ_name": "ëŒ€í•™ëª…",
    "major_name": "í•™ê³¼ëª…",
    "admission_type": "í•™ìƒë¶€ì¢…í•©ì „í˜• ì´ë¦„ (ì˜ˆ: ê°€ì²œë°”ëŒê°œë¹„1, ê²½ë¶ëŒ€ ì§€ì—­ì¸ì¬ ë“±)",
    "talent_profile": "ì´ ëŒ€í•™ì´ ì›í•˜ëŠ” ì¸ì¬ìƒ 2~3ë¬¸ì¥",
    "key_competencies": ["ì´ í•™ê³¼ê°€ ì¤‘ì‹œí•˜ëŠ” ì—­ëŸ‰ 3ê°œ"],
    "avg_grade": "ìµœê·¼ í•©ê²©ì í‰ê·  ë‚´ì‹  ë“±ê¸‰ëŒ€ (ì˜ˆ: 3.0~4.0ë“±ê¸‰)",
    "competition_rate": "ìµœê·¼ ê²½ìŸë¥  (ì˜ˆ: 5.2:1)",
    "fit_analysis": "ì´ í•™ìƒì˜ ìƒê¸°ë¶€ê°€ ì´ ëŒ€í•™ì— ì–¼ë§ˆë‚˜ ë§ëŠ”ì§€ 3~5ë¬¸ì¥ (ê°•ì /ì•½ì /ë³´ì™„ì  êµ¬ì²´ì ìœ¼ë¡œ)",
    "strategy": "í•©ê²©ì„ ìœ„í•œ 3í•™ë…„ ì „ëµ 3~5ë¬¸ì¥ (ë¬´ì—‡ì„ ë³´ì™„í•˜ê³  ë¬´ì—‡ì„ ê°•ì¡°í• ì§€)",
    "risk_factors": ["ì§€ì› ì‹œ ë¦¬ìŠ¤í¬ ìš”ì¸ 2~3ê°œ"],
    "alternative_majors": ["ê°™ì€ ëŒ€í•™ ë‚´ ëŒ€ì•ˆ í•™ê³¼ 1~2ê°œ (ì í•©ë„ ë†’ì€ ìˆœ)"]
  }
- curriculum_summary: êµê³¼+ìƒê¸°ë¶€ ì´ì •ë¦¬ 3~5ë¬¸ì¥
  âš ï¸ í¬ë§ ëŒ€í•™ ê´€ì ì—ì„œ ì´ í•™ìƒì˜ êµê³¼(ë‚´ì‹ ë“±ê¸‰+ì„¸íŠ¹)+ë¹„êµê³¼(ììœ¨/ì§„ë¡œ/ë™ì•„ë¦¬)ë¥¼ ì¢…í•© ì§„ë‹¨
  "ì´ í•™ìƒì€ [ëŒ€í•™]ì— ì§€ì›í•˜ê¸° ìœ„í•´ êµê³¼ì—ì„œëŠ” ~ì´ ê°•ì ì´ê³  ~ì´ ì•½ì ì´ë©°, ë¹„êµê³¼ì—ì„œëŠ” ~ì´ ì˜ ë˜ì–´ìˆê³  ~ì„ ë³´ì™„í•´ì•¼ í•œë‹¤"
- questions: ì§ˆë¬¸ 3ê°œ
- parent: í•™ë¶€ëª¨ ì „ë‹¬ 2ê°œ

[í•„ìˆ˜ ê·œì¹™]
- JSONë§Œ ì¶œë ¥ (ë°±í‹±/ì„¤ëª… ê¸ˆì§€)
- ë¹ˆ ë¬¸ìì—´ "" ê¸ˆì§€, ëª¨ë“  í•„ë“œ ì±„ìš¸ ê²ƒ
- ì¶œë ¥ ìˆœì„œ: student_info â†’ rating_matrix â†’ overview â†’ subject_analysis â†’ jarhaeng â†’ setuk â†’ club â†’ counsel
- âš ï¸ ëª¨ë“  ì„¹ì…˜ ë¹ ì§ì—†ì´ ì™„ì„±í•  ê²ƒ
- rating_matrix ë“±ê¸‰ì€ ë°˜ë“œì‹œ ëƒ‰ì •í•˜ê²Œ. Bë“±ê¸‰ì´ ê¸°ë³¸ì´ê³  S+ëŠ” ë§¤ìš° ë“œë¬¾.

[JSON êµ¬ì¡°]
{"student_info":{"name":"","grade":"","class_num":"","student_num":"","career_hope":"","club":"","naesin_all":0,"naesin_mss":0,"naesin_msn":0,"grade_trend":[{"semester":"1-1","all":0,"mss":0,"msn":0,"key_subjects":[{"name":"","grade":0}]},{"semester":"1-2","all":0,"mss":0,"msn":0,"key_subjects":[]},{"semester":"2-1","all":0,"mss":0,"msn":0,"key_subjects":[]},{"semester":"2-2","all":0,"mss":0,"msn":0,"key_subjects":[]}]},"rating_matrix":{"academic":{"jayul":"B","jinro":"B","subject":"B","club":"B"},"career":{"jayul":"B","jinro":"B","subject":"B","club":"B"},"community":{"jayul":"B","jinro":"B","subject":"B","club":"B"}},"overview":{"summary":"","change_analysis":"","grade3_direction":"","strengths":["","",""],"improvements":["",""],"gpa":0,"gpa_brief":"","tier":"","scores":{"academic":0,"career":0,"community":0},"score_brief":{"academic":"","career":"","community":""},"competencies":{"academic":{"grade1":"","grade2":"","growth":"","grade3_focus":""},"career":{"grade1":"","grade2":"","growth":"","grade3_focus":""},"community":{"grade1":"","grade2":"","growth":"","grade3_focus":""}},"keywords":[]},"subject_analysis":{"overall_grade":"","overall_score":0.0,"s_elements":"","a_elements":"","b_elements":"","c_elements":"","analysis":"","subject_cards":[{"name":"","grade":"","grade_num":"","summary":"","highlight":""}],"strong_subjects":[],"weak_subjects":[]},"jarhaeng":{"jayul":{"grade":"","evaluation":"","s_elements":"","a_elements":"","b_elements":"","c_elements":"","option1":{"title":"","text":"","focus":"","supplement":""},"option2":{"title":"","text":"","focus":"","supplement":""}},"jinro":{"grade":"","evaluation":"","s_elements":"","a_elements":"","b_elements":"","c_elements":"","option1":{"title":"","text":"","focus":"","supplement":""},"option2":{"title":"","text":"","focus":"","supplement":""}},"dongari":{"grade":"","evaluation":"","s_elements":"","a_elements":"","b_elements":"","c_elements":"","option1":{"title":"","text":"","focus":"","supplement":""},"option2":{"title":"","text":"","focus":"","supplement":""}},"hangbal":{"grade":"","evaluation":"","s_elements":"","a_elements":"","b_elements":"","c_elements":"","option1":{"title":"","text":"","focus":"","supplement":""},"option2":{"title":"","text":"","focus":"","supplement":""}}},"setuk":{"direction":"","subjects":[{"name":"","theme":"","reason":"","keywords":[]}]},"club":{"name":"","overview":"","goal":"","projects":[{"title":"","concept":"","steps":[],"record_points":""}],"quarterly":[{"quarter":"1ë¶„ê¸°(3~5ì›”)","focus":"","activities":"","record":""},{"quarter":"2ë¶„ê¸°(6~8ì›”)","focus":"","activities":"","record":""},{"quarter":"3ë¶„ê¸°(9~11ì›”)","focus":"","activities":"","record":""}]},"counsel":{"points":[],"grade_analysis":[],"univ_analysis":{},"curriculum_summary":"","questions":[],"parent":[]}}`}

// === v5.0: ì „ì—­ ë“±ê¸‰ ìƒ‰ìƒ í•¨ìˆ˜ (S+ ì§€ì›) ===
const GRADE_CLR=(g)=>({"S+":'var(--gold)',S:'var(--blue)',A:'var(--green)',B:'var(--orange)',C:'var(--coral)'}[g]||'var(--g3)');
const GRADE_BG=(g)=>({"S+":'var(--gold-bg)',S:'var(--blue-bg)',A:'var(--green-bg)',B:'var(--orange-bg)',C:'var(--coral-bg)'}[g]||'var(--g7)');

// === v5.0: rating_matrix â†’ ì ìˆ˜ ìë™ ê³„ì‚° ===
const GRADE_SCORE={"S+":5.0,"S":4.5,"A":4.0,"B":3.0,"C":2.0};
const AREA_WEIGHT={jayul:0.13,jinro:0.20,subject:0.55,club:0.12};

function calcFromMatrix(rm){
if(!rm)return null;
const caps=['academic','career','community'];
const areas=['jayul','jinro','subject','club'];
const scores={};
caps.forEach(cap=>{
let total=0,wSum=0;
areas.forEach(area=>{
const grade=(rm[cap]||{})[area]||'B';
const score=GRADE_SCORE[grade]||3.0;
const w=AREA_WEIGHT[area];
total+=score*w;wSum+=w;
});
scores[cap]=Math.round((total/wSum)*100)/100;
});
const gbGpa=Math.round(((scores.academic+scores.career+scores.community)/3)*100)/100;
return{scores,gbGpa};
}

function gradeToScore(g){
const map={1:5.0,2:4.5,3:4.0,4:3.5,5:3.0,6:2.5,7:2.0,8:1.5,9:1.0};
return map[Math.round(g)]||3.0;
}

function calcTotalGpa(gbGpa,naesinGrade){
if(!naesinGrade||naesinGrade<=0)return gbGpa;
const ns=gradeToScore(naesinGrade);
return Math.round((gbGpa*0.6+ns*0.4)*100)/100;
}

function getTier(t){
if(t>=4.9)return'ìµœìƒìœ„ê¶Œ (ì„œìš¸ëŒ€Â·ì˜ì•½í•™)';
if(t>=4.5)return'ìƒìœ„ê¶Œ (ì—°ê³ ëŒ€Â·ì„œì„±í•œ)';
if(t>=4.0)return'ì¸ì„œìš¸ ìƒìœ„ (ì¤‘ê²½ì™¸ì‹œÂ·í•œì–‘ëŒ€ê¸‰)';
if(t>=3.5)return'ì¸ì„œìš¸ ì¤‘í•˜ìœ„ / ì§€ê±°êµ­ ìƒìœ„';
if(t>=3.0)return'ì§€ê±°êµ­ í•˜ìœ„Â·ì§€ë°©ì‚¬ë¦½ ìƒìœ„ (ê²½ê³„ì„ )';
if(t>=2.5)return'ì§€ë°© ì‚¬ë¦½ ì¤‘ìœ„ (ì˜ë‚¨ëŒ€Â·ê³„ëª…ëŒ€ê¸‰)';
return'ì§€ë°© ì‚¬ë¦½ í•˜ìœ„ (êµê³¼ì „í˜• ê¶Œì¥)';
}

// === v5.0: ë‚´ì‹  3ì¹¸ ì…ë ¥ í—¬í¼ ===
function getNaesinData(){
const all=parseFloat(document.getElementById('sNaesinAll')?.value)||0;
const mss=parseFloat(document.getElementById('sNaesinMSS')?.value)||0;
const msn=parseFloat(document.getElementById('sNaesinMSN')?.value)||0;
const type=document.getElementById('sNaesinType')?.value||'all';
let selected=0;
if(type==='all')selected=all;
else if(type==='mss')selected=mss;
else if(type==='msn')selected=msn;
else if(type==='best'){
const vals=[all,mss,msn].filter(v=>v>0);
selected=vals.length?Math.min(...vals):0;
}
const typeLabel={all:'ì „ì²´êµê³¼',mss:'êµ­ì˜ìˆ˜ì‚¬',msn:'êµ­ì˜ìˆ˜ê³¼',best:'ìë™ìµœìœ ë¦¬'}[type]||'ì „ì²´êµê³¼';
return{all,mss,msn,type,typeLabel,selected};
}

function injectScores(o){
if(!o||!o.rating_matrix){console.warn('[injectScores] rating_matrix ì—†ìŒ');return;}
const calc=calcFromMatrix(o.rating_matrix);
if(!calc){console.warn('[injectScores] calcFromMatrix ì‹¤íŒ¨');return;}
if(!o.overview)o.overview={};
o.overview.scores={academic:calc.scores.academic,career:calc.scores.career,community:calc.scores.community};
o.overview._gbGpa=calc.gbGpa;
o.overview.gpa_gb=calc.gbGpa;
// gpaë„ ì—¬ê¸°ì„œ ê¸°ë³¸ ì„¤ì • (ë‚´ì‹  ë°˜ì˜ì€ ë‚˜ì¤‘ì— ë®ì–´ì”€)
if(!o.overview.gpa||o.overview.gpa<=0){
o.overview.gpa=calc.gbGpa;
o.overview.tier=getTier(calc.gbGpa);
o.overview.gpa_brief='ìƒê¸°ë¶€ í‰ì  '+calc.gbGpa.toFixed(1)+' ê¸°ë°˜. '+getTier(calc.gbGpa)+'.';
}
// score_brief ìë™ ìƒì„± (AIê°€ ì•ˆ ì¤¬ì„ ë•Œ)
if(!o.overview.score_brief||!o.overview.score_brief.academic){
const sb={};
['academic','career','community'].forEach(k=>{
const v=calc.scores[k];
sb[k]=v>=4.0?'ë§¤ìš° ìš°ìˆ˜':v>=3.5?'ìš°ìˆ˜':v>=3.0?'ë³´í†µ':v>=2.5?'ë³´ì™„ í•„ìš”':'ë¯¸í¡';
});
o.overview.score_brief=sb;
}
}

function pr(tx,nm,cr,cl,sid,kw){
function makeMeta(){return{nm,cr,cl,sid,kw,pri:[...pri],univ:document.getElementById('sUniv')?.value||'',major:document.getElementById('sMajor')?.value||'',dt:new Date().toLocaleDateString('ko-KR')}}

function cleanAndExtract(str){
str=str.replace(/```json\s*/gi,'').replace(/```\s*/gi,'').trim();
const s=str.indexOf('{'),e=str.lastIndexOf('}');
if(s<0||e<=s)return null;
return str.substring(s,e+1);
}

console.debug('[PR] len='+tx.length+' start='+tx.substring(0,150));

// 1ì°¨: ê¸°ë³¸ íŒŒì‹±
try{
let c=cleanAndExtract(tx);
if(c){
console.debug('[PR] JSON extracted, len='+c.length);
c=c.replace(/[\r\n\t]/g,' ').replace(/\s{2,}/g,' ');
const o=JSON.parse(c);o._m=makeMeta();injectScores(o);return o;
}else{console.debug('[PR] 1ì°¨: JSON ë¸”ë¡ ì—†ìŒ')}
}catch(e1){console.log('[PR] 1ì°¨ fail:',e1.message)}

// 2ì°¨: ì œì–´ë¬¸ì ì œê±° + ë¬¸ìì—´ ë‚´ ì¤„ë°”ê¿ˆ ì²˜ë¦¬
try{
let c=cleanAndExtract(tx);
if(c){
c=c.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,'');
let result='',inStr=false,prev='';
for(let i=0;i<c.length;i++){
const ch=c[i];
if(ch==='"'&&prev!=='\\')inStr=!inStr;
if(inStr&&(ch==='\n'||ch==='\r')){result+=' ';continue}
if(inStr&&ch==='\t'){result+=' ';continue}
result+=ch;prev=ch;
}
const o=JSON.parse(result);o._m=makeMeta();injectScores(o);return o;
}
}catch(e2){console.log('[PR] 2ì°¨ fail:',e2.message)}

// 3ì°¨: ëª¨ë“  ì¤„ë°”ê¿ˆ ê³µë°±ìœ¼ë¡œ
try{
let c=cleanAndExtract(tx);
if(c){
c=c.replace(/[\r\n\t]/g,' ').replace(/\s{2,}/g,' ').replace(/[\x00-\x1F\x7F]/g,'');
const o=JSON.parse(c);o._m=makeMeta();injectScores(o);return o;
}
}catch(e3){console.log('[PR] 3ì°¨ fail:',e3.message)}

// 4ì°¨: ë¶ˆì™„ì „ JSON ë³µêµ¬ (ì¤‘ê´„í˜¸ ê· í˜•)
try{
let c=cleanAndExtract(tx);
if(c){
c=c.replace(/[\r\n\t]/g,' ').replace(/\s{2,}/g,' ').replace(/[\x00-\x1F\x7F]/g,'');
// ì¤‘ê´„í˜¸/ëŒ€ê´„í˜¸ ê· í˜• ë§ì¶”ê¸°
let open=0,close=0,oA=0,cA=0;
for(const ch of c){if(ch==='{')open++;if(ch==='}')close++;if(ch==='[')oA++;if(ch===']')cA++;}
while(close<open){c+='}';close++}
while(cA<oA){c+=']';cA++}
// trailing comma ì œê±°
c=c.replace(/,\s*([}\]])/g,'$1');
const o=JSON.parse(c);o._m=makeMeta();injectScores(o);return o;
}
}catch(e4){console.log('[PR] 4ì°¨ fail:',e4.message)}

// 5ì°¨: ë¬¸ìì—´ ë‚´ ì¤„ë°”ê¿ˆì„ \\nìœ¼ë¡œ + ì¤‘ê´„í˜¸ ë³µêµ¬
try{
let c=cleanAndExtract(tx);
if(c){
c=c.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,'');
let r='',inS=false,p='';
for(let i=0;i<c.length;i++){
const ch=c[i];
if(ch==='"'&&p!=='\\')inS=!inS;
if(inS&&(ch==='\n'||ch==='\r')){r+=' ';continue}
if(inS&&ch==='\t'){r+=' ';continue}
r+=ch;p=ch;
}
r=r.replace(/,\s*([}\]])/g,'$1');
let ob=0,cb=0,oA=0,cA=0;
for(const ch of r){if(ch==='{')ob++;if(ch==='}')cb++;if(ch==='[')oA++;if(ch===']')cA++;}
while(cb<ob){r+='}';cb++}
while(cA<oA){r+=']';cA++}
const o=JSON.parse(r);o._m=makeMeta();injectScores(o);return o;
}
}catch(e5){console.log('[PR] 5ì°¨ fail:',e5.message)}

console.log('[PR] ëª¨ë“  íŒŒì‹± ì‹¤íŒ¨. Raw ì• 500ì:', tx.substring(0,500));

return{_m:makeMeta(),_raw:tx,_err:true};
}

// === ë‚´ì‹  ì¶”ì´ ê·¸ë˜í”„ ===
function drawGradeTrend(gt){
const cvs=document.getElementById('gradeTrendChart');
if(!cvs||!gt||!gt.length)return;
const ctx=cvs.getContext('2d');
const W=cvs.width,H=cvs.height;
const pad={t:30,r:30,b:35,l:45};
const pw=W-pad.l-pad.r,ph=H-pad.t-pad.b;

ctx.clearRect(0,0,W,H);

// ë°ì´í„° ì¤€ë¹„
const labels=gt.map(s=>s.semester);
const series=[
{key:'all',label:'ì „ì²´êµê³¼',color:'#3182F6',data:gt.map(s=>s.all||0)},
{key:'mss',label:'êµ­ì˜ìˆ˜ì‚¬',color:'#7B61FF',data:gt.map(s=>s.mss||0)},
{key:'msn',label:'êµ­ì˜ìˆ˜ê³¼',color:'#22B8CF',data:gt.map(s=>s.msn||0)}
].filter(s=>s.data.some(v=>v>0));

if(!series.length)return;

// Yì¶•: ë“±ê¸‰ (1=ìµœìƒìœ„, 9=ìµœí•˜ìœ„) â†’ ìœ„ê°€ 1, ì•„ë˜ê°€ 9
const allVals=series.flatMap(s=>s.data).filter(v=>v>0);
const minG=Math.max(1,Math.floor(Math.min(...allVals))-0.5);
const maxG=Math.min(9,Math.ceil(Math.max(...allVals))+0.5);
const yRange=maxG-minG||1;

function toX(i){return pad.l+i*(pw/(labels.length-1||1))}
function toY(v){return pad.t+(v-minG)/yRange*ph}

// ê·¸ë¦¬ë“œ
ctx.strokeStyle='#E5E8EB';ctx.lineWidth=0.5;
for(let g=Math.ceil(minG);g<=Math.floor(maxG);g++){
const y=toY(g);
ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();
ctx.fillStyle='#8B95A1';ctx.font='11px -apple-system,sans-serif';ctx.textAlign='right';
ctx.fillText(g+'ë“±ê¸‰',pad.l-6,y+4);
}

// Xì¶• ë¼ë²¨
ctx.fillStyle='#4E5968';ctx.font='bold 11px -apple-system,sans-serif';ctx.textAlign='center';
labels.forEach((l,i)=>{ctx.fillText(l,toX(i),H-pad.b+20)});

// ì„  ê·¸ë¦¬ê¸°
series.forEach(s=>{
const pts=s.data.map((v,i)=>({x:toX(i),y:toY(v),v})).filter(p=>p.v>0);
if(pts.length<2)return;

// ì„ 
ctx.strokeStyle=s.color;ctx.lineWidth=2.5;ctx.lineJoin='round';
ctx.beginPath();pts.forEach((p,i)=>{i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y)});ctx.stroke();

// ì  + ê°’
pts.forEach(p=>{
ctx.fillStyle='white';ctx.beginPath();ctx.arc(p.x,p.y,5,0,Math.PI*2);ctx.fill();
ctx.strokeStyle=s.color;ctx.lineWidth=2;ctx.beginPath();ctx.arc(p.x,p.y,5,0,Math.PI*2);ctx.stroke();
ctx.fillStyle=s.color;ctx.font='bold 10px -apple-system,sans-serif';ctx.textAlign='center';
ctx.fillText(p.v.toFixed(1),p.x,p.y-10);
});
});

// ë²”ë¡€
const leg=document.getElementById('gradeTrendLegend');
if(leg)leg.innerHTML=series.map(s=>`<span style="display:flex;align-items:center;gap:4px"><span style="width:12px;height:3px;background:${s.color};border-radius:2px"></span><span style="color:${s.color};font-weight:600">${s.label}</span></span>`).join('');

// ì£¼ìš” ê³¼ëª© ìƒì„¸
const det=document.getElementById('gradeTrendDetail');
if(det&&gt.some(s=>(s.key_subjects||[]).length)){
det.innerHTML=`<div style="display:grid;grid-template-columns:repeat(${gt.length},1fr);gap:6px;margin-top:6px">
${gt.map(s=>`<div style="padding:8px;background:var(--g7);border-radius:8px">
<div style="font-size:10px;font-weight:700;color:var(--g3);margin-bottom:4px">${s.semester}</div>
${(s.key_subjects||[]).map(k=>{
const gc=k.grade<=2?'#3182F6':k.grade<=4?'#22B8CF':k.grade<=6?'#FF9F43':'#FF6B6B';
return`<div style="display:flex;justify-content:space-between;font-size:10px;margin:2px 0"><span>${k.name}</span><span style="font-weight:800;color:${gc}">${k.grade}</span></div>`}).join('')}
</div>`).join('')}
</div>`;
}
}

function rR(r){document.getElementById('resS').style.display='block';
var _tna=document.getElementById('teacherNoteArea');if(_tna)_tna.style.display='';
if(r._err){
const raw=r._raw||'';
const hasJson=raw.includes('{')&&raw.includes('}');
document.getElementById('tc-ov').innerHTML=`<div class="rb"><h4>âš  íŒŒì‹± ì‹¤íŒ¨</h4>
<p style="margin:8px 0;font-size:13px;color:var(--g2)">${hasJson?'JSON êµ¬ì¡°ê°€ ì†ìƒë˜ì—ˆìŠµë‹ˆë‹¤.':'AIê°€ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'}</p>
<p style="margin:8px 0;font-size:12px;color:var(--g3)">ğŸ’¡ âš™ï¸ â†’ "ì „ì²´ ì´ˆê¸°í™”" í›„ ê°™ì€ PDFë¡œ ì¬ë¶„ì„í•´ë³´ì„¸ìš”.</p>
<details><summary style="cursor:pointer;font-size:12px;color:var(--blue);font-weight:600">AI ì›ë³¸ ì‘ë‹µ ë³´ê¸° (${raw.length}ì)</summary>
<pre style="white-space:pre-wrap;font-size:11px;color:var(--g3);max-height:400px;overflow-y:auto;margin-top:8px;padding:12px;background:var(--g7);border-radius:8px">${esc(raw)}</pre></details></div>`;return}
const m=r._m,ov=r.overview||{},cp=ov.competencies||{},sc=ov.scores||{},sb=ov.score_brief||{},sa=r.subject_analysis||{};
const gbGpa=ov.gpa_gb||ov._gbGpa||0;
const gpa=ov.gpa||gbGpa||0;
const gradeClr=GRADE_CLR;
const gradeBg=GRADE_BG;
const gbGpaClr=gbGpa>=4.0?'#3182F6':gbGpa>=3.5?'#22B8CF':gbGpa>=3.0?'#FF9F43':'#FF6B6B';
const gpaClr=gpa>=4.0?'#3182F6':gpa>=3.5?'#22B8CF':gpa>=3.0?'#FF9F43':'#FF6B6B';
const kwds=ov.keywords||m.kw||[];
const rm=r.rating_matrix;
const tierEmoji=gpa>=4.5?'ğŸ†':gpa>=4.0?'â­':gpa>=3.5?'ğŸ’':gpa>=3.0?'ğŸ“ˆ':'ğŸ“Š';

// ====== ì¢…í•© íƒ­ (í° ê·¸ë¦¼ë§Œ, ì„¸ì„¸í•œ êµê³¼ë¶„ì„ì€ êµê³¼ì„¸íŠ¹ íƒ­ìœ¼ë¡œ) ======
document.getElementById('tc-ov').innerHTML=`
<div style="background:linear-gradient(135deg,#EBF4FF 0%,#F0EDFF 50%,#E3FAFC 100%);border-radius:16px;padding:28px;margin-bottom:16px">
<div style="display:flex;gap:24px;flex-wrap:wrap;align-items:start">
<div style="flex:1;min-width:240px">
<h4 style="font-size:22px;margin-bottom:6px">${m.nm}</h4>
<p style="font-size:13px;color:var(--g2);margin-bottom:4px">${m.sid} Â· í¬ë§ì§„ë¡œ: ${m.cr}</p>
${m.univ||m.major?`<p style="font-size:13px;color:#7B61FF;font-weight:700;margin-bottom:8px">ğŸ“ ${m.univ||''} ${m.major||''}</p>`:''}
<div style="display:flex;flex-wrap:wrap;gap:6px;margin:12px 0">${kwds.map(k=>`<span class="badge b-bl" style="font-size:12px;padding:4px 10px">#${k}</span>`).join('')}</div>
<p style="font-size:13px;color:var(--g1);line-height:1.8;margin-top:12px">${ov.summary||''}</p>
</div>
<div style="min-width:240px;max-width:320px">
<div style="background:white;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,0.06);overflow:hidden;margin-bottom:12px">
<div style="display:flex">
<div style="flex:1;text-align:center;padding:16px 12px;border-right:1px solid var(--g6)">
<p style="font-size:10px;font-weight:700;color:var(--g3);margin-bottom:4px">ìƒê¸°ë¶€ í‰ì </p>
<p style="font-size:28px;font-weight:900;color:${gbGpaClr};line-height:1">${gbGpa>0?gbGpa.toFixed(1):'-'}</p>
</div>
<div style="flex:1;text-align:center;padding:16px 12px">
<p style="font-size:10px;font-weight:700;color:var(--g3);margin-bottom:4px">ì¢…í•© í‰ì </p>
<p style="font-size:28px;font-weight:900;color:${gpaClr};line-height:1">${gpa>0?gpa.toFixed(1):'-'}</p>
</div>
</div>
${ov.naesin>0?`<div style="text-align:center;padding:6px;background:var(--g7);font-size:10px;color:var(--g3)">ë‚´ì‹  ${ov.naesinType||''} ${ov.naesin.toFixed(1)}ë“±ê¸‰ ë°˜ì˜</div>`:''}
<div style="text-align:center;padding:10px;background:${gpaClr}15;border-top:1px solid var(--g6)">
<p style="font-size:13px;font-weight:800;color:${gpaClr}">${tierEmoji} ${ov.tier||''}</p>
</div>
</div>
<div style="background:white;border-radius:12px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,0.04)">
<p style="font-size:11px;font-weight:700;color:var(--g2);margin-bottom:10px">3ëŒ€ ì—­ëŸ‰</p>
${[{k:'academic',l:'í•™ì—…',e:'ğŸ“š',c:'#3182F6'},{k:'career',l:'ì§„ë¡œ',e:'ğŸ¯',c:'#7B61FF'},{k:'community',l:'ê³µë™ì²´',e:'ğŸ¤',c:'#22B8CF'}].map(x=>{
const v=sc[x.k]||0;const pct=Math.min(v/5*100,100);
return`<div style="margin-bottom:8px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px">
<span style="font-size:11px;font-weight:700">${x.e} ${x.l}</span>
<span style="font-size:14px;font-weight:900;color:${x.c}">${v}</span>
</div>
<div style="height:6px;background:var(--g6);border-radius:3px;overflow:hidden"><div style="width:${pct}%;height:100%;background:${x.c};border-radius:3px;transition:width .5s"></div></div>
<p style="font-size:9px;color:var(--g4);margin-top:2px">${sb[x.k]||''}</p>
</div>`}).join('')}
</div>
</div>
</div>
</div>
<div style="margin-bottom:16px">
<div onclick="this.querySelector('.guide-body').style.display=this.querySelector('.guide-body').style.display==='none'?'block':'none';this.querySelector('.guide-arrow').textContent=this.querySelector('.guide-body').style.display==='none'?'â–¶':'â–¼'" style="cursor:pointer;padding:12px 16px;background:white;border-radius:12px;border:1.5px solid #E5E8EB;display:flex;align-items:center;gap:8px">
<span style="font-size:14px">ğŸ“–</span>
<span style="font-size:13px;font-weight:700;color:var(--g1)">í‰ê°€ ê¸°ì¤€ ì•ˆë‚´</span>
<span class="guide-arrow" style="font-size:10px;color:var(--g4);margin-left:auto">â–¶</span>
</div>
<div class="guide-body" style="display:none;padding:16px;background:white;border-radius:0 0 12px 12px;border:1.5px solid #E5E8EB;border-top:none;margin-top:-2px">

<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">
<div style="padding:12px;background:#EBF4FF;border-radius:10px">
<div style="font-size:11px;font-weight:800;color:#3182F6;margin-bottom:8px">ğŸ“Š ë“±ê¸‰ ì²´ê³„</div>
<div style="display:flex;gap:4px;flex-wrap:wrap">
${[{g:'S+',s:'5.0',c:'var(--gold)',bg:'var(--gold-bg)'},{g:'S',s:'4.5',c:'var(--blue)',bg:'var(--blue-bg)'},{g:'A',s:'4.0',c:'var(--green)',bg:'var(--green-bg)'},{g:'B',s:'3.0',c:'var(--orange)',bg:'var(--orange-bg)'},{g:'C',s:'2.0',c:'var(--coral)',bg:'var(--coral-bg)'}].map(x=>`<span style="padding:3px 8px;border-radius:6px;font-size:10px;font-weight:800;background:${x.bg};color:${x.c}">${x.g}(${x.s})</span>`).join('')}
</div>
<p style="font-size:10px;color:var(--g3);margin-top:6px;line-height:1.5">Bê°€ ê¸°ë³¸ ë“±ê¸‰. S+ëŠ” ìµœìƒìœ„ ëŒ€í•™ í•©ê²©ìƒ ìˆ˜ì¤€ìœ¼ë¡œ ë§¤ìš° ë“œë­„.</p>
</div>
<div style="padding:12px;background:#F0EDFF;border-radius:10px">
<div style="font-size:11px;font-weight:800;color:#7B61FF;margin-bottom:8px">ğŸ§® Rating Matrix</div>
<p style="font-size:10px;color:var(--g2);line-height:1.6">4ê°œ ì˜ì—­(ììœ¨Â·ì§„ë¡œÂ·êµê³¼ì„¸íŠ¹Â·ë™ì•„ë¦¬) Ã— 3ê°œ ì—­ëŸ‰(í•™ì—…Â·ì§„ë¡œÂ·ê³µë™ì²´) = <strong>12ì¹¸</strong> ë“±ê¸‰ ë§¤íŠ¸ë¦­ìŠ¤.<br>ê°€ì¤‘ì¹˜: êµê³¼ì„¸íŠ¹(55%) > ì§„ë¡œ(20%) > ììœ¨(13%) > ë™ì•„ë¦¬(12%)</p>
</div>
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">
<div style="padding:12px;background:#E3FAFC;border-radius:10px">
<div style="font-size:11px;font-weight:800;color:#22B8CF;margin-bottom:8px">ğŸ“ˆ ì´ì¤‘ í‰ì </div>
<p style="font-size:10px;color:var(--g2);line-height:1.6"><strong>ìƒê¸°ë¶€ í‰ì </strong> = Rating Matrix ê°€ì¤‘í•©ì‚° (í™œë™ ê¸°ë¡ë§Œ)<br><strong>ì¢…í•© í‰ì </strong> = ìƒê¸°ë¶€(60%) + ë‚´ì‹ (40%)<br>ë‚´ì‹ ì´ ì¢‹ìœ¼ë©´ ì¢…í•© í‰ì ì´ ì˜¬ë¼ê°€ê³ , ë‚˜ì˜ë©´ ë‚´ë ¤ê°.</p>
</div>
<div style="padding:12px;background:#FFF8F0;border-radius:10px">
<div style="font-size:11px;font-weight:800;color:#FF9F43;margin-bottom:8px">ğŸ† í‹°ì–´ ê¸°ì¤€</div>
<div style="font-size:10px;color:var(--g2);line-height:1.7">
4.5+ ìµœìƒìœ„ê¶Œ (ì„œìš¸ ìƒìœ„ 10ê°œêµ)<br>
4.0+ ì¸ì„œìš¸ ìƒìœ„ (ì„œìš¸ ì¤‘ìƒìœ„ê¶Œ)<br>
3.5+ ì§€ê±°êµ­ ìƒìœ„ (ê±°ì êµ­ë¦½ëŒ€)<br>
3.0+ ì¤‘ìœ„ê¶Œ (ì§€ë°© êµ­ë¦½/ì‚¬ë¦½)<br>
3.0â†“ í•˜ìœ„ê¶Œ
</div>
</div>
</div>

<div style="padding:10px 12px;background:var(--g7);border-radius:8px;font-size:10px;color:var(--g3);line-height:1.6">
ğŸ’¡ <strong>ì°¸ê³ :</strong> ë“±ê¸‰ê³¼ ì ìˆ˜ëŠ” ì‹¤ì œ í•©ê²© ì‚¬ë¡€(í•œì–‘ëŒ€/ê²½ë¶ëŒ€/ë‹¨êµ­ëŒ€ ìƒê¸°ë¶€)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì„¤ì •ëœ ê¸°ì¤€ì´ë©°, í•™ìƒì˜ ìƒê¸°ë¶€ í…ìŠ¤íŠ¸ë¥¼ AIê°€ ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤. ì ˆëŒ€ì  ì…ì‹œ ê²°ê³¼ë¥¼ ë³´ì¥í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì°¸ê³  ìë£Œë¡œ í™œìš©í•˜ì„¸ìš”.
</div>
</div>
</div>
${rm?`<div class="rb">
<h4>ğŸ“Š Rating Matrix â€” ì˜ì—­Ã—ì—­ëŸ‰ ë“±ê¸‰</h4>
<p style="font-size:11px;color:var(--g3);margin-bottom:10px">êµê³¼ì„¸íŠ¹(55%) > ì§„ë¡œ(20%) > ììœ¨(13%) > ë™ì•„ë¦¬(12%) ê°€ì¤‘ ë°˜ì˜</p>
<table class="tbl" style="text-align:center;font-size:13px;border-collapse:collapse">
<thead><tr><th style="text-align:left;padding:12px">ì—­ëŸ‰</th>${[{l:'ììœ¨'},{l:'ì§„ë¡œ'},{l:'êµê³¼ì„¸íŠ¹'},{l:'ë™ì•„ë¦¬'}].map(a=>`<th style="padding:12px">${a.l}</th>`).join('')}<th style="padding:12px;background:var(--g7)">ì¢…í•© ì ìˆ˜</th></tr></thead>
<tbody>${[{k:'academic',l:'ğŸ“š í•™ì—…'},{k:'career',l:'ğŸ¯ ì§„ë¡œ'},{k:'community',l:'ğŸ¤ ê³µë™ì²´'}].map(c=>{
const capScore=sc[c.k]||0;
const scoreClr=capScore>=4.0?'#3182F6':capScore>=3.5?'#22B8CF':capScore>=3.0?'#FF9F43':'#FF6B6B';
return`<tr><td style="font-weight:800;font-size:12px;text-align:left;padding:12px">${c.l}</td>${['jayul','jinro','subject','club'].map(a=>{
const g=(rm[c.k]||{})[a]||'B';
return`<td style="background:${gradeBg(g)};color:${gradeClr(g)};font-weight:900;padding:14px 8px;font-size:16px">${g}</td>`;
}).join('')}<td style="font-weight:900;font-size:16px;color:${scoreClr};background:${scoreClr}11;padding:14px 8px">${capScore.toFixed(1)}</td></tr>`}).join('')}
</tbody></table>
<div style="text-align:right;margin-top:8px;font-size:12px"><strong>ìƒê¸°ë¶€ í‰ì : </strong><span style="font-size:16px;font-weight:900;color:${gbGpaClr}">${gbGpa>0?gbGpa.toFixed(1):'-'}</span><span style="font-size:11px;color:var(--g3)"> / 5.0</span></div>
</div>`:''}
<div class="rb" id="gradeTrendBox" style="display:none">
<h4>ğŸ“ˆ ë‚´ì‹  ë“±ê¸‰ ì¶”ì´</h4>
<canvas id="gradeTrendChart" width="680" height="260" style="width:100%;max-height:260px"></canvas>
<div id="gradeTrendLegend" style="display:flex;gap:16px;justify-content:center;margin-top:8px;font-size:11px"></div>
<div id="gradeTrendDetail" style="margin-top:10px"></div>
</div>
${ov.change_analysis?`<div class="rb" style="border-left:4px solid #7B61FF"><h4>ğŸ”„ 1â†’2í•™ë…„ ë³€í™”</h4><p style="line-height:1.8">${ov.change_analysis}</p></div>`:''}
${ov.grade3_direction?`<div class="rb" style="border-left:4px solid #3182F6"><h4>ğŸ¯ 3í•™ë…„ ì „ëµ ë°©í–¥</h4><p style="line-height:1.8">${ov.grade3_direction}</p></div>`:''}
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
<div class="rb"><h4>ğŸ’ª ê°•ì </h4>${(ov.strengths||[]).map(s=>`<p style="margin:4px 0;font-size:13px;line-height:1.7"><span style="color:#00C471;font-weight:800">âœ¦</span> ${s}</p>`).join('')}</div>
<div class="rb"><h4>ğŸ“Œ ë³´ì™„ì </h4>${(ov.improvements||[]).map(s=>`<p style="margin:4px 0;font-size:13px;line-height:1.7"><span style="color:#FF6B6B;font-weight:800">â†’</span> ${s}</p>`).join('')}</div>
</div>
<div class="rb">
<h4>ğŸ“Š 3ëŒ€ ì—­ëŸ‰ ìš”ì•½</h4>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
${[{k:'academic',l:'ğŸ“š í•™ì—…',c:'#3182F6'},{k:'career',l:'ğŸ¯ ì§„ë¡œ',c:'#7B61FF'},{k:'community',l:'ğŸ¤ ê³µë™ì²´',c:'#22B8CF'}].map(x=>{
const c=cp[x.k]||{};const v=sc[x.k]||0;
return`<div style="padding:14px;border-radius:12px;border:1.5px solid ${x.c}33;background:${x.c}08">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<span style="font-size:13px;font-weight:800;color:${x.c}">${x.l}</span>
<span style="font-size:18px;font-weight:900;color:${x.c}">${v.toFixed?v.toFixed(1):v}</span>
</div>
<p style="font-size:11px;line-height:1.6;color:var(--g2)">${c.growth||sb[x.k]||''}</p>
<p style="font-size:10px;color:${x.c};font-weight:600;margin-top:4px">${c.grade3_focus?'â†’ '+c.grade3_focus:''}</p>
</div>`}).join('')}
</div>
<p style="text-align:right;font-size:11px;color:var(--g4);margin-top:8px">ğŸ’¬ í•™ë…„ë³„ ìƒì„¸ ë¶„ì„ì€ <strong>ìƒë‹´</strong> íƒ­ì—ì„œ í™•ì¸</p>
</div>`;

// ====== ë‚´ì‹  ì¶”ì´ ê·¸ë˜í”„ ======
const gt=r.student_info?.grade_trend||[];
if(gt.length>0&&gt.some(s=>s.all>0)){
document.getElementById('gradeTrendBox').style.display='block';
setTimeout(()=>drawGradeTrend(gt),100);
}else{document.getElementById('gradeTrendBox').style.display='none';}

// ====== ê¸°ì¬ì˜ˆì‹œ íƒ­ (ììœ¨/ì§„ë¡œ/í–‰ë°œë§Œ, ë™ì•„ë¦¬ ì œì™¸) ======
document.getElementById('tc-jh').innerHTML=rJH(r.jarhaeng||{});

// ====== êµê³¼ì„¸íŠ¹ íƒ­ (ì „ë°˜ ë¶„ì„ + ê³¼ëª©ì¹´ë“œ + 3í•™ë…„ ì œì•ˆ í†µí•©) ======
const se=r.setuk||{};
document.getElementById('tc-se').innerHTML=`
${sa.analysis?`<div class="rb" style="border-left:4px solid ${gradeClr(sa.overall_grade)}">
<h4>ğŸ“˜ êµê³¼ì„¸íŠ¹ ì „ë°˜ ë¶„ì„ <span class="badge" style="background:${gradeBg(sa.overall_grade)};color:${gradeClr(sa.overall_grade)};font-size:13px;padding:4px 12px;margin-left:8px">${sa.overall_grade}ë“±ê¸‰</span><span style="font-size:15px;font-weight:800;color:${gradeClr(sa.overall_grade)};margin-left:6px">${sa.overall_score||''}</span></h4>
<p style="margin:10px 0;line-height:1.8;font-size:13px">${sa.analysis||''}</p>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin:14px 0">
${[{g:'S',c:'var(--blue)',bg:'var(--blue-bg)',t:sa.s_elements},{g:'A',c:'var(--green)',bg:'var(--green-bg)',t:sa.a_elements},{g:'B',c:'var(--orange)',bg:'var(--orange-bg)',t:sa.b_elements},{g:'C',c:'var(--coral)',bg:'var(--coral-bg)',t:sa.c_elements}].map(x=>`<div style="text-align:center;padding:12px;background:${x.bg};border-radius:10px"><div style="font-size:20px;font-weight:900;color:${x.c}">${x.g}</div><div style="font-size:10px;font-weight:700;color:${x.c}">${x.g}ë“±ê¸‰</div></div>`).join('')}
</div>
${sa.s_elements?`<div style="padding:10px 14px;background:var(--blue-bg);border-radius:10px;margin:6px 0;font-size:12px;line-height:1.7"><strong style="color:var(--blue)">Së“±ê¸‰ ìš”ì†Œ:</strong> ${sa.s_elements}</div>`:''}
${sa.a_elements?`<div style="padding:10px 14px;background:var(--green-bg);border-radius:10px;margin:6px 0;font-size:12px;line-height:1.7"><strong style="color:var(--green)">Aë“±ê¸‰ ìš”ì†Œ:</strong> ${sa.a_elements}</div>`:''}
${sa.b_elements?`<div style="padding:10px 14px;background:var(--orange-bg);border-radius:10px;margin:6px 0;font-size:12px;line-height:1.7"><strong style="color:var(--orange)">Bë“±ê¸‰ ìš”ì†Œ:</strong> ${sa.b_elements}</div>`:''}
${sa.c_elements?`<div style="padding:10px 14px;background:var(--coral-bg);border-radius:10px;margin:6px 0;font-size:12px;line-height:1.7"><strong style="color:var(--coral)">Cë“±ê¸‰ ìš”ì†Œ:</strong> ${sa.c_elements}</div>`:''}
<div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:10px">
${(sa.strong_subjects||[]).length?`<div><span style="font-size:11px;font-weight:700;color:var(--green)">âœ¦ ìš°ìˆ˜:</span> ${(sa.strong_subjects||[]).map(s=>`<span class="badge b-gr" style="margin:2px">${s}</span>`).join('')}</div>`:''}
${(sa.weak_subjects||[]).length?`<div><span style="font-size:11px;font-weight:700;color:var(--coral)">â†’ ë³´ì™„:</span> ${(sa.weak_subjects||[]).map(s=>`<span class="badge b-co" style="margin:2px">${s}</span>`).join('')}</div>`:''}
</div>
</div>`:''}
${(sa.subject_cards||[]).length?`<div class="rb"><h4>ğŸ“‹ ê³¼ëª©ë³„ ë¶„ì„</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:10px;margin-top:12px">${(sa.subject_cards||[]).map(c=>{
const gc=gradeClr(c.grade),gb=gradeBg(c.grade);
return`<div style="padding:14px;border-radius:12px;border:1.5px solid ${gc};background:${gb}">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
<strong style="font-size:13px">${c.name}</strong>
<span style="font-size:11px;font-weight:800;color:${gc};padding:2px 8px;background:rgba(255,255,255,0.7);border-radius:100px">${c.grade}ë“±ê¸‰${c.grade_num?' Â· '+c.grade_num+'í•™ë…„':''}</span>
</div>
<p style="font-size:11px;color:var(--g1);line-height:1.6">${c.summary||''}</p>
${c.highlight?`<p style="font-size:10px;color:${gc};font-weight:600;margin-top:4px">âœ¦ ${c.highlight}</p>`:''}</div>`}).join('')}</div>
</div>`:''}
${se.direction?`<div class="rb" style="border-left:4px solid #3182F6;background:linear-gradient(135deg,#FAFBFF,#EBF4FF)">
<h4>ğŸ¯ 3í•™ë…„ ì„¸íŠ¹ ì „ëµ</h4>
<p style="margin:8px 0;line-height:1.8;font-size:13px">${se.direction}</p>
</div>`:''}
${(se.subjects||[]).length?`<div class="rb"><h4>ğŸ“˜ 3í•™ë…„ ì„¸íŠ¹ ì œì•ˆ (${(se.subjects||[]).length}ê³¼ëª©)</h4>
<div style="display:grid;gap:12px;margin-top:10px">${(se.subjects||[]).map((s,i)=>{
const clrs=['#3182F6','#7B61FF','#22B8CF','#FF9F43'];
const c=clrs[i%4];
return`<div style="padding:16px;border-radius:12px;border:2px solid ${c}33;background:${c}08">
<div style="font-size:14px;font-weight:800;color:${c};margin-bottom:6px">ğŸ“˜ ${s.name}</div>
<p style="font-size:12px;line-height:1.7;margin-bottom:6px"><strong>ì£¼ì œ:</strong> ${s.theme||''}</p>
<p style="font-size:12px;line-height:1.7;margin-bottom:6px"><strong>ì´ìœ :</strong> ${s.reason||''}</p>
<div style="display:flex;flex-wrap:wrap;gap:4px">${(s.keywords||[]).map(k=>`<span class="badge b-bl" style="font-size:10px">${k}</span>`).join('')}</div>
</div>`}).join('')}</div>
</div>`:''}`;

// ====== ë™ì•„ë¦¬ íƒ­ (ë“±ê¸‰ë¶„ì„ + ê¸°ì¬ì˜ˆì‹œ + í”„ë¡œì íŠ¸) ======
const cl=r.club||{};
const clubItems=cl.quarterly||cl.monthly||[];
const jhDongari=r.jarhaeng?.dongari||{};
const jhDo1=jhDongari.option1||{},jhDo2=jhDongari.option2||{};
const dgHasEl=jhDongari.s_elements||jhDongari.a_elements||jhDongari.b_elements||jhDongari.c_elements;
document.getElementById('tc-cl').innerHTML=`
${jhDongari.evaluation?`<div class="rb" style="border-left:4px solid ${gradeClr(jhDongari.grade)||'#7B61FF'}">
<h4>ğŸ« ë™ì•„ë¦¬í™œë™ <span class="badge" style="background:${gradeBg(jhDongari.grade)};color:${gradeClr(jhDongari.grade)};font-size:13px;padding:4px 12px">${jhDongari.grade||'?'}ë“±ê¸‰</span> <span class="badge b-gy">1500B</span></h4>
<p style="margin:10px 0;line-height:1.85;font-size:13px">${jhDongari.evaluation}</p>
${dgHasEl?`<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;margin:12px 0">
${[{g:'S',c:'var(--blue)',bg:'var(--blue-bg)'},{g:'A',c:'var(--green)',bg:'var(--green-bg)'},{g:'B',c:'var(--orange)',bg:'var(--orange-bg)'},{g:'C',c:'var(--coral)',bg:'var(--coral-bg)'}].map(x=>`<div style="text-align:center;padding:10px;background:${x.bg};border-radius:8px"><div style="font-size:18px;font-weight:900;color:${x.c}">${x.g}</div><div style="font-size:9px;font-weight:700;color:${x.c}">${x.g}ë“±ê¸‰</div></div>`).join('')}
</div>
${jhDongari.s_elements?`<div style="padding:8px 12px;background:var(--blue-bg);border-radius:8px;margin:4px 0;font-size:11px;line-height:1.7"><strong style="color:var(--blue)">Së“±ê¸‰:</strong> ${jhDongari.s_elements}</div>`:''}
${jhDongari.a_elements?`<div style="padding:8px 12px;background:var(--green-bg);border-radius:8px;margin:4px 0;font-size:11px;line-height:1.7"><strong style="color:var(--green)">Aë“±ê¸‰:</strong> ${jhDongari.a_elements}</div>`:''}
${jhDongari.b_elements?`<div style="padding:8px 12px;background:var(--orange-bg);border-radius:8px;margin:4px 0;font-size:11px;line-height:1.7"><strong style="color:var(--orange)">Bë“±ê¸‰:</strong> ${jhDongari.b_elements}</div>`:''}
${jhDongari.c_elements?`<div style="padding:8px 12px;background:var(--coral-bg);border-radius:8px;margin:4px 0;font-size:11px;line-height:1.7"><strong style="color:var(--coral)">Cë“±ê¸‰:</strong> ${jhDongari.c_elements}</div>`:''}
`:''}
${jhDo1.text||jhDo2.text?`<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
<div style="background:#FAFCFF;border-radius:12px;padding:16px;border:1.5px solid #3182F633">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span class="badge b-bl" style="font-size:12px;padding:4px 14px">ì•ˆì „í˜•(A)</span><span style="font-size:11px;color:var(--g3);font-weight:600">${bl(jhDo1.text||'')}/1500B</span></div>
<div style="font-weight:700;font-size:13px;margin-bottom:8px">${jhDo1.title||''}</div>
<div style="font-size:12px;line-height:1.8">${jhDo1.text||''}</div>
<div style="margin-top:10px;padding:8px 12px;background:white;border-radius:8px;font-size:11px;line-height:1.6">âœ“ ${jhDo1.focus||''}<br>â†’ ${jhDo1.supplement||''}</div>
</div>
<div style="background:#FCFAFF;border-radius:12px;padding:16px;border:1.5px solid #7B61FF33">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span class="badge b-pu" style="font-size:12px;padding:4px 14px">ë„ì „í˜•(S)</span><span style="font-size:11px;color:var(--g3);font-weight:600">${bl(jhDo2.text||'')}/1500B</span></div>
<div style="font-weight:700;font-size:13px;margin-bottom:8px">${jhDo2.title||''}</div>
<div style="font-size:12px;line-height:1.8">${jhDo2.text||''}</div>
<div style="margin-top:10px;padding:8px 12px;background:white;border-radius:8px;font-size:11px;line-height:1.6">âœ“ ${jhDo2.focus||''}<br>â†’ ${jhDo2.supplement||''}</div>
</div>
</div>`:''}
</div>`:''}
${cl.overview?`<div class="rb"><h4>ğŸ“‹ ë™ì•„ë¦¬ ì „ë°˜ ë¶„ì„</h4><p style="line-height:1.8">${cl.overview}</p></div>`:''}
<div class="rb"><h4>ğŸ¯ ${cl.name||''} â€” 3í•™ë…„ ê³„íš</h4><p style="line-height:1.7">${cl.goal||''}</p></div>
${(cl.projects||[]).length?`<div class="rb"><h4>ğŸ’¡ í”„ë¡œì íŠ¸ ì œì•ˆ</h4><div style="display:grid;gap:12px">${(cl.projects||[]).map((p,i)=>{
const pc=['#3182F6','#7B61FF','#22B8CF'][i%3];
return`<div style="padding:16px;border-radius:14px;border:2px solid ${pc}33;background:${pc}08">
<div style="font-size:14px;font-weight:800;margin-bottom:6px;color:${pc}">${String.fromCharCode(65+i)}. ${p.title}</div>
<p style="font-size:12px;line-height:1.7;margin-bottom:8px">${p.concept||''}</p>
${(p.steps||[]).length?`<div style="font-size:11px;margin-bottom:6px"><strong>ì‹¤í–‰:</strong><ol style="margin:4px 0 0 16px;line-height:1.8">${(p.steps||[]).map(s=>`<li>${s}</li>`).join('')}</ol></div>`:''}
${p.record_points?`<p style="font-size:11px;font-weight:600;padding:6px 10px;background:rgba(255,255,255,0.6);border-radius:8px">ğŸ“ ${p.record_points}</p>`:''}</div>`}).join('')}</div></div>`:''}
<div class="rb"><h4>ğŸ“… ë¶„ê¸°ë³„ ê³„íš</h4><table class="tbl"><tr><th>ë¶„ê¸°</th><th>í•µì‹¬ ëª©í‘œ</th><th>í™œë™</th><th>ê¸°ë¡ í¬ì¸íŠ¸</th></tr>${clubItems.map(m=>`<tr><td style="font-weight:700">${m.quarter||m.month}</td><td>${m.focus||''}</td><td>${m.activities||m.activity||''}</td><td>${m.record||''}</td></tr>`).join('')}</table></div>`;

// ====== ìƒë‹´ íƒ­ ======
const co=r.counsel||{};
const coPoints=co.points||co.talk_points||[];
const coParent=co.parent||co.parent_points||[];
const coGrade=co.grade_analysis||[];

// ì—­ëŸ‰ë³„ ë“±ê¸‰ íŒì • (ì ìˆ˜ â†’ ë“±ê¸‰)
function capGrade(v){return v>=4.5?'S':v>=4.0?'A':v>=3.0?'B':v>=2.0?'C':'D'}
const capData=[
{k:'academic',l:'ğŸ“š í•™ì—…ì—­ëŸ‰',c:'#3182F6',v:sc.academic||0},
{k:'career',l:'ğŸ¯ ì§„ë¡œì—­ëŸ‰',c:'#7B61FF',v:sc.career||0},
{k:'community',l:'ğŸ¤ ê³µë™ì²´ì—­ëŸ‰',c:'#22B8CF',v:sc.community||0}
];
const totalScore=capData.reduce((s,x)=>s+x.v,0);
const avgScore=capData.length?Math.round((totalScore/capData.length)*100)/100:0;
const totalGrade=capGrade(avgScore);

document.getElementById('tc-co').innerHTML=`
<div class="rb" style="border-left:4px solid ${gradeClr(totalGrade)}">
<h4>ğŸ“Š 3ëŒ€ ì—­ëŸ‰ ì¢…í•© ì§„ë‹¨ <span class="badge" style="background:${gradeBg(totalGrade)};color:${gradeClr(totalGrade)};font-size:14px;padding:4px 14px;margin-left:8px">${totalGrade}ë“±ê¸‰</span><span style="font-size:17px;font-weight:900;color:${gradeClr(totalGrade)};margin-left:8px">${avgScore.toFixed(1)}</span><span style="font-size:11px;color:var(--g3)"> / 5.0</span></h4>
<p style="margin:10px 0;font-size:12px;color:var(--g2)">ììœ¨Â·ì§„ë¡œÂ·êµê³¼ì„¸íŠ¹Â·ë™ì•„ë¦¬ 4ê°œ ì˜ì—­ Ã— í•™ì—…Â·ì§„ë¡œÂ·ê³µë™ì²´ 3ê°œ ì—­ëŸ‰ = Rating Matrix ê°€ì¤‘í•©ì‚°</p>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin:14px 0">
${capData.map(x=>{
const g=capGrade(x.v);
return`<div style="text-align:center;padding:16px 10px;border-radius:12px;border:2px solid ${x.c}33;background:${x.c}08">
<div style="font-size:22px;font-weight:900;color:${x.c}">${g}</div>
<div style="font-size:10px;font-weight:700;color:${x.c};margin-top:2px">${x.v.toFixed(1)}ì </div>
<div style="font-size:11px;color:var(--g2);margin-top:4px">${x.l}</div>
</div>`}).join('')}
</div>
</div>

${capData.map(x=>{
const g=capGrade(x.v);const c=cp[x.k]||{};const rm_row=rm?rm[x.k]:{};
return`<div class="rb" style="border-left:4px solid ${x.c}">
<h4 style="display:flex;justify-content:space-between;align-items:center">${x.l} <span style="display:flex;align-items:center;gap:8px"><span class="badge" style="background:${gradeBg(g)};color:${gradeClr(g)};font-size:13px;padding:4px 12px">${g}ë“±ê¸‰</span><span style="font-size:17px;font-weight:900;color:${x.c}">${x.v.toFixed(1)}</span></span></h4>
${rm_row?`<div style="display:flex;gap:6px;margin:10px 0;flex-wrap:wrap">
${[{a:'jayul',l:'ììœ¨'},{a:'jinro',l:'ì§„ë¡œ'},{a:'subject',l:'êµê³¼ì„¸íŠ¹'},{a:'club',l:'ë™ì•„ë¦¬'}].map(ar=>{
const ag=rm_row[ar.a]||'B';
return`<span style="padding:4px 10px;border-radius:6px;font-size:11px;font-weight:800;background:${gradeBg(ag)};color:${gradeClr(ag)}">${ar.l}: ${ag}</span>`}).join('')}
</div>`:''}
<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-top:8px">
<div style="padding:10px;border-radius:8px;background:white;border:1px solid ${x.c}11"><div style="font-size:10px;color:var(--g4);font-weight:700;margin-bottom:4px">1í•™ë…„</div><div style="font-size:11px;line-height:1.6">${c.grade1||'-'}</div></div>
<div style="padding:10px;border-radius:8px;background:white;border:1px solid ${x.c}11"><div style="font-size:10px;color:var(--g4);font-weight:700;margin-bottom:4px">2í•™ë…„</div><div style="font-size:11px;line-height:1.6">${c.grade2||'-'}</div></div>
<div style="padding:10px;border-radius:8px;background:${x.c}11"><div style="font-size:10px;color:${x.c};font-weight:700;margin-bottom:4px">ë³€í™” í¬ì¸íŠ¸</div><div style="font-size:11px;line-height:1.6;color:${x.c};font-weight:600">${c.growth||'-'}</div></div>
<div style="padding:10px;border-radius:8px;background:${x.c}18"><div style="font-size:10px;color:${x.c};font-weight:700;margin-bottom:4px">3í•™ë…„ ì§‘ì¤‘</div><div style="font-size:11px;line-height:1.6;color:${x.c};font-weight:700">${c.grade3_focus||'-'}</div></div>
</div>
</div>`}).join('')}

${coGrade.length?`<div class="rb" style="border-left:4px solid #FF9F43">
<h4>ğŸ“ˆ ì„±ì  ë¶„ì„ Â· ë‚´ì‹  ì¶”ì´</h4>
${coGrade.map(s=>`<div style="margin:8px 0;padding:12px 16px;background:#FFF8F0;border-radius:10px;font-size:13px;line-height:1.8">ğŸ“Š ${s}</div>`).join('')}
</div>`:''}

${(()=>{const ua=co.univ_analysis||{};if(!ua.univ_name)return'';return`
<div class="rb" style="border-left:4px solid #E040FB;background:linear-gradient(135deg,#FDF4FF,#F3E5F5)">
<h4>ğŸ“ ${ua.univ_name} ${ua.major_name} â€” ì…ì‹œ ë¶„ì„</h4>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin:12px 0">
<div style="padding:12px;background:white;border-radius:10px;text-align:center">
<div style="font-size:10px;color:var(--g4);font-weight:700">ì „í˜•</div>
<div style="font-size:12px;font-weight:800;color:#E040FB;margin-top:4px">${ua.admission_type||'-'}</div>
</div>
<div style="padding:12px;background:white;border-radius:10px;text-align:center">
<div style="font-size:10px;color:var(--g4);font-weight:700">í•©ê²© ë‚´ì‹ ëŒ€</div>
<div style="font-size:12px;font-weight:800;color:#3182F6;margin-top:4px">${ua.avg_grade||'-'}</div>
</div>
<div style="padding:12px;background:white;border-radius:10px;text-align:center">
<div style="font-size:10px;color:var(--g4);font-weight:700">ê²½ìŸë¥ </div>
<div style="font-size:12px;font-weight:800;color:#FF6B6B;margin-top:4px">${ua.competition_rate||'-'}</div>
</div>
</div>
<div style="padding:12px;background:white;border-radius:10px;margin:8px 0">
<div style="font-size:11px;font-weight:700;color:#E040FB;margin-bottom:6px">ğŸ« ì¸ì¬ìƒ</div>
<p style="font-size:12px;line-height:1.7">${ua.talent_profile||''}</p>
${(ua.key_competencies||[]).length?`<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">${ua.key_competencies.map(k=>`<span style="padding:3px 10px;border-radius:6px;font-size:10px;font-weight:700;background:#F3E5F5;color:#E040FB">${k}</span>`).join('')}</div>`:''}
</div>
<div style="padding:12px;background:white;border-radius:10px;margin:8px 0">
<div style="font-size:11px;font-weight:700;color:#3182F6;margin-bottom:6px">ğŸ“Š ì í•©ë„ ë¶„ì„</div>
<p style="font-size:12px;line-height:1.8">${ua.fit_analysis||''}</p>
</div>
<div style="padding:12px;background:white;border-radius:10px;margin:8px 0">
<div style="font-size:11px;font-weight:700;color:#00C471;margin-bottom:6px">ğŸ¯ í•©ê²© ì „ëµ</div>
<p style="font-size:12px;line-height:1.8">${ua.strategy||''}</p>
</div>
${(ua.risk_factors||[]).length?`<div style="padding:12px;background:#FFF5F5;border-radius:10px;margin:8px 0">
<div style="font-size:11px;font-weight:700;color:#FF6B6B;margin-bottom:6px">âš ï¸ ë¦¬ìŠ¤í¬ ìš”ì¸</div>
${ua.risk_factors.map(s=>`<p style="font-size:12px;line-height:1.7;margin:2px 0">â€¢ ${s}</p>`).join('')}
</div>`:''}
${(ua.alternative_majors||[]).length?`<div style="padding:8px 12px;background:white;border-radius:8px;margin-top:8px;font-size:11px">ğŸ’¡ <strong>ëŒ€ì•ˆ í•™ê³¼:</strong> ${ua.alternative_majors.join(', ')}</div>`:''}
</div>`})()}

${co.curriculum_summary?`<div class="rb" style="border-left:4px solid #FF9F43;background:linear-gradient(135deg,#FFFBF0,#FFF3E0)">
<h4>ğŸ“‹ êµê³¼ + ìƒê¸°ë¶€ ì´ì •ë¦¬</h4>
<p style="font-size:13px;line-height:1.9">${co.curriculum_summary}</p>
</div>`:''}

<div class="rb" style="border-left:4px solid #3182F6"><h4>ğŸ’¬ ìƒë‹´ í¬ì¸íŠ¸</h4>
${coPoints.map(s=>`<div style="margin:8px 0;padding:12px 16px;background:#FAFCFF;border-radius:10px;font-size:13px;line-height:1.8">â€¢ ${s}</div>`).join('')}</div>
<div class="rb" style="border-left:4px solid #7B61FF"><h4>â“ ì§ˆë¬¸ ì˜ˆì‹œ</h4>
${(co.questions||[]).map(s=>`<div style="margin:8px 0;padding:12px 16px;background:#FCFAFF;border-radius:10px;font-size:13px;line-height:1.8;font-style:italic">"${s}"</div>`).join('')}</div>
<div class="rb" style="border-left:4px solid #22B8CF"><h4>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ í•™ë¶€ëª¨ ì „ë‹¬ì‚¬í•­</h4>
${coParent.map(s=>`<div style="margin:8px 0;padding:12px 16px;background:#F0FCFE;border-radius:10px;font-size:13px;line-height:1.8">â€¢ ${s}</div>`).join('')}</div>
${(co.recommended_activities||[]).length?`<div class="rb" style="border-left:4px solid #00C471"><h4>ğŸš€ ì¶”ì²œ í™œë™</h4>${co.recommended_activities.map(s=>`<div style="margin:8px 0;padding:12px 16px;background:#E8FAF0;border-radius:10px;font-size:13px;line-height:1.8">âœ¦ ${s}</div>`).join('')}</div>`:''}`;

// ë¹ˆ ì„¹ì…˜ ê°ì§€
const missing=[];
const jh=r.jarhaeng||{};
if(!jh.hangbal?.option1?.text)missing.push('í–‰ë°œ');
if(!(r.setuk?.subjects?.length))missing.push('ì„¸íŠ¹');
if(!r.subject_analysis?.analysis)missing.push('êµê³¼ë¶„ì„');
if(!clubItems.length)missing.push('ë™ì•„ë¦¬ ê³„íš');
if(!coPoints.length)missing.push('ìƒë‹´');
if(missing.length){
const warn=document.createElement('div');
warn.style.cssText='background:var(--orange-bg);border:1.5px solid var(--orange);border-radius:12px;padding:14px 18px;margin:10px 0;font-size:13px;color:var(--g1)';
warn.innerHTML=`<strong style="color:var(--orange)">âš ï¸ ì¼ë¶€ ì„¹ì…˜ ë¹„ì–´ìˆìŒ:</strong> ${missing.join(', ')}<br><span style="font-size:12px;color:var(--g3)">ì¬ë¶„ì„í•˜ë©´ ì™„ì „í•œ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>`;
document.getElementById('tc-ov').prepend(warn);
}
st('ov')}

function rJH(jh){const gradeClr=GRADE_CLR;const gradeBg=GRADE_BG;return[{k:'jayul',l:'ììœ¨í™œë™',b:1500,e:'ğŸ“‹'},{k:'jinro',l:'ì§„ë¡œí™œë™',b:2100,e:'ğŸ¯'},{k:'hangbal',l:'í–‰ë™íŠ¹ì„±ë°ì¢…í•©ì˜ê²¬',b:1500,e:'ğŸ’¬'}].map(a=>{
const d=jh[a.k]||{},o1=d.option1||{},o2=d.option2||{},b1=bl(o1.text||''),b2=bl(o2.text||''),gr=d.grade||'';
const hasElements=d.s_elements||d.a_elements||d.b_elements||d.c_elements;
return`<div class="rb" style="border-left:4px solid ${gradeClr(gr)||'var(--g5)'}">
<h4>${a.e} ${a.l} <span class="badge" style="background:${gradeBg(gr)};color:${gradeClr(gr)};font-size:13px;padding:4px 12px">${gr||'?'}ë“±ê¸‰</span> <span class="badge b-gy">${a.b}B</span></h4>
<p style="margin:10px 0;line-height:1.85;font-size:13px;color:var(--g1)">${d.evaluation||''}</p>
${hasElements?`<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;margin:12px 0">
${[{g:'S',c:'var(--blue)',bg:'var(--blue-bg)'},{g:'A',c:'var(--green)',bg:'var(--green-bg)'},{g:'B',c:'var(--orange)',bg:'var(--orange-bg)'},{g:'C',c:'var(--coral)',bg:'var(--coral-bg)'}].map(x=>`<div style="text-align:center;padding:10px;background:${x.bg};border-radius:8px"><div style="font-size:18px;font-weight:900;color:${x.c}">${x.g}</div><div style="font-size:9px;font-weight:700;color:${x.c}">${x.g}ë“±ê¸‰</div></div>`).join('')}
</div>
${d.s_elements?`<div style="padding:8px 12px;background:var(--blue-bg);border-radius:8px;margin:4px 0;font-size:11px;line-height:1.7"><strong style="color:var(--blue)">Së“±ê¸‰:</strong> ${d.s_elements}</div>`:''}
${d.a_elements?`<div style="padding:8px 12px;background:var(--green-bg);border-radius:8px;margin:4px 0;font-size:11px;line-height:1.7"><strong style="color:var(--green)">Aë“±ê¸‰:</strong> ${d.a_elements}</div>`:''}
${d.b_elements?`<div style="padding:8px 12px;background:var(--orange-bg);border-radius:8px;margin:4px 0;font-size:11px;line-height:1.7"><strong style="color:var(--orange)">Bë“±ê¸‰:</strong> ${d.b_elements}</div>`:''}
${d.c_elements?`<div style="padding:8px 12px;background:var(--coral-bg);border-radius:8px;margin:4px 0;font-size:11px;line-height:1.7"><strong style="color:var(--coral)">Cë“±ê¸‰:</strong> ${d.c_elements}</div>`:''}
`:''}
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
<div style="background:#FAFCFF;border-radius:12px;padding:16px;border:1.5px solid #3182F633">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span class="badge b-bl" style="font-size:12px;padding:4px 14px">ì•ˆì „í˜•(A)</span><span style="font-size:11px;color:var(--g3);font-weight:600">${b1}/${a.b}B</span></div>
<div style="font-weight:700;font-size:13px;color:var(--g1);margin-bottom:8px">${o1.title||''}</div>
<div style="font-size:12px;line-height:1.8;color:var(--g1)">${o1.text||''}</div>
<div style="margin-top:10px;padding:8px 12px;background:white;border-radius:8px;font-size:11px;line-height:1.6;color:var(--g2)">âœ“ <strong>í•µì‹¬:</strong> ${o1.focus||''}<br>â†’ <strong>ë³´ì™„:</strong> ${o1.supplement||''}</div>
</div>
<div style="background:#FCFAFF;border-radius:12px;padding:16px;border:1.5px solid #7B61FF33">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span class="badge b-pu" style="font-size:12px;padding:4px 14px">ë„ì „í˜•(S)</span><span style="font-size:11px;color:var(--g3);font-weight:600">${b2}/${a.b}B</span></div>
<div style="font-weight:700;font-size:13px;color:var(--g1);margin-bottom:8px">${o2.title||''}</div>
<div style="font-size:12px;line-height:1.8;color:var(--g1)">${o2.text||''}</div>
<div style="margin-top:10px;padding:8px 12px;background:white;border-radius:8px;font-size:11px;line-height:1.6;color:var(--g2)">âœ“ <strong>í•µì‹¬:</strong> ${o2.focus||''}<br>â†’ <strong>ë³´ì™„:</strong> ${o2.supplement||''}</div>
</div>
</div>
${a.k==='hangbal'?'<div style="margin-top:10px;padding:10px 14px;background:var(--orange-bg);border-radius:10px;font-size:11px;color:var(--orange);font-weight:600">âš ï¸ 3í•™ë…„ í–‰ë°œì€ í•™ì¢… ìˆ˜ì‹œ ë¯¸ë°˜ì˜ (1~2í•™ë…„ë§Œ ëŒ€í•™ ì œê³µ)</div>':''}</div>`}).join('')}

function bl(s){return new Blob([s||'']).size}
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function st(id){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));document.querySelectorAll('.tc').forEach(t=>t.classList.remove('on'));document.querySelector(`.tab[onclick="st('${id}')"]`).classList.add('on');document.getElementById('tc-'+id).classList.add('on')}

function getPDFStyles(){return`<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans KR',sans-serif;max-width:860px;margin:0 auto;padding:40px 32px;color:#191F28;line-height:1.7;font-size:13px;background:#fff}
.cover{text-align:center;padding:40px 0 30px;border-bottom:3px solid #3182F6;margin-bottom:30px}
.cover h1{font-size:28px;font-weight:900;color:#3182F6;letter-spacing:-1px}
.cover .sub{font-size:14px;color:#8B95A1;margin-top:8px}
.info-bar{display:flex;gap:12px;flex-wrap:wrap;margin:20px 0;padding:16px 20px;background:linear-gradient(135deg,#EBF4FF,#F0EDFF);border-radius:14px}
.info-item{font-size:13px;font-weight:600;color:#333D4B}.info-item span{color:#3182F6}
.section{margin:28px 0;page-break-inside:avoid}
h2{font-size:18px;font-weight:800;color:#191F28;margin:30px 0 16px;padding-bottom:8px;border-bottom:2px solid #E5E8EB;display:flex;align-items:center;gap:8px}
h3{font-size:15px;font-weight:700;color:#333D4B;margin:20px 0 10px;display:flex;align-items:center;gap:8px}
.byte-tag{font-size:11px;background:#F2F4F6;color:#8B95A1;padding:2px 8px;border-radius:100px;font-weight:600}
.summary{font-size:14px;line-height:1.85;color:#333D4B;padding:18px 20px;background:#F8F9FA;border-radius:12px;border-left:4px solid #3182F6;margin:12px 0}
.chips{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0}
.chip-good{padding:8px 14px;background:#E8FAF0;color:#00C471;border-radius:10px;font-size:12px;font-weight:600}
.chip-imp{padding:8px 14px;background:#FFF0F0;color:#FF6B6B;border-radius:10px;font-size:12px;font-weight:600}
.comp-card{background:#FAFBFC;border-radius:12px;padding:16px 18px;margin:10px 0}
.comp-title{font-size:14px;font-weight:800;margin-bottom:8px}
.comp-tbl{width:100%;font-size:12px;line-height:1.7}
.comp-tbl th{text-align:left;padding:6px 10px;color:#8B95A1;font-weight:600;vertical-align:top}
.comp-tbl td{padding:6px 10px;color:#4E5968}
.eval{font-size:13px;color:#4E5968;line-height:1.7;padding:10px 14px;background:#FAFBFC;border-radius:8px;margin-bottom:12px}
.opt-grid{display:grid;gap:10px}
.opt-box{border-radius:12px;padding:16px;border:1px solid #E5E8EB;background:#fff}
.opt-hdr{font-size:13px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.opt-badge{padding:3px 10px;border-radius:100px;font-size:11px;font-weight:700;color:#fff}
.opt-badge.blue{background:#3182F6}.opt-badge.purple{background:#7B61FF}
.byte-count{font-size:11px;font-weight:600;color:#8B95A1;margin-left:auto}.byte-count.over{color:#FF6B6B}
.opt-body{font-size:13px;color:#333D4B;line-height:1.8;white-space:pre-wrap;padding:12px 14px;background:#F8F9FA;border-radius:8px}
.opt-meta{font-size:11px;color:#8B95A1;margin-top:8px;font-weight:500}
.setuk-card{padding:14px 16px;background:#FAFBFC;border-radius:10px;margin:8px 0;border:1px solid #E5E8EB}
.setuk-name{font-size:14px;font-weight:800;color:#3182F6}
.setuk-theme{font-size:13px;font-weight:600;color:#333D4B;margin:6px 0}
.setuk-reason{font-size:12px;color:#4E5968;line-height:1.7}
.setuk-kws{margin-top:8px}.kw-tag{display:inline-block;padding:3px 10px;background:#EBF4FF;color:#3182F6;border-radius:100px;font-size:11px;font-weight:600;margin:2px}
.club-tbl{width:100%;border-collapse:separate;border-spacing:0;border-radius:10px;overflow:hidden;border:1px solid #E5E8EB;font-size:12px}
.club-tbl th{padding:10px 14px;background:#F2F4F6;font-weight:700;text-align:left;color:#4E5968}
.club-tbl td{padding:10px 14px;border-top:1px solid #E5E8EB;color:#333D4B;line-height:1.65}
.co-sec{margin:14px 0;padding:14px 16px;background:#FAFBFC;border-radius:10px}
.co-sec h4{font-size:13px;font-weight:700;margin-bottom:8px;color:#333D4B}
.co-sec p{font-size:12px;color:#4E5968;line-height:1.7;margin:4px 0}
.footer{text-align:center;margin-top:40px;padding-top:16px;border-top:2px solid #E5E8EB;font-size:11px;color:#B0B8C1}
@media print{body{padding:20px 16px;font-size:12px}.cover{padding:20px 0 16px}.comp-card,.opt-box,.setuk-card{break-inside:avoid}}
</style>`}

function buildPDFContent(result){
const r=result,m=r._m||{},ov=r.overview||{},cp=ov.competencies||{},jh=r.jarhaeng||{},se=r.setuk||{},cl=r.club||{},co=r.counsel||{},sa=r.subject_analysis||{},sc=ov.scores||{};
const compLabels={academic:'í•™ì—…ì—­ëŸ‰',career:'ì§„ë¡œì—­ëŸ‰',community:'ê³µë™ì²´ì—­ëŸ‰'};
const compColors={academic:'#3182F6',career:'#7B61FF',community:'#00C471'};
const gpa=ov.gpa||0;
const gpaClr=gpa>=4.0?'#3182F6':gpa>=3.5?'#22B8CF':gpa>=3.0?'#FF9F43':'#FF6B6B';
const grClr=(g)=>({"S+":'#FFB800',S:'#3182F6',A:'#00C471',B:'#FF9F43',C:'#FF6B6B'}[g]||'#8B95A1');
let compHtml='';
['academic','career','community'].forEach(k=>{
const c=cp[k]||{};
compHtml+=`<div class="comp-card" style="border-left:4px solid ${compColors[k]}">
<div class="comp-title" style="color:${compColors[k]}">${compLabels[k]} <span style="font-size:14px;font-weight:900;margin-left:8px">${sc[k]||''}</span></div>
<table class="comp-tbl"><tr><th style="width:80px">1í•™ë…„</th><td>${c.grade1||'-'}</td></tr>
<tr><th>2í•™ë…„</th><td>${c.grade2||'-'}</td></tr>
<tr><th style="color:${compColors[k]}">ì„±ì¥</th><td style="font-weight:600">${c.growth||'-'}</td></tr></table></div>`;
});
let jhHtml='';
[{k:'jayul',l:'ììœ¨í™œë™',lm:1500},{k:'jinro',l:'ì§„ë¡œí™œë™',lm:2100},{k:'dongari',l:'ë™ì•„ë¦¬í™œë™',lm:1500},{k:'hangbal',l:'í–‰ë™íŠ¹ì„±ë°ì¢…í•©ì˜ê²¬',lm:1500}].forEach(a=>{
const d=jh[a.k]||{},o1=d.option1||{},o2=d.option2||{},b1=bl(o1.text||''),b2=bl(o2.text||''),gr=d.grade||'';
jhHtml+=`<div class="section"><h3>${a.l} <span class="byte-tag">${a.lm}B</span>${gr?` <span style="background:${grClr(gr)}20;color:${grClr(gr)};padding:2px 8px;border-radius:100px;font-size:11px;font-weight:700">${gr}ë“±ê¸‰</span>`:''}</h3>
<p class="eval">${d.evaluation||''}</p>
<div class="opt-grid"><div class="opt-box">
<div class="opt-hdr"><span class="opt-badge blue">ì•ˆì „í˜•(A)</span> ${o1.title||''} <span class="byte-count ${b1>a.lm?'over':''}">${b1}/${a.lm}B</span></div>
<div class="opt-body">${o1.text||''}</div>
<div class="opt-meta">âœ“ ${o1.focus||''} Â· â†’ ${o1.supplement||''}</div></div>
<div class="opt-box"><div class="opt-hdr"><span class="opt-badge purple">ë„ì „í˜•(S)</span> ${o2.title||''} <span class="byte-count ${b2>a.lm?'over':''}">${b2}/${a.lm}B</span></div>
<div class="opt-body">${o2.text||''}</div>
<div class="opt-meta">âœ“ ${o2.focus||''} Â· â†’ ${o2.supplement||''}</div></div></div>${a.k==='hangbal'?'<p style="font-size:11px;color:#FF9F43;margin-top:8px;font-weight:600">âš ï¸ 3í•™ë…„ í–‰ë°œ: í•™ì¢… ìˆ˜ì‹œ ë¯¸ë°˜ì˜ (1~2í•™ë…„ë§Œ ì œê³µ).</p>':''}</div>`;
});
let seHtml=(se.subjects||[]).map(s=>`<div class="setuk-card"><div class="setuk-name">${s.name||''}</div>
<div class="setuk-theme">ğŸ“Œ ${s.theme||''}</div><div class="setuk-reason">${s.reason||''}</div>
<div class="setuk-kws">${(s.keywords||[]).map(k=>`<span class="kw-tag">${k}</span>`).join(' ')}</div></div>`).join('');
let clItems=cl.quarterly||cl.monthly||[];
let clIsQ=!!cl.quarterly;
let clHtml=clItems.map(m=>`<tr><td style="font-weight:700;color:#3182F6;width:${clIsQ?'100':'60'}px">${m.quarter||m.month}</td>${clIsQ?`<td style="font-size:11px;font-weight:600">${m.focus||''}</td>`:''}<td>${m.activities||m.activity||''}</td><td style="font-size:11px;color:#8B95A1">${m.record||''}</td></tr>`).join('');
let coPoints=co.points||co.talk_points||[];
let coParent=co.parent||co.parent_points||[];
let coHtml=`<div class="co-sec"><h4>ğŸ’¬ ìƒë‹´ í¬ì¸íŠ¸</h4>${coPoints.map(s=>`<p>â€¢ ${s}</p>`).join('')}</div>
<div class="co-sec"><h4>â“ ì§ˆë¬¸ ì˜ˆì‹œ</h4>${(co.questions||[]).map(s=>`<p>"${s}"</p>`).join('')}</div>
<div class="co-sec"><h4>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ í•™ë¶€ëª¨ ì „ë‹¬ì‚¬í•­</h4>${coParent.map(s=>`<p>â€¢ ${s}</p>`).join('')}</div>
${(co.recommended_activities||[]).length?`<div class="co-sec"><h4>ğŸš€ ì¶”ì²œ í™œë™</h4>${co.recommended_activities.map(s=>`<p>âœ¦ ${s}</p>`).join('')}</div>`:''}`;

return`<div class="info-bar">
<div class="info-item">ğŸ“‹ <span>${m.sid||''}</span> ${m.nm||''}</div>
<div class="info-item">ğŸ¯ ì§„ë¡œ: <span>${m.cr||''}</span></div>
<div class="info-item">ğŸ« ë™ì•„ë¦¬: <span>${m.cl||''}</span></div>
<div class="info-item">ğŸ“… <span>${m.dt||''}</span></div>
<div class="info-item">âš¡ <span>${(m.pri||[]).map((p,i)=>['â‘ ','â‘¡','â‘¢'][i]+p).join(' â†’ ')}</span></div>
</div>
<div style="text-align:center;padding:16px 0;margin:10px 0;border:2px solid ${gpaClr};border-radius:14px;background:${gpaClr}08">
<span style="font-size:13px;font-weight:700;color:#8B95A1">ìƒê¸°ë¶€ ì¢…í•© í‰ì </span>
<span style="font-size:36px;font-weight:900;color:${gpaClr};margin:0 16px">${gpa.toFixed?gpa.toFixed(1):gpa}</span>
<span style="font-size:13px;font-weight:700;color:${gpaClr}">${ov.tier||''}</span>
<div style="font-size:11px;color:#8B95A1;margin-top:4px">${ov.gpa_brief||''}</div>
</div>
<h2>ğŸ“Š ì¢…í•© ë¶„ì„</h2><div class="summary">${ov.summary||''}</div>
<div class="chips">${(ov.strengths||[]).map(s=>`<div class="chip-good">âœ¦ ${s}</div>`).join('')}</div>
<div class="chips">${(ov.improvements||[]).map(s=>`<div class="chip-imp">â†’ ${s}</div>`).join('')}</div>
${sa.analysis?`<h2>ğŸ“˜ êµê³¼ ì„¸íŠ¹ ë¶„ì„</h2>
<div style="display:flex;gap:12px;margin-bottom:12px">
<span style="font-weight:800;color:${grClr(sa.overall_grade)}">${sa.overall_grade}ë“±ê¸‰ (${sa.overall_score||''})</span>
<span style="font-size:12px;color:#8B95A1">S:${sa.s_elements||0} | A:${sa.a_elements||0} | B:${sa.b_elements||0} | C:${sa.c_elements||0}</span>
</div>
<div class="summary">${sa.analysis||''}</div>
<div style="margin:8px 0;font-size:12px"><span style="color:#00C471;font-weight:700">âœ¦ ìš°ìˆ˜: ${(sa.strong_subjects||[]).join(', ')}</span> &nbsp; <span style="color:#FF6B6B;font-weight:700">â†’ ë³´ì™„: ${(sa.weak_subjects||[]).join(', ')}</span></div>`:''}
<h2>ğŸ’ª 3ëŒ€ ì—­ëŸ‰ ë¶„ì„</h2>${compHtml}
<h2>ğŸ“ ììœ¨Â·ì§„ë¡œÂ·ë™ì•„ë¦¬Â·í–‰ë°œ ê¸°ì¬ ì˜ˆì‹œ</h2>${jhHtml}
<h2>ğŸ¯ 3í•™ë…„ ì„¸íŠ¹ ë°©í–¥</h2><div class="summary">${se.direction||''}</div>${seHtml}
<h2>ğŸ« ë™ì•„ë¦¬ ${clIsQ?'ë¶„ê¸°ë³„':'ì›”ë³„'} ê³„íš</h2><div class="summary">${cl.goal||''}</div>
<table class="club-tbl"><tr><th>${clIsQ?'ë¶„ê¸°':'ì›”'}</th>${clIsQ?'<th>ëª©í‘œ</th>':''}<th>í™œë™ ë‚´ìš©</th><th>ê¸°ë¡ í¬ì¸íŠ¸</th></tr>${clHtml}</table>
<h2>ğŸ’¬ ìƒë‹´ ê°€ì´ë“œ</h2>${coHtml}
<div class="footer">ì„¸ê³µì‚¬ v4.2 Â· AI Powered Â· ${m.dt||''}</div>`;
}

function dlPDF(){if(!cur)return;
const w=window.open('','_blank');
const m=cur._m||{};
w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${m.nm||''} ìƒê¸°ë¶€ ì „ëµ ë¶„ì„ ë³´ê³ ì„œ</title>
${getPDFStyles()}</head><body>
<div class="cover"><h1>ğŸ“Š ìƒê¸°ë¶€ ì „ëµ ë¶„ì„ ë³´ê³ ì„œ</h1><div class="sub">AI ê¸°ë°˜ í•™ìƒë¶€ ì¢…í•© ë¶„ì„ ë¦¬í¬íŠ¸</div></div>
${buildPDFContent(cur)}
</body></html>`);
w.document.close();setTimeout(()=>w.print(),800)}

// === ì—‘ì…€ ìŠ¤íƒ€ì¼ í—¬í¼ ===
const XS={
title:{font:{bold:true,sz:16,color:{rgb:'FFFFFF'}},fill:{fgColor:{rgb:'1B5BD6'}},alignment:{horizontal:'center',vertical:'center',wrapText:true},border:{bottom:{style:'medium',color:{rgb:'0F3A8C'}}}},
hdr:{font:{bold:true,sz:11,color:{rgb:'FFFFFF'}},fill:{fgColor:{rgb:'4472C4'}},alignment:{horizontal:'center',vertical:'center',wrapText:true},border:{bottom:{style:'thin',color:{rgb:'2F5597'}}}},
hdrSub:{font:{bold:true,sz:10,color:{rgb:'1F3864'}},fill:{fgColor:{rgb:'D6E4F0'}},alignment:{horizontal:'center',vertical:'center',wrapText:true},border:{bottom:{style:'thin',color:{rgb:'8DB4E2'}}}},
label:{font:{bold:true,sz:11,color:{rgb:'1F3864'}},fill:{fgColor:{rgb:'E9EFF7'}},alignment:{horizontal:'center',vertical:'center',wrapText:true},border:{right:{style:'thin',color:{rgb:'B4C6E7'}},bottom:{style:'thin',color:{rgb:'D6E4F0'}}}},
body:{font:{sz:10,color:{rgb:'333D4B'}},alignment:{horizontal:'left',vertical:'top',wrapText:true},border:{bottom:{style:'hair',color:{rgb:'E5E8EB'}},right:{style:'hair',color:{rgb:'E5E8EB'}}}},
bodyC:{font:{sz:10,color:{rgb:'333D4B'}},alignment:{horizontal:'center',vertical:'center',wrapText:true},border:{bottom:{style:'hair',color:{rgb:'E5E8EB'}}}},
teacher:{font:{sz:10,color:{rgb:'1B5BD6'}},fill:{fgColor:{rgb:'F5F8FF'}},alignment:{horizontal:'left',vertical:'top',wrapText:true},border:{bottom:{style:'thin',color:{rgb:'B4C6E7'}},right:{style:'thin',color:{rgb:'B4C6E7'}},left:{style:'thin',color:{rgb:'B4C6E7'}}}},
byte:{font:{sz:9,color:{rgb:'8B95A1'}},alignment:{horizontal:'center',vertical:'center'}},
byteOver:{font:{sz:9,bold:true,color:{rgb:'FF0000'}},alignment:{horizontal:'center',vertical:'center'}},
info:{font:{bold:true,sz:11,color:{rgb:'1F3864'}},fill:{fgColor:{rgb:'F2F7FC'}},alignment:{vertical:'center',wrapText:true}},
infoVal:{font:{bold:true,sz:11,color:{rgb:'FF0000'}},fill:{fgColor:{rgb:'F2F7FC'}},alignment:{vertical:'center'}},
section:{font:{bold:true,sz:12,color:{rgb:'FFFFFF'}},fill:{fgColor:{rgb:'2F5597'}},alignment:{horizontal:'left',vertical:'center'},border:{bottom:{style:'medium',color:{rgb:'1F3864'}}}},
score:{font:{bold:true,sz:14,color:{rgb:'1B5BD6'}},alignment:{horizontal:'center',vertical:'center'}},
chip:{font:{bold:true,sz:10,color:{rgb:'3182F6'}},fill:{fgColor:{rgb:'EBF4FF'}},alignment:{horizontal:'left',vertical:'center',wrapText:true}},
note:{font:{sz:9,italic:true,color:{rgb:'8B95A1'}},fill:{fgColor:{rgb:'FAFAFA'}},alignment:{horizontal:'left',vertical:'center',wrapText:true}},
};
function apS(ws,ref,st){if(!ws[ref])ws[ref]={v:'',t:'s'};ws[ref].s=st;}
function setSt(ws,row,cols,style){cols.forEach(c=>{const ref=XLSX.utils.encode_cell({r:row,c});apS(ws,ref,style)})}
function setRowSt(ws,row,numCols,style){for(let c=0;c<numCols;c++){const ref=XLSX.utils.encode_cell({r:row,c});apS(ws,ref,style)}}

function dlXL(){if(!cur||cur._err)return;const r=cur,m=r._m,jh=r.jarhaeng||{},ov=r.overview||{},sc=ov.scores||{},sb=ov.score_brief||{},se=r.setuk||{},cl=r.club||{},co=r.counsel||{},sa=r.subject_analysis||{};
const wb=XLSX.utils.book_new();
const areas=[{k:'jayul',l:'ììœ¨í™œë™',lm:1500,clr:'4472C4'},{k:'jinro',l:'ì§„ë¡œí™œë™',lm:2100,clr:'5B9BD5'},{k:'dongari',l:'ë™ì•„ë¦¬í™œë™',lm:1500,clr:'70AD47'},{k:'hangbal',l:'í–‰ë™íŠ¹ì„±ë°ì¢…í•©ì˜ê²¬',lm:1500,clr:'ED7D31'}];

// ===== ì‹œíŠ¸1: ìš”ì•½ì¹´ë“œ =====
const s0=[];
s0.push(['ğŸ“Š ì„¸ê³µì‚¬ â€” ìƒê¸°ë¶€ ì „ëµ ë¶„ì„ ìš”ì•½ ì¹´ë“œ','','','','','','','','','']);
s0.push([]);
s0.push(['í•™ë…„',m.sid?m.sid[0]:'','ë°˜',m.sid?m.sid.substring(1,3):'','ë²ˆí˜¸',m.sid?m.sid.substring(3,5):'','ì„±ëª…',m.nm,'í¬ë§ì§„ë¡œ',m.cr]);
s0.push([]);
s0.push(['ìƒê¸°ë¶€ í‰ì ',ov.gpa_gb||ov._gbGpa||0,'','']);
s0.push(['ì¢…í•© í‰ì  (ë‚´ì‹  ë°˜ì˜)',ov.gpa||0,'',ov.tier||'']);
s0.push(['ë‚´ì‹  (ì „ì²´êµê³¼)',ov.naesinAll||'-','','']);
s0.push(['ë‚´ì‹  (êµ­ì˜ìˆ˜ì‚¬)',ov.naesinMSS||'-','','']);
s0.push(['ë‚´ì‹  (êµ­ì˜ìˆ˜ê³¼)',ov.naesinMSN||'-','','']);
s0.push(['ì ìš© ê¸°ì¤€',ov.naesinType||'ì „ì²´êµê³¼','','']);
s0.push(['í‰ì  ê·¼ê±°',ov.gpa_brief||'']);
s0.push([]);
// ë‚´ì‹  ì¶”ì´
const _gt=r.student_info?.grade_trend||[];
if(_gt.length&&_gt.some(s=>s.all>0)){
s0.push(['â—† ë‚´ì‹  ë“±ê¸‰ ì¶”ì´','','','','']);
s0.push(['í•™ê¸°','ì „ì²´êµê³¼','êµ­ì˜ìˆ˜ì‚¬','êµ­ì˜ìˆ˜ê³¼','ì£¼ìš”ê³¼ëª©']);
_gt.forEach(s=>{
const ks=(s.key_subjects||[]).map(k=>k.name+':'+k.grade).join(', ');
s0.push([s.semester,s.all||'',s.mss||'',s.msn||'',ks]);
});
s0.push([]);
}
// rating_matrix
const _rm=r.rating_matrix;
if(_rm){
s0.push(['Rating Matrix','ììœ¨','ì§„ë¡œ','êµê³¼ì„¸íŠ¹','ë™ì•„ë¦¬']);
['academic','career','community'].forEach(cap=>{
const lb={academic:'ğŸ“š í•™ì—…',career:'ğŸ¯ ì§„ë¡œ',community:'ğŸ¤ ê³µë™ì²´'};
const row=_rm[cap]||{};
s0.push([lb[cap],row.jayul||'B',row.jinro||'B',row.subject||'B',row.club||'B']);
});
s0.push([]);
}
s0.push(['ì—­ëŸ‰','ì ìˆ˜','í‰ê°€ ìš”ì•½']);
s0.push(['ğŸ“š í•™ì—…ì—­ëŸ‰',sc.academic||0,sb.academic||'']);
s0.push(['ğŸ¯ ì§„ë¡œì—­ëŸ‰',sc.career||0,sb.career||'']);
s0.push(['ğŸ¤ ê³µë™ì²´ì—­ëŸ‰',sc.community||0,sb.community||'']);
s0.push([]);
s0.push(['í•µì‹¬ í‚¤ì›Œë“œ',(ov.keywords||[]).map(k=>'#'+k).join('  ')]);
s0.push([]);
s0.push(['ì¢…í•© í‰ê°€',ov.summary||'']);
s0.push([]);
s0.push(['ê°•ì ']);
(ov.strengths||[]).forEach(s=>s0.push(['âœ¦',s]));
s0.push([]);
s0.push(['ë³´ì™„ì ']);
(ov.improvements||[]).forEach(s=>s0.push(['â†’',s]));
s0.push([]);
s0.push(['êµê³¼ ì„¸íŠ¹ ë¶„ì„',sa.overall_grade||'','í‰ì : '+(sa.overall_score||'')]);
s0.push(['ë¶„ì„',sa.analysis||'']);
s0.push(['Së“±ê¸‰ ìš”ì†Œ',sa.s_elements||'']);
s0.push(['Aë“±ê¸‰ ìš”ì†Œ',sa.a_elements||'']);
s0.push(['Bë“±ê¸‰ ìš”ì†Œ',sa.b_elements||'']);
s0.push(['Cë“±ê¸‰ ìš”ì†Œ',sa.c_elements||'']);
s0.push(['ì„¸íŠ¹ ìš°ìˆ˜ ê³¼ëª©',(sa.strong_subjects||[]).join(', ')]);
s0.push(['ë³´ì™„ í•„ìš” ê³¼ëª©',(sa.weak_subjects||[]).join(', ')]);
s0.push([]);
// v5.2: ì˜ì—­ë³„ ë“±ê¸‰ ë¶„ì„
s0.push(['â—† ì˜ì—­ë³„ ë“±ê¸‰ ë¶„ì„','','','']);
areas.forEach(a=>{
const d=jh[a.k]||{};
s0.push([a.l,d.grade||'','í‰ê°€: '+(d.evaluation||'')]);
if(d.s_elements)s0.push(['','Së“±ê¸‰ ìš”ì†Œ',d.s_elements]);
if(d.a_elements)s0.push(['','Aë“±ê¸‰ ìš”ì†Œ',d.a_elements]);
if(d.b_elements)s0.push(['','Bë“±ê¸‰ ìš”ì†Œ',d.b_elements]);
if(d.c_elements)s0.push(['','Cë“±ê¸‰ ìš”ì†Œ',d.c_elements]);
});

const ws0=XLSX.utils.aoa_to_sheet(s0);
ws0['!cols']=[{wch:16},{wch:10},{wch:50},{wch:30}];
ws0['!merges']=[{s:{r:0,c:0},e:{r:0,c:3}}];
// ìŠ¤íƒ€ì¼ ì ìš©
setRowSt(ws0,0,4,XS.title);
setRowSt(ws0,2,11,XS.info);
apS(ws0,XLSX.utils.encode_cell({r:2,c:1}),XS.infoVal);
apS(ws0,XLSX.utils.encode_cell({r:2,c:3}),XS.infoVal);
apS(ws0,XLSX.utils.encode_cell({r:2,c:5}),XS.infoVal);
apS(ws0,XLSX.utils.encode_cell({r:2,c:8}),XS.infoVal);
apS(ws0,XLSX.utils.encode_cell({r:2,c:10}),XS.infoVal);
// ì¢…í•© í‰ì  ê°•ì¡°
apS(ws0,XLSX.utils.encode_cell({r:4,c:0}),XS.label);
apS(ws0,XLSX.utils.encode_cell({r:4,c:1}),{font:{bold:true,sz:18,color:{rgb:'1B5BD6'}},alignment:{horizontal:'center',vertical:'center'}});
apS(ws0,XLSX.utils.encode_cell({r:4,c:3}),{font:{bold:true,sz:11,color:{rgb:'1B5BD6'}},alignment:{horizontal:'left',vertical:'center'}});
setRowSt(ws0,7,3,XS.hdr);
for(let i=8;i<=10;i++){apS(ws0,XLSX.utils.encode_cell({r:i,c:0}),XS.label);apS(ws0,XLSX.utils.encode_cell({r:i,c:1}),XS.score);apS(ws0,XLSX.utils.encode_cell({r:i,c:2}),XS.body)}
XLSX.utils.book_append_sheet(wb,ws0,'ìš”ì•½ì¹´ë“œ');

// ===== ì‹œíŠ¸2: ê¸°ì¬ì˜ˆì‹œ (í•µì‹¬!) =====
const s1=[];
s1.push(['ì„¸ê³µì‚¬ â€” ê°œì¸ë³„ ê¸°ì¬ ì˜ˆì‹œ ë° êµì‚¬ ê¸°ì…ë€','','','','','','','']);
s1.push([]);
s1.push(['í•™ë…„',m.sid?m.sid[0]:'','ë°˜',m.sid?m.sid.substring(1,3):'','ë²ˆí˜¸',m.sid?m.sid.substring(3,5):'','ì„±ëª…',m.nm]);
s1.push([]);
s1.push(['ì˜ì—­','ë“±ê¸‰','ì œí•œ','ì•ˆì „í˜•(A) ê¸°ì¬ì˜ˆì‹œ','Byte','ë„ì „í˜•(S) ê¸°ì¬ì˜ˆì‹œ','Byte','âœï¸ êµì‚¬ ì§ì ‘ ê¸°ì…ë€','Byte']);
areas.forEach(a=>{
const d=jh[a.k]||{},o1=d.option1||{},o2=d.option2||{};
const t1=o1.text||'',t2=o2.text||'';
s1.push([a.l,d.grade||'',a.lm+'B',t1,bl(t1),t2,bl(t2),'',0]);
});
s1.push([]);
s1.push(['ğŸ’¡ ì•ˆë‚´: ì•ˆì „í˜•(A)ì€ í˜„ì‹¤ì  ê¸°ì¬, ë„ì „í˜•(S)ì€ ì‹¬í™” íƒêµ¬ ê¸°ì¬ì…ë‹ˆë‹¤. ì˜¤ë¥¸ìª½ êµì‚¬ ê¸°ì…ë€ì— ì§ì ‘ ì‘ì„±í•˜ì„¸ìš”.','','','','','','','','']);
s1.push(['âš ï¸ 3í•™ë…„ í™œë™ì´ë¯€ë¡œ ê¸°ì¬ì˜ˆì‹œëŠ” ì¡°ê±´ë¶€ ì œì•ˆ(~í•  ê²½ìš°, ~í•œë‹¤ë©´) í˜•ì‹ì…ë‹ˆë‹¤. í™œë™ ì™„ë£Œ í›„ ì™„ë£Œí˜•ìœ¼ë¡œ ìˆ˜ì •í•˜ì„¸ìš”.','','','','','','','','']);

const ws1=XLSX.utils.aoa_to_sheet(s1);
ws1['!cols']=[{wch:16},{wch:5},{wch:7},{wch:52},{wch:6},{wch:52},{wch:6},{wch:52},{wch:6}];
ws1['!merges']=[{s:{r:0,c:0},e:{r:0,c:8}},{s:{r:10,c:0},e:{r:10,c:8}},{s:{r:11,c:0},e:{r:11,c:8}}];
ws1['!rows']=[{hpt:36},{hpt:6},{hpt:26},{hpt:6},{hpt:28},{hpt:200},{hpt:220},{hpt:200},{hpt:200},{hpt:6},{hpt:24},{hpt:24}];

// ìŠ¤íƒ€ì¼
setRowSt(ws1,0,9,XS.title);
setRowSt(ws1,2,9,XS.info);
apS(ws1,XLSX.utils.encode_cell({r:2,c:1}),XS.infoVal);
apS(ws1,XLSX.utils.encode_cell({r:2,c:3}),XS.infoVal);
apS(ws1,XLSX.utils.encode_cell({r:2,c:5}),XS.infoVal);
apS(ws1,XLSX.utils.encode_cell({r:2,c:8}),XS.infoVal);
setRowSt(ws1,4,9,XS.hdr);
// êµì‚¬ ê¸°ì…ë€ í—¤ë”ëŠ” íŠ¹ë³„ ìƒ‰
apS(ws1,XLSX.utils.encode_cell({r:4,c:7}),{font:{bold:true,sz:11,color:{rgb:'FFFFFF'}},fill:{fgColor:{rgb:'FF6B6B'}},alignment:{horizontal:'center',vertical:'center',wrapText:true}});

// ë°ì´í„°í–‰ ìŠ¤íƒ€ì¼
areas.forEach((a,i)=>{
const row=5+i;
apS(ws1,XLSX.utils.encode_cell({r:row,c:0}),{font:{bold:true,sz:11,color:{rgb:'FFFFFF'}},fill:{fgColor:{rgb:a.clr}},alignment:{horizontal:'center',vertical:'center',wrapText:true}});
apS(ws1,XLSX.utils.encode_cell({r:row,c:1}),XS.bodyC);
apS(ws1,XLSX.utils.encode_cell({r:row,c:2}),XS.bodyC);
apS(ws1,XLSX.utils.encode_cell({r:row,c:3}),XS.body);
const b1=bl(jh[a.k]?.option1?.text||'');
apS(ws1,XLSX.utils.encode_cell({r:row,c:4}),b1>a.lm?XS.byteOver:XS.byte);
apS(ws1,XLSX.utils.encode_cell({r:row,c:5}),XS.body);
const b2=bl(jh[a.k]?.option2?.text||'');
apS(ws1,XLSX.utils.encode_cell({r:row,c:6}),b2>a.lm?XS.byteOver:XS.byte);
apS(ws1,XLSX.utils.encode_cell({r:row,c:7}),XS.teacher);
apS(ws1,XLSX.utils.encode_cell({r:row,c:8}),XS.byte);
});
setRowSt(ws1,10,9,XS.note);
setRowSt(ws1,11,9,XS.note);
XLSX.utils.book_append_sheet(wb,ws1,'ê¸°ì¬ì˜ˆì‹œ');

// ===== ì‹œíŠ¸2.5(v5.0): ìµœì¢… ê¸°ë¡ (êµì‚¬ ì§ì ‘ ì…ë ¥) =====
const sFin=[];
sFin.push(['ìƒê¸°ë¶€ ìµœì¢… ê¸°ë¡ â€” '+m.nm,'','','','']);
sFin.push([]);
sFin.push(['ì˜ì—­','ì œí•œ','âœï¸ ìµœì¢… ê¸°ë¡ (êµì‚¬ ì§ì ‘ ì‘ì„±)','Byte','ìƒíƒœ']);
const _finAreas=[{l:'ììœ¨í™œë™',lm:1500,clr:'3182F6'},{l:'ì§„ë¡œí™œë™',lm:2100,clr:'7B61FF'},{l:'ë™ì•„ë¦¬í™œë™',lm:1500,clr:'00C471'},{l:'í–‰ë™íŠ¹ì„±ë°ì¢…í•©ì˜ê²¬',lm:1500,clr:'FF6B6B'}];
_finAreas.forEach(a=>{
sFin.push([a.l,a.lm+'B','',0,'ë¯¸ì‘ì„±']);
});
sFin.push([]);
sFin.push(['ğŸ’¡ ì•ˆë‚´: AI ì´ˆì•ˆ(ê¸°ì¬ì˜ˆì‹œ ì‹œíŠ¸)ì„ ì°¸ê³ í•˜ì—¬ ìµœì¢…ë³¸ì„ ì´ ì‹œíŠ¸ì— ì‘ì„±í•˜ì„¸ìš”.','','','','']);
sFin.push(['âš ï¸ ì´ ì‹œíŠ¸ì˜ ë‚´ìš©ì´ ì „ì²´ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹œ ê¸°ì¬ì¼ëŒì— ë°˜ì˜ë©ë‹ˆë‹¤.','','','','']);
const wsFin=XLSX.utils.aoa_to_sheet(sFin);
wsFin['!cols']=[{wch:18},{wch:7},{wch:65},{wch:6},{wch:8}];
wsFin['!merges']=[{s:{r:0,c:0},e:{r:0,c:4}}];
wsFin['!rows']=[{hpt:36},{hpt:6},{hpt:28},{hpt:220},{hpt:240},{hpt:220},{hpt:220},{hpt:6},{hpt:24},{hpt:24}];
setRowSt(wsFin,0,5,XS.title);
setRowSt(wsFin,2,5,XS.hdr);
apS(wsFin,XLSX.utils.encode_cell({r:2,c:2}),{font:{bold:true,sz:11,color:{rgb:'FFFFFF'}},fill:{fgColor:{rgb:'FF6B6B'}},alignment:{horizontal:'center',vertical:'center',wrapText:true}});
_finAreas.forEach((a,i)=>{
const row=3+i;
apS(wsFin,XLSX.utils.encode_cell({r:row,c:0}),{font:{bold:true,sz:11,color:{rgb:'FFFFFF'}},fill:{fgColor:{rgb:a.clr}},alignment:{horizontal:'center',vertical:'center',wrapText:true}});
apS(wsFin,XLSX.utils.encode_cell({r:row,c:1}),XS.bodyC);
apS(wsFin,XLSX.utils.encode_cell({r:row,c:2}),XS.teacher);
apS(wsFin,XLSX.utils.encode_cell({r:row,c:3}),{font:{sz:9},alignment:{horizontal:'center',vertical:'center'}});
apS(wsFin,XLSX.utils.encode_cell({r:row,c:4}),XS.bodyC);
});
XLSX.utils.book_append_sheet(wb,wsFin,'ìµœì¢…ê¸°ë¡');

// ===== ì‹œíŠ¸3: í™œë™ë°©í–¥ =====
const s3=[];
s3.push(['3í•™ë…„ í™œë™ ë°©í–¥ - '+m.nm,'','','']);
s3.push([]);
s3.push(['â—† ì„¸íŠ¹ ë°©í–¥','','','']);
s3.push([se.direction||'','','','']);
s3.push([]);
s3.push(['ê³¼ëª©','íƒêµ¬ ì£¼ì œ','ì í•© ì´ìœ ','í‚¤ì›Œë“œ']);
(se.subjects||[]).forEach(s=>s3.push([s.name,s.theme,s.reason,(s.keywords||[]).join(', ')]));
s3.push([]);
s3.push(['â—† ë™ì•„ë¦¬: '+(cl.name||''),'','','']);
s3.push([cl.goal||'','','','']);
s3.push([]);
const clubItems=cl.quarterly||cl.monthly||[];
const isQ=!!cl.quarterly;
s3.push([isQ?'ë¶„ê¸°':'ì›”',isQ?'í•µì‹¬ ëª©í‘œ':'','í™œë™ ë‚´ìš©','ê¸°ë¡ í¬ì¸íŠ¸']);
clubItems.forEach(c=>s3.push([c.quarter||c.month,isQ?(c.focus||''):'',c.activities||c.activity||'',c.record||'']));
s3.push([]);
const coPoints=co.points||co.talk_points||[];
const coParent=co.parent||co.parent_points||[];
s3.push(['â—† ìƒë‹´ ê°€ì´ë“œ','','','']);
// ëŒ€í•™ ì…ì‹œ ë¶„ì„
const _ua=co.univ_analysis||{};
if(_ua.univ_name){
s3.push(['â—† ì…ì‹œ ë¶„ì„: '+_ua.univ_name+' '+(_ua.major_name||''),'','','']);
s3.push(['ì „í˜•',_ua.admission_type||'','í•©ê²© ë‚´ì‹ ëŒ€',_ua.avg_grade||'']);
s3.push(['ê²½ìŸë¥ ',_ua.competition_rate||'','ì¸ì¬ìƒ',_ua.talent_profile||'']);
s3.push(['í•µì‹¬ ì—­ëŸ‰',(_ua.key_competencies||[]).join(', '),'','']);
s3.push(['ì í•©ë„ ë¶„ì„',_ua.fit_analysis||'','','']);
s3.push(['í•©ê²© ì „ëµ',_ua.strategy||'','','']);
if((_ua.risk_factors||[]).length)s3.push(['ë¦¬ìŠ¤í¬',_ua.risk_factors.join(' / '),'','']);
if((_ua.alternative_majors||[]).length)s3.push(['ëŒ€ì•ˆ í•™ê³¼',_ua.alternative_majors.join(', '),'','']);
s3.push([]);
}
if(co.curriculum_summary){
s3.push(['â—† êµê³¼+ìƒê¸°ë¶€ ì´ì •ë¦¬','','','']);
s3.push([co.curriculum_summary,'','','']);
s3.push([]);
}
s3.push(['ìƒë‹´ í¬ì¸íŠ¸','','','']);
coPoints.forEach(s=>s3.push(['â€¢ '+s,'','','']));
s3.push([]);
s3.push(['ì§ˆë¬¸ ì˜ˆì‹œ','','','']);
(co.questions||[]).forEach(s=>s3.push(['"'+s+'"','','','']));
s3.push([]);
s3.push(['í•™ë¶€ëª¨ ì „ë‹¬ì‚¬í•­','','','']);
coParent.forEach(s=>s3.push(['â€¢ '+s,'','','']));

const ws3=XLSX.utils.aoa_to_sheet(s3);
ws3['!cols']=[{wch:16},{wch:35},{wch:40},{wch:20}];
ws3['!merges']=[{s:{r:0,c:0},e:{r:0,c:3}}];
// ìŠ¤íƒ€ì¼
setRowSt(ws3,0,4,XS.title);
[2,s3.indexOf(s3.find(x=>x[0]?.startsWith?.('â—† ë™ì•„ë¦¬')))||8].forEach(r=>{if(r>=0)setRowSt(ws3,r,4,XS.section)});
const seHdrRow=5;
setRowSt(ws3,seHdrRow,4,XS.hdrSub);
XLSX.utils.book_append_sheet(wb,ws3,'í™œë™ë°©í–¥');

// ===== ì‹œíŠ¸4: ì—­ëŸ‰ë¶„ì„ =====
const s4=[];
s4.push(['3ëŒ€ ì—­ëŸ‰ ì„±ì¥ ë¶„ì„ - '+m.nm,'','','','','']);
s4.push([]);
s4.push(['ì—­ëŸ‰','1í•™ë…„','2í•™ë…„','ì„±ì¥ ë¶„ì„','3í•™ë…„ ì§‘ì¤‘','ì ìˆ˜']);
const cp=ov.competencies||{};
[{k:'academic',l:'ğŸ“š í•™ì—…',clr:'4472C4'},{k:'career',l:'ğŸ¯ ì§„ë¡œ',clr:'5B9BD5'},{k:'community',l:'ğŸ¤ ê³µë™ì²´',clr:'70AD47'}].forEach(x=>{
const c=cp[x.k]||{};
s4.push([x.l,c.grade1||'',c.grade2||'',c.growth||'',c.grade3_focus||'',sc[x.k]||'']);
});
const ws4=XLSX.utils.aoa_to_sheet(s4);
ws4['!cols']=[{wch:12},{wch:40},{wch:40},{wch:30},{wch:30},{wch:8}];
ws4['!merges']=[{s:{r:0,c:0},e:{r:0,c:5}}];
ws4['!rows']=[{hpt:36},{hpt:6},{hpt:28},{hpt:140},{hpt:140},{hpt:140}];
setRowSt(ws4,0,6,XS.title);
setRowSt(ws4,2,6,XS.hdr);
[{k:'academic',clr:'4472C4'},{k:'career',clr:'5B9BD5'},{k:'community',clr:'70AD47'}].forEach((x,i)=>{
const row=3+i;
apS(ws4,XLSX.utils.encode_cell({r:row,c:0}),{font:{bold:true,sz:11,color:{rgb:'FFFFFF'}},fill:{fgColor:{rgb:x.clr}},alignment:{horizontal:'center',vertical:'center',wrapText:true}});
[1,2,3,4].forEach(c=>apS(ws4,XLSX.utils.encode_cell({r:row,c}),XS.body));
apS(ws4,XLSX.utils.encode_cell({r:row,c:5}),XS.score);
});
XLSX.utils.book_append_sheet(wb,ws4,'ì—­ëŸ‰ë¶„ì„');

// v4.2: êµì‚¬ ë©”ëª¨ ì‹œíŠ¸
const _tnote=(stu[m.sid]&&stu[m.sid].teacherNote)||'';
if(_tnote){
const tnData=[['êµì‚¬ ìƒë‹´ ê¸°ë¡ â€” '+m.nm,'',''],['ì‘ì„±ì¼: '+m.dt,'',''],[]];
_tnote.split('\n').forEach(line=>tnData.push([line,'','']));
const wsTN=XLSX.utils.aoa_to_sheet(tnData);
wsTN['!cols']=[{wch:80},{wch:15},{wch:15}];
wsTN['!merges']=[{s:{r:0,c:0},e:{r:0,c:2}}];
setRowSt(wsTN,0,3,XS.title);
setRowSt(wsTN,1,3,{font:{sz:9,color:{rgb:'8B95A1'}},alignment:{horizontal:'left',vertical:'center'}});
for(let r=3;r<tnData.length;r++)apS(wsTN,XLSX.utils.encode_cell({r,c:0}),XS.body);
XLSX.utils.book_append_sheet(wb,wsTN,'êµì‚¬ë©”ëª¨');
}

const _ntl=ov.naesinType||'';
XLSX.writeFile(wb,`ì„¸ê³µì‚¬_${m.nm}${_ntl?'_'+_ntl:''}.xlsx`)}

function dlAll(){if(!Object.keys(stu).length){alert('ë¶„ì„ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤');return}
const wb=XLSX.utils.book_new();
const allStu=Object.values(stu).sort((a,b)=>a.sid.localeCompare(b.sid));

// ===== ì‹œíŠ¸1: í•™ê¸‰ ëŒ€ì‹œë³´ë“œ =====
const sd=[];
sd.push(['ğŸ“Š ì„¸ê³µì‚¬ â€” í•™ê¸‰ ì „ëµ ë¶„ì„ ëŒ€ì‹œë³´ë“œ','','','','','','','','','']);
sd.push([]);
sd.push(['ë²ˆí˜¸','ì´ë¦„','ì§„ë¡œ','ë‚´ì‹ ','ìƒê¸°ë¶€í‰ì ','ì¢…í•©í‰ì ','í‹°ì–´','í•™ì—…','ì§„ë¡œ','ê³µë™ì²´','êµê³¼ë“±ê¸‰','í‚¤ì›Œë“œ']);
const _ts=classInfo.totalStudents||30;
for(let i=1;i<=_ts;i++){
const num=String(i).padStart(2,'0');
const found=allStu.find(s=>s.sid&&s.sid.endsWith(num));
if(found&&found.result&&!found.result._err){
const fo=found.result.overview||{},fs=fo.scores||{},fsa=found.result.subject_analysis||{};
sd.push([num,found.name||'',found.career||'',found.naesin||'',fo.gpa_gb||fo._gbGpa||'',fo.gpa||'',fo.tier||'',fs.academic||'',fs.career||'',fs.community||'',fsa.overall_grade||'',(fo.keywords||[]).map(k=>'#'+k).join(' ')]);
}else{sd.push([num,'','','','','','','','','','',''])}
}
const wsd=XLSX.utils.aoa_to_sheet(sd);
wsd['!cols']=[{wch:6},{wch:8},{wch:12},{wch:5},{wch:8},{wch:8},{wch:22},{wch:6},{wch:6},{wch:6},{wch:6},{wch:25}];
wsd['!merges']=[{s:{r:0,c:0},e:{r:0,c:11}}];
setRowSt(wsd,0,12,XS.title);
setRowSt(wsd,2,12,XS.hdr);
for(let i=3;i<3+_ts;i++){
apS(wsd,XLSX.utils.encode_cell({r:i,c:0}),XS.bodyC);
apS(wsd,XLSX.utils.encode_cell({r:i,c:1}),{font:{bold:true,sz:10,color:{rgb:'333D4B'}},alignment:{horizontal:'center',vertical:'center'}});
apS(wsd,XLSX.utils.encode_cell({r:i,c:4}),{font:{bold:true,sz:11,color:{rgb:'22B8CF'}},alignment:{horizontal:'center',vertical:'center'}});
apS(wsd,XLSX.utils.encode_cell({r:i,c:5}),{font:{bold:true,sz:12,color:{rgb:'1B5BD6'}},alignment:{horizontal:'center',vertical:'center'}});
for(let c=7;c<=9;c++)apS(wsd,XLSX.utils.encode_cell({r:i,c}),XS.score);
apS(wsd,XLSX.utils.encode_cell({r:i,c:10}),XS.bodyC);
apS(wsd,XLSX.utils.encode_cell({r:i,c:11}),XS.chip);
}
XLSX.utils.book_append_sheet(wb,wsd,'í•™ê¸‰ëŒ€ì‹œë³´ë“œ');

// ===== ì‹œíŠ¸2: ê¸°ì¬ ì¼ëŒí‘œ =====
const s1=[];
s1.push(['ì„¸ê³µì‚¬ â€” ì „ì²´ í•™ìƒ ê¸°ì¬ ì¼ëŒí‘œ','','','','','','','','','','']);
s1.push(['ë²ˆí˜¸','ì´ë¦„','ì§„ë¡œ','ììœ¨í™œë™ (1500B)','B','ì§„ë¡œí™œë™ (2100B)','B','ë™ì•„ë¦¬í™œë™ (1500B)','B','í–‰ë°œ (1500B)','B']);
for(let i=1;i<=_ts;i++){
const num=String(i).padStart(2,'0');
const found=allStu.find(s=>s.sid&&s.sid.endsWith(num));
if(found&&found.result&&!found.result._err){
const fj=found.result.jarhaeng||{};
const ja=fj.jayul?.option1?.text||'',ji=fj.jinro?.option1?.text||'',dg=fj.dongari?.option1?.text||'',hb=fj.hangbal?.option1?.text||'';
s1.push([num,found.name||'',found.career||'',ja,bl(ja),ji,bl(ji),dg,bl(dg),hb,bl(hb)]);
}else{s1.push([num,'','','',0,'',0,'',0,'',0])}
}
const ws1=XLSX.utils.aoa_to_sheet(s1);
ws1['!cols']=[{wch:6},{wch:8},{wch:12},{wch:52},{wch:5},{wch:55},{wch:5},{wch:52},{wch:5},{wch:52},{wch:5}];
ws1['!merges']=[{s:{r:0,c:0},e:{r:0,c:10}}];
ws1['!rows']=[{hpt:36},{hpt:26},...Array(30).fill({hpt:160})];
setRowSt(ws1,0,11,XS.title);
setRowSt(ws1,1,11,XS.hdr);
for(let i=2;i<32;i++){
apS(ws1,XLSX.utils.encode_cell({r:i,c:0}),XS.bodyC);
apS(ws1,XLSX.utils.encode_cell({r:i,c:1}),{font:{bold:true,sz:10,color:{rgb:'333D4B'}},alignment:{horizontal:'center',vertical:'center'}});
[3,5,7,9].forEach(c=>apS(ws1,XLSX.utils.encode_cell({r:i,c}),XS.body));
[4,6,8,10].forEach(c=>apS(ws1,XLSX.utils.encode_cell({r:i,c}),XS.byte));
}
XLSX.utils.book_append_sheet(wb,ws1,'ê¸°ì¬ì¼ëŒ');

// ===== ê°œë³„ í•™ìƒ ì‹œíŠ¸ =====
const areasDef=[{k:'jayul',l:'ììœ¨í™œë™',lm:1500,clr:'4472C4'},{k:'jinro',l:'ì§„ë¡œí™œë™',lm:2100,clr:'5B9BD5'},{k:'dongari',l:'ë™ì•„ë¦¬í™œë™',lm:1500,clr:'70AD47'},{k:'hangbal',l:'í–‰ë°œ',lm:1500,clr:'ED7D31'}];
allStu.forEach(s=>{
if(!s.result||s.result._err)return;
const rr=s.result,jh=rr.jarhaeng||{};
const d=[['ì„¸ê³µì‚¬ â€” ê°œì¸ ìƒë‹´ ê¸°ë¡ - '+s.sid+' '+s.name+(rr.overview?.gpa?' (í‰ì :'+rr.overview.gpa+')':''),'','','','','','','',''],
[],
['ì˜ì—­','ë“±ê¸‰','ì œí•œ','ì•ˆì „í˜•(A)','Byte','ë„ì „í˜•(S)','Byte','âœï¸ êµì‚¬ ê¸°ì…ë€','Byte']];
areasDef.forEach(a=>{
const ar=jh[a.k]||{},o1=ar.option1||{},o2=ar.option2||{};
d.push([a.l,ar.grade||'',a.lm+'B',o1.text||'',bl(o1.text||''),o2.text||'',bl(o2.text||''),'',0]);
});
const ws=XLSX.utils.aoa_to_sheet(d);
ws['!cols']=[{wch:16},{wch:5},{wch:7},{wch:52},{wch:5},{wch:52},{wch:5},{wch:52},{wch:5}];
ws['!merges']=[{s:{r:0,c:0},e:{r:0,c:8}}];
ws['!rows']=[{hpt:36},{hpt:6},{hpt:28},{hpt:200},{hpt:220},{hpt:200},{hpt:200}];
setRowSt(ws,0,9,XS.title);
setRowSt(ws,2,9,XS.hdr);
apS(ws,XLSX.utils.encode_cell({r:2,c:7}),{font:{bold:true,sz:11,color:{rgb:'FFFFFF'}},fill:{fgColor:{rgb:'FF6B6B'}},alignment:{horizontal:'center',vertical:'center',wrapText:true}});
areasDef.forEach((a,i)=>{
const row=3+i;
apS(ws,XLSX.utils.encode_cell({r:row,c:0}),{font:{bold:true,sz:11,color:{rgb:'FFFFFF'}},fill:{fgColor:{rgb:a.clr}},alignment:{horizontal:'center',vertical:'center',wrapText:true}});
apS(ws,XLSX.utils.encode_cell({r:row,c:1}),XS.bodyC);
apS(ws,XLSX.utils.encode_cell({r:row,c:2}),XS.bodyC);
apS(ws,XLSX.utils.encode_cell({r:row,c:3}),XS.body);
apS(ws,XLSX.utils.encode_cell({r:row,c:4}),XS.byte);
apS(ws,XLSX.utils.encode_cell({r:row,c:5}),XS.body);
apS(ws,XLSX.utils.encode_cell({r:row,c:6}),XS.byte);
apS(ws,XLSX.utils.encode_cell({r:row,c:7}),XS.teacher);
apS(ws,XLSX.utils.encode_cell({r:row,c:8}),XS.byte);
});
// v4.2: êµì‚¬ ë©”ëª¨ê°€ ìˆìœ¼ë©´ í•˜ë‹¨ì— ì¶”ê°€
if(s.teacherNote){
const tnRow=d.length;
d.push([]);d.push(['ğŸ“ êµì‚¬ ìƒë‹´ ê¸°ë¡','','','','','','','','']);
d.push([s.teacherNote,'','','','','','','','']);
const ws2=XLSX.utils.aoa_to_sheet(d);
// ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì¬ì ìš© í•„ìš”í•˜ë¯€ë¡œ wsì— ì§ì ‘ ì¶”ê°€
ws[XLSX.utils.encode_cell({r:tnRow+1,c:0})]={v:'ğŸ“ êµì‚¬ ìƒë‹´ ê¸°ë¡',t:'s',s:{font:{bold:true,sz:11,color:{rgb:'FF6B6B'}}}};
ws[XLSX.utils.encode_cell({r:tnRow+2,c:0})]={v:s.teacherNote,t:'s',s:XS.body};
ws['!ref']=XLSX.utils.encode_range({s:{r:0,c:0},e:{r:tnRow+2,c:8}});
}
const sheetName=(s.sid+'_'+s.name).substring(0,31);
XLSX.utils.book_append_sheet(wb,ws,sheetName);
});

const _nt2=document.getElementById('sNaesinType')?.value||'all';
const _ntl2={all:'ì „ì²´êµê³¼',mss:'êµ­ì˜ìˆ˜ì‚¬',msn:'êµ­ì˜ìˆ˜ê³¼',best:'ìµœìœ ë¦¬'}[_nt2]||'';
XLSX.writeFile(wb,`ì„¸ê³µì‚¬_${classInfo.grade||3}í•™ë…„${classInfo.cls||''}ë°˜${_ntl2?'_'+_ntl2:''}.xlsx`)}

function rStu(){const l=document.getElementById('stuL'),e=Object.values(stu).sort((a,b)=>a.sid.localeCompare(b.sid));
const okCount=e.filter(s=>s.result&&!s.result._err).length;
document.getElementById('stuCnt').textContent=okCount+'ëª… ì™„ë£Œ'+(e.length>okCount?` (${e.length-okCount}ëª… ì¬ë¶„ì„ í•„ìš”)`:'');
if(!e.length){l.innerHTML='<div style="padding:20px;color:var(--g4);text-align:center;font-size:14px">ì•„ì§ ë¶„ì„ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</div>';return}
l.innerHTML=e.map(s=>{
const hasErr=!s.result||s.result._err;
const num=s.sid.length>=5?s.sid.substring(3):s.sid;
return`<div class="si" style="cursor:pointer${hasErr?';opacity:.5':''}" onclick="viewStudent('${s.sid}')">
<span><span class="num">${num}ë²ˆ</span><strong>${s.name}</strong>${hasErr?'<span style="color:var(--coral);font-size:11px;margin-left:6px">âš  ì¬ë¶„ì„</span>':''}</span>
<span style="display:flex;align-items:center;gap:6px">
<span class="meta">${s.career} Â· ${s.date}</span>
${hasErr?'':'<button class="btn btn-sm" style="padding:4px 10px;font-size:11px;background:var(--green-bg);color:var(--green);border:none;border-radius:6px;cursor:pointer" onclick="event.stopPropagation();dlStudentPDF(\''+s.sid+'\')">PDF</button>'}
<button style="padding:4px 8px;font-size:11px;background:var(--coral-bg);color:var(--coral);border:none;border-radius:6px;cursor:pointer;font-weight:600" onclick="event.stopPropagation();delStudent('${s.sid}')">âœ•</button>
</span></div>`}).join('')}
function delStudent(sid){if(!confirm((stu[sid]?.name||sid)+' í•™ìƒ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;delete stu[sid];saveClassStudents();rStu();updateBanner();if(cur&&cur._m&&cur._m.sid===sid){cur=null;document.getElementById('resS').style.display='none'}}

function next(){document.getElementById('resS').style.display='none';
['tc-ov','tc-jh','tc-se','tc-cl','tc-co'].forEach(id=>{const e=document.getElementById(id);if(e)e.innerHTML=''});
cur=null;['sName','sCareer','sClub','memo','sNaesinAll','sNaesinMSS','sNaesinMSN','sUniv','sMajor'].forEach(id=>document.getElementById(id).value='');
document.getElementById('sNaesinType').value='all';
pdf='';const d=document.getElementById('dz');d.classList.remove('done');d.querySelector('.dz-i').textContent='ğŸ“';
d.querySelector('.dz-m').textContent='PDF íŒŒì¼ ì„ íƒ';d.querySelector('.dz-s').textContent='1, 2í•™ë…„ ìƒê¸°ë¶€ í¬í•¨';
document.getElementById('fI').classList.add('hidden');document.getElementById('fi').value='';
const curNo=parseInt(document.getElementById('sNo').value)||0;
if(curNo<40)document.getElementById('sNo').value=String(curNo+1).padStart(2,'0');
updPreview();chk();window.scrollTo({top:0,behavior:'smooth'})}
</script>
</body>
</html>
