<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìƒê¸°ë¶€ ì„±ì¥ ë¶„ì„ê¸°</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;900&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Noto Sans KR',sans-serif;background:#080b14;color:#e2e8f0;min-height:100vh;overflow-x:hidden}
@keyframes fadeUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
@keyframes spin{to{transform:rotate(360deg)}}

.bg{position:fixed;top:0;left:0;right:0;bottom:0;z-index:0;pointer-events:none;
  background:radial-gradient(ellipse at 25% 0%,rgba(99,102,241,0.08) 0%,transparent 60%),
             radial-gradient(ellipse at 75% 100%,rgba(16,185,129,0.05) 0%,transparent 60%)}

.wrap{max-width:800px;margin:0 auto;padding:36px 20px 100px;position:relative;z-index:1}
.hdr{text-align:center;margin-bottom:32px;animation:fadeUp .5s ease both}
.hdr-tag{display:inline-flex;align-items:center;gap:8px;padding:5px 16px;border-radius:40px;background:rgba(99,102,241,0.08);border:1px solid rgba(99,102,241,0.2);margin-bottom:14px;font-size:11px;font-weight:600;color:#a5b4fc;letter-spacing:2px}
.hdr h1{font-family:'Outfit',sans-serif;font-size:32px;font-weight:800;color:#f8fafc;margin-bottom:6px}
.hdr h1 em{font-style:normal;background:linear-gradient(135deg,#818cf8,#c084fc,#22d3ee);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hdr p{font-size:12px;color:rgba(255,255,255,0.35);line-height:1.5}

/* Steps indicator */
.steps{display:flex;justify-content:center;gap:4px;margin-bottom:28px;flex-wrap:wrap}
.st{padding:6px 14px;border-radius:20px;font-size:11px;font-weight:600;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:rgba(255,255,255,0.3);transition:.3s}
.st.on{background:rgba(99,102,241,0.12);border-color:rgba(99,102,241,0.3);color:#a5b4fc}
.st.done{background:rgba(16,185,129,0.08);border-color:rgba(16,185,129,0.2);color:#6ee7b7}

.cd{background:rgba(255,255,255,0.025);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:22px;margin-bottom:14px;transition:.3s;animation:fadeUp .5s ease both}
.cd:hover{border-color:rgba(255,255,255,0.1)}
.sl{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.sl .ic{font-size:15px}.sl .tx{font-size:13px;font-weight:700;color:#f1f5f9}.sl .sub{font-size:11px;color:rgba(255,255,255,0.3);margin-top:1px}

input,textarea,select{width:100%;padding:10px 12px;border-radius:10px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);color:#e2e8f0;font-size:13px;font-family:'Noto Sans KR',sans-serif;outline:none;transition:.2s}
input:focus,textarea:focus,select:focus{border-color:rgba(99,102,241,0.4)}
textarea{resize:vertical;line-height:1.8}
label{font-size:11px;color:rgba(255,255,255,0.4);font-weight:500;margin-bottom:4px;display:block}
select{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}

.upload{text-align:center;cursor:pointer;padding:28px 16px;border:1.5px dashed rgba(139,92,246,0.25);border-radius:16px;background:rgba(139,92,246,0.03);transition:.3s}
.upload:hover{border-color:rgba(139,92,246,0.45);background:rgba(139,92,246,0.06)}
.upload.dragging{border-color:rgba(99,102,241,0.7)!important;background:rgba(99,102,241,0.1)!important}
.upload.done{border-color:rgba(16,185,129,0.4);background:rgba(16,185,129,0.04)}

.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
@media(max-width:640px){.g2,.g3{grid-template-columns:1fr}}

.btn{padding:14px;border-radius:12px;border:none;font-size:15px;font-weight:700;cursor:pointer;font-family:'Noto Sans KR',sans-serif;transition:.3s;width:100%;display:flex;align-items:center;justify-content:center;gap:8px}
.btn-primary{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;box-shadow:0 4px 20px rgba(99,102,241,0.3)}
.btn-primary:hover{transform:translateY(-2px)}
.btn-green{background:linear-gradient(135deg,#10b981,#059669);color:#fff;box-shadow:0 4px 20px rgba(16,185,129,0.3)}
.btn-green:hover{transform:translateY(-2px)}
.btn-green.copied{background:rgba(16,185,129,0.15);color:#6ee7b7;border:1px solid rgba(16,185,129,0.3);box-shadow:none}
.btn-sm{padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Noto Sans KR',sans-serif;border:none;display:inline-flex;align-items:center;gap:5px;transition:.2s}

.ai-links{display:flex;gap:6px;justify-content:center;flex-wrap:wrap;margin-top:14px}
.ai-link{padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;text-decoration:none;display:inline-flex;align-items:center;gap:5px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.03);color:rgba(255,255,255,0.5);transition:.2s}
.ai-link:hover{background:rgba(255,255,255,0.06);color:#e2e8f0}

.dl-row{display:flex;gap:8px;justify-content:center;margin-top:16px;flex-wrap:wrap}
.dl-btn{padding:10px 20px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;font-family:'Noto Sans KR',sans-serif;border:none;display:inline-flex;align-items:center;gap:6px;transition:.2s}
.dl-pdf{background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);color:#fca5a5}
.dl-pdf:hover{background:rgba(239,68,68,0.15)}
.dl-xl{background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);color:#6ee7b7}
.dl-xl:hover{background:rgba(16,185,129,0.15)}
.dl-rst{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);color:rgba(255,255,255,0.4)}
.dl-rst:hover{background:rgba(255,255,255,0.06)}

.prompt-box{background:rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:14px;font-size:11px;line-height:1.7;color:rgba(255,255,255,0.4);font-family:monospace;max-height:200px;overflow-y:auto;white-space:pre-wrap;word-break:break-all;margin-bottom:10px}
.result-box{background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:14px;font-size:12px;line-height:1.8;color:rgba(255,255,255,0.55);max-height:250px;overflow-y:auto;white-space:pre-wrap;word-break:break-all}

/* Student list */
.stu-list{max-height:200px;overflow-y:auto;margin-top:10px}
.stu-row{display:flex;align-items:center;gap:10px;padding:6px 10px;border-radius:8px;font-size:12px;color:rgba(255,255,255,0.5);transition:.2s}
.stu-row:hover{background:rgba(255,255,255,0.03)}
.stu-num{min-width:24px;height:24px;border-radius:6px;background:rgba(99,102,241,0.1);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#a5b4fc}
.stu-name{font-weight:600;color:#e2e8f0}
.stu-done{color:#10b981;font-size:10px;margin-left:auto}

.spinner{width:40px;height:40px;border-radius:50%;border:3px solid rgba(99,102,241,0.12);border-top-color:#6366f1;animation:spin .8s linear infinite;margin:0 auto 14px}
.hidden{display:none!important}
.err{padding:10px 14px;border-radius:10px;margin-bottom:14px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);color:#fca5a5;font-size:13px}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:3px}
.toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(20px);padding:10px 22px;border-radius:10px;background:rgba(16,185,129,0.95);color:#fff;font-size:13px;font-weight:600;z-index:9999;opacity:0;transition:.3s;pointer-events:none}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>
<div class="bg"></div>
<div class="wrap">

  <div class="hdr">
    <div class="hdr-tag">ğŸ“ 3í•™ë…„ ë‹´ì„ AI ìƒê¸°ë¶€ ì»¨ì„¤íŒ…</div>
    <h1>ìƒê¸°ë¶€ <em>ì„±ì¥ ë¶„ì„ê¸°</em></h1>
    <p>PDF ì—…ë¡œë“œ â†’ AI í”„ë¡¬í”„íŠ¸ ìƒì„± â†’ ê²°ê³¼ ë¶™ì—¬ë„£ê¸° â†’ PDF ë³´ê³ ì„œ + ì—‘ì…€ ì €ì¥<br>ChatGPT Â· Claude Â· Gemini ì–´ë””ë“  ì‚¬ìš© | API í‚¤ ë¶ˆí•„ìš”</p>
  </div>

  <div class="steps">
    <div class="st on" id="s1">â‘  PDF ì—…ë¡œë“œ</div>
    <div class="st" id="s2">â‘¡ í”„ë¡¬í”„íŠ¸ ë³µì‚¬</div>
    <div class="st" id="s3">â‘¢ AI ê²°ê³¼ ë¶™ì—¬ë„£ê¸°</div>
    <div class="st" id="s4">â‘£ PDFÂ·ì—‘ì…€ ì €ì¥</div>
  </div>

  <!-- ==================== STEP 1: INPUT ==================== -->
  <div id="P1">
    <!-- Student selector -->
    <div class="cd">
      <div class="sl"><span class="ic">ğŸ“‹</span><div><div class="tx">í•™ìƒ ì„ íƒ (1~25ë²ˆ)</div><div class="sub">ë²ˆí˜¸ë³„ë¡œ ìˆœì°¨ ë¶„ì„í•˜ë©´ ì—‘ì…€ì— ìë™ ëˆ„ì ë©ë‹ˆë‹¤</div></div></div>
      <div class="g3">
        <div><label>ë²ˆí˜¸</label><select id="i-num"></select></div>
        <div><label>í•™ìƒ ì´ë¦„</label><input id="i-name" placeholder="í™ê¸¸ë™"></div>
        <div><label>í¬ë§ ì§„ë¡œ / í•™ê³¼</label><input id="i-major" placeholder="ê²½ì˜í•™ê³¼"></div>
      </div>
      <div class="g2" style="margin-top:8px">
        <div><label>3í•™ë…„ ë™ì•„ë¦¬ëª…</label><input id="i-club" placeholder="ë¸”ë£¨ì˜¤ì…˜"></div>
        <div><label>ë¶„ì„ëœ í•™ìƒ ìˆ˜</label><input id="i-cnt" value="0 / 25ëª…" disabled style="text-align:center;color:#a5b4fc"></div>
      </div>
    </div>

    <!-- PDF Upload -->
    <div id="upload-area" class="upload cd" onclick="$('pdf-file').click()"
         ondragover="event.preventDefault();this.classList.add('dragging')"
         ondragenter="event.preventDefault();this.classList.add('dragging')"
         ondragleave="this.classList.remove('dragging')"
         ondrop="handleDrop(event)">
      <input type="file" id="pdf-file" accept=".pdf" style="display:none" onchange="handleFile(this.files[0])">
      <div id="up-idle">
        <div style="font-size:36px;margin-bottom:6px">ğŸ“„</div>
        <div style="font-size:15px;font-weight:700;color:#e2e8f0;margin-bottom:3px">ìƒê¸°ë¶€ PDF ì—…ë¡œë“œ</div>
        <div style="font-size:12px;color:rgba(255,255,255,0.35)">í´ë¦­ ë˜ëŠ” <b style="color:rgba(255,255,255,0.6)">ë“œë˜ê·¸ & ë“œë¡­</b></div>
      </div>
      <div id="up-spin" class="hidden"><div class="spinner" style="border-top-color:#a78bfa"></div><div id="up-msg" style="font-size:13px;font-weight:600;color:#c4b5fd">ì¶”ì¶œ ì¤‘...</div></div>
      <div id="up-ok" class="hidden">
        <div style="font-size:28px;margin-bottom:3px">âœ…</div>
        <div style="font-size:15px;font-weight:700;color:#10b981">PDF ì¶”ì¶œ ì™„ë£Œ</div>
        <div id="up-info" style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:3px"></div>
        <div style="margin-top:8px;font-size:11px;color:rgba(255,255,255,0.25);cursor:pointer" onclick="event.stopPropagation();resetUp()">ğŸ”„ ë³€ê²½</div>
      </div>
    </div>

    <details style="margin-bottom:12px"><summary style="font-size:11px;color:rgba(255,255,255,0.2);cursor:pointer;text-align:center;padding:6px">ğŸ“ í…ìŠ¤íŠ¸ ì§ì ‘ ì…ë ¥</summary>
      <div class="cd" style="margin-top:6px"><textarea id="i-text" rows="8" placeholder="ìƒê¸°ë¶€ ì „ì²´ í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸°..."></textarea></div>
    </details>

    <!-- Extra info -->
    <div class="cd">
      <div class="sl"><span class="ic">ğŸ’¡</span><div><div class="tx">ìƒë‹´ ì¶”ê°€ ì •ë³´ & í‚¤ì›Œë“œ (ì„ íƒ)</div><div class="sub">ì…ë ¥í•˜ë©´ AI ê²°ê³¼ê°€ ë” ë§ì¶¤í™”ë©ë‹ˆë‹¤</div></div></div>
      <textarea id="i-extra" rows="3" placeholder="ì˜ˆ: ë°ì´í„°ë¶„ì„ ê´€ì‹¬, ESG í‚¤ì›Œë“œ ê°•ì¡°, ë°œí‘œë ¥ ë³´ì™„ í•„ìš”..."></textarea>
    </div>

    <div id="err1" class="err hidden"></div>
    <button class="btn btn-primary" onclick="genPrompt()">âœ¨ AI í”„ë¡¬í”„íŠ¸ ìƒì„±</button>
  </div>

  <!-- ==================== STEP 2: PROMPT ==================== -->
  <div id="P2" class="hidden">
    <div class="cd" style="text-align:center">
      <div style="font-size:24px;margin-bottom:4px">ğŸ“‹</div>
      <div style="font-size:16px;font-weight:800;color:#f1f5f9;margin-bottom:3px">í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ!</div>
      <div style="font-size:12px;color:rgba(255,255,255,0.35)">ë³µì‚¬ â†’ AIì— ë¶™ì—¬ë„£ê¸° â†’ ê²°ê³¼ ë°›ê¸°</div>
    </div>

    <button id="cp-btn" class="btn btn-green" onclick="copyPrompt()">ğŸ“‹ í”„ë¡¬í”„íŠ¸ ì „ì²´ ë³µì‚¬</button>
    <div class="ai-links">
      <a href="https://claude.ai/new" target="_blank" class="ai-link">ğŸŸ  Claude</a>
      <a href="https://chatgpt.com" target="_blank" class="ai-link">ğŸŸ¢ ChatGPT</a>
      <a href="https://gemini.google.com" target="_blank" class="ai-link">ğŸ”µ Gemini</a>
    </div>

    <div class="cd" style="margin-top:14px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-size:12px;font-weight:600;color:rgba(255,255,255,0.4)">ìƒì„±ëœ í”„ë¡¬í”„íŠ¸</span>
        <span style="font-size:11px;color:rgba(255,255,255,0.25)"><span id="p-chars">0</span>ì</span>
      </div>
      <div class="prompt-box" id="p-display"></div>
    </div>

    <button class="btn btn-primary" style="margin-top:4px" onclick="goStep3()">ë‹¤ìŒ: AI ê²°ê³¼ ë¶™ì—¬ë„£ê¸° â†’</button>
    <div style="text-align:center;margin-top:6px"><button class="btn-sm" style="background:rgba(255,255,255,0.03);color:rgba(255,255,255,0.3)" onclick="goStep(1)">â† ëŒì•„ê°€ê¸°</button></div>
  </div>

  <!-- ==================== STEP 3: PASTE RESULT ==================== -->
  <div id="P3" class="hidden">
    <div class="cd" style="text-align:center">
      <div style="font-size:24px;margin-bottom:4px">âœï¸</div>
      <div style="font-size:16px;font-weight:800;color:#f1f5f9;margin-bottom:3px">AI ê²°ê³¼ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”</div>
      <div style="font-size:12px;color:rgba(255,255,255,0.35)">Claude/ChatGPT/Geminiì—ì„œ ë°›ì€ ë¶„ì„ ê²°ê³¼ ì „ì²´ë¥¼ ì•„ë˜ì— ë¶™ì—¬ë„£ê¸°</div>
    </div>

    <div class="cd">
      <textarea id="i-result" rows="14" placeholder="AIê°€ ìƒì„±í•œ ë¶„ì„ ê²°ê³¼ë¥¼ ì—¬ê¸°ì— Ctrl+Vë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”...&#10;&#10;ì „ì²´ ë¶„ì„ ê²°ê³¼ë¥¼ í†µì§¸ë¡œ ë³µì‚¬í•´ì„œ ë„£ì–´ì£¼ì„¸ìš”.&#10;ë³´ê³ ì„œ í˜•íƒœ ê·¸ëŒ€ë¡œ PDFê°€ ìƒì„±ë©ë‹ˆë‹¤."></textarea>
      <div style="text-align:right;margin-top:4px;font-size:11px;color:rgba(255,255,255,0.2)"><span id="r-chars">0</span>ì</div>
    </div>

    <div id="err3" class="err hidden"></div>
    <button class="btn btn-primary" onclick="processResult()">ğŸ“„ PDF ë³´ê³ ì„œ ìƒì„± + ì—‘ì…€ ì €ì¥</button>
    <div style="text-align:center;margin-top:6px"><button class="btn-sm" style="background:rgba(255,255,255,0.03);color:rgba(255,255,255,0.3)" onclick="goStep(2)">â† í”„ë¡¬í”„íŠ¸ë¡œ</button></div>
  </div>

  <!-- ==================== STEP 4: DOWNLOAD ==================== -->
  <div id="P4" class="hidden">
    <div class="cd" style="text-align:center">
      <div style="font-size:28px;margin-bottom:4px">ğŸ‰</div>
      <div style="font-size:18px;font-weight:800;color:#f1f5f9;margin-bottom:3px" id="done-title">ë³´ê³ ì„œ ì™„ì„±!</div>
      <div style="font-size:12px;color:rgba(255,255,255,0.35)" id="done-sub"></div>
    </div>

    <!-- Preview -->
    <div class="cd">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-size:13px;font-weight:600;color:#f1f5f9">ğŸ“„ ë³´ê³ ì„œ ë¯¸ë¦¬ë³´ê¸°</span>
      </div>
      <div class="result-box" id="preview-box"></div>
    </div>

    <div class="dl-row">
      <button class="dl-btn dl-pdf" onclick="downloadPdf()">ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ</button>
      <button class="dl-btn dl-xl" onclick="downloadXlsx()">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ì „ì²´ í•™ìƒ)</button>
    </div>

    <!-- Student list -->
    <div class="cd" style="margin-top:14px">
      <div class="sl"><span class="ic">ğŸ“Š</span><div><div class="tx">ë¶„ì„ ì™„ë£Œ í•™ìƒ ëª©ë¡</div><div class="sub">ì—‘ì…€ì— ëª¨ë‘ í¬í•¨ë©ë‹ˆë‹¤</div></div></div>
      <div class="stu-list" id="stu-list"></div>
    </div>

    <button class="btn btn-primary" style="margin-top:10px" onclick="nextStudent()">â¡ï¸ ë‹¤ìŒ í•™ìƒ ë¶„ì„í•˜ê¸°</button>
    <div style="text-align:center;margin-top:6px"><button class="btn-sm" style="background:rgba(255,255,255,0.03);color:rgba(255,255,255,0.3)" onclick="goStep(1)">â† ì²˜ìŒìœ¼ë¡œ</button></div>
  </div>

</div>
<div class="toast" id="toast"></div>

<script>
if(window.pdfjsLib)pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
const $=id=>document.getElementById(id);

// ====== DATA ======
let D = {
  pdfText: '',
  prompt: '',
  students: [], // {num, name, major, club, resultText, date}
  currentNum: 1
};

// Load from localStorage
try { const s=localStorage.getItem('sgb_students'); if(s) D.students=JSON.parse(s); } catch(e){}

// Init student number selector
const sel=$('i-num');
for(let i=1;i<=25;i++){const o=document.createElement('option');o.value=i;o.textContent=i+'ë²ˆ';sel.appendChild(o)}
sel.value = D.students.length>0 ? Math.min(D.students.length+1,25) : 1;
updateCount();

$('i-result').addEventListener('input',e=>{$('r-chars').textContent=e.target.value.length.toLocaleString()});

function updateCount(){
  $('i-cnt').value=`${D.students.length} / 25ëª… ì™„ë£Œ`;
}

function setStep(n){
  for(let i=1;i<=4;i++){$('s'+i).classList.remove('on','done');if(i<n)$('s'+i).classList.add('done');else if(i===n)$('s'+i).classList.add('on')}
}

function goStep(n){
  ['P1','P2','P3','P4'].forEach((id,i)=>{$(id).classList.toggle('hidden',i+1!==n)});
  setStep(n);window.scrollTo({top:0,behavior:'smooth'});
}

// ====== PDF UPLOAD ======
function handleDrop(e){e.preventDefault();e.stopPropagation();e.currentTarget.classList.remove('dragging');
  const f=e.dataTransfer?.files?.[0];if(f&&(f.type==='application/pdf'||f.name.endsWith('.pdf')))handleFile(f);else showErr('err1','PDF íŒŒì¼ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.')}

async function handleFile(file){
  if(!file)return;hideErr('err1');
  $('up-idle').classList.add('hidden');$('up-ok').classList.add('hidden');$('up-spin').classList.remove('hidden');
  $('upload-area').classList.remove('done');
  try{
    const buf=await file.arrayBuffer();const pdf=await pdfjsLib.getDocument({data:buf}).promise;
    let text='';
    for(let i=1;i<=pdf.numPages;i++){
      $('up-msg').textContent=`ì¶”ì¶œ ì¤‘... (${i}/${pdf.numPages})`;
      const pg=await pdf.getPage(i);const ct=await pg.getTextContent();
      text+=ct.items.map(it=>it.str).join(' ')+'\n\n'}
    D.pdfText=text.trim();
    if(D.pdfText.length<50)throw new Error('í…ìŠ¤íŠ¸ ë¶€ì¡±');
    const nm=D.pdfText.match(/ì„±ëª…[:\s]*([ê°€-í£]{2,4})/);if(nm)$('i-name').value=nm[1];
    $('up-spin').classList.add('hidden');$('up-ok').classList.remove('hidden');$('upload-area').classList.add('done');
    $('up-info').textContent=`${$('i-name').value||''} | ${D.pdfText.length.toLocaleString()}ì | ${pdf.numPages}p`;
  }catch(err){$('up-spin').classList.add('hidden');$('up-idle').classList.remove('hidden');showErr('err1','PDF ì¶”ì¶œ ì‹¤íŒ¨. í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.')}
}

function resetUp(){D.pdfText='';$('upload-area').classList.remove('done');$('up-idle').classList.remove('hidden');$('up-ok').classList.add('hidden');$('pdf-file').value=''}

// ====== STEP 1â†’2: GENERATE PROMPT ======
function genPrompt(){
  const content=D.pdfText||$('i-text')?.value?.trim()||'';
  if(content.length<50){showErr('err1','ìƒê¸°ë¶€ ë‚´ìš©ì´ í•„ìš”í•©ë‹ˆë‹¤.');return}
  hideErr('err1');
  const name=$('i-name').value||'(ë¯¸ì…ë ¥)',major=$('i-major').value,club=$('i-club').value,extra=$('i-extra').value;

  let p=`# ìƒê¸°ë¶€ ì¢…í•© ë¶„ì„ ìš”ì²­

ë‹¹ì‹ ì€ í•œêµ­ ê³ ë“±í•™êµ 3í•™ë…„ ë‹´ì„êµì‚¬ë¥¼ ìœ„í•œ **ì „ë¬¸ ìƒê¸°ë¶€ ì»¨ì„¤íŒ… AI**ì…ë‹ˆë‹¤.
ì•„ë˜ í•™ìƒì˜ 1,2í•™ë…„ í•™êµìƒí™œê¸°ë¡ë¶€ë¥¼ ë¶„ì„í•˜ì—¬ ì¢…í•© ì»¨ì„¤íŒ… ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

## í•™ìƒ ì •ë³´
- ì´ë¦„: ${name}
${major?'- í¬ë§ ì§„ë¡œ: '+major:'- í¬ë§ ì§„ë¡œ: (ê¸°ë¡ì—ì„œ ì¶”ì •)'}
${club?'- 3í•™ë…„ ë™ì•„ë¦¬: '+club:''}
${extra?'\n## ë‹´ì„ ì¶”ê°€ ì •ë³´ (ë°˜ë“œì‹œ ë°˜ì˜)\n'+extra+'\n':''}
## ë¶„ì„ í•­ëª© (ëª¨ë‘ ì‘ì„±)

### 1. 4ëŒ€ ì—­ëŸ‰ ì„±ì¥ ë¶„ì„
ì§„ë¡œì—­ëŸ‰/í•™ì—…ì—­ëŸ‰/ê³µë™ì²´ì—­ëŸ‰/ì¸ì„±ì—­ëŸ‰ ê°ê°:
- 1í•™ë…„ ë¶„ì„ (4~5ë¬¸ì¥), 2í•™ë…„ ë¶„ì„ (4~5ë¬¸ì¥), ì„±ì¥ í¬ì¸íŠ¸ (3~4ë¬¸ì¥), ë“±ê¸‰ (A+/A/B+/B/C)

### 2. ììœ¨Â·ì§„ë¡œÂ·í–‰ë™íŠ¹ì„± í‰ê°€ ë° 3í•™ë…„ ì˜ˆì‹œ ë¬¸êµ¬
ê° ì˜ì—­ë³„: 1,2í•™ë…„ í‰ê°€ + ë“±ê¸‰, 3í•™ë…„ ë°©í–¥, **ì‹¤ì œ ìƒê¸°ë¶€ì— ë°”ë¡œ ê¸°ì¬ ê°€ëŠ¥í•œ 3í•™ë…„ ì˜ˆì‹œ ë¬¸êµ¬** (ììœ¨ 250~350ì, ì§„ë¡œ 250~350ì, í–‰ë°œ 400~500ì)

### 3. 3í•™ë…„ ì„¸íŠ¹ ì „ëµ
ì „ì²´ ë°©í–¥ + ê³¼ëª©ë³„ (ë°©í–¥ 4~5ë¬¸ì¥, ì¶”ì²œ íƒêµ¬ì£¼ì œ 3ê°œ, ê¸°ì¬ ì˜ˆì‹œ 2~3ë¬¸ì¥)

### 4. ë™ì•„ë¦¬ í™œë™ ê³„íš
ë™ì•„ë¦¬ëª… ì œì•ˆ 2ê°œ, ëª©í‘œ, ì›”ë³„ ê³„íš(3~11ì›”), í”„ë¡œì íŠ¸ 2~3ê°œ, ê¸°ë¡ ì „ëµ

### 5. ìƒë‹´ ê°€ì´ë“œ
ê°•ì  3ê°œ, ë³´ì™„ 3ê°œ, ìƒë‹´ ì§ˆë¬¸ 3ê°œ, ì¶”ì²œ í™œë™ 3ê°œ, í•™ë¶€ëª¨ í¬ì¸íŠ¸ 3ê°œ

### 6. ì¢…í•© ê²°ë¡  (5~6ë¬¸ì¥)

## ì£¼ì˜ì‚¬í•­
- ì‹¤ì œ ê¸°ë¡ ê¸°ë°˜ ë¶„ì„, ì˜ˆì‹œ ë¬¸êµ¬ëŠ” ë°”ë¡œ í™œìš© ê°€ëŠ¥ ìˆ˜ì¤€
- 3í•™ë…„ ë°©í–¥ì€ 1~2í•™ë…„ ì„±ì¥ ì„œì‚¬ì™€ ì—°ê²°
- êµ¬ì²´ì  í™œë™ëª…/í‚¤ì›Œë“œ ì‚¬ìš©, ì¶”ìƒì  í‘œí˜„ ê¸ˆì§€
${extra?'- ë‹´ì„ ì¶”ê°€ ì •ë³´ ë°˜ë“œì‹œ ë°˜ì˜':''}

---

## í•™êµìƒí™œê¸°ë¡ë¶€ ì „ë¬¸

${content}`;

  D.prompt=p;
  $('p-display').textContent=p;
  $('p-chars').textContent=p.length.toLocaleString();
  goStep(2);
}

function copyPrompt(){
  navigator.clipboard.writeText(D.prompt).then(()=>{
    const b=$('cp-btn');b.className='btn btn-green copied';b.innerHTML='âœ… ë³µì‚¬ ì™„ë£Œ! AIì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”';
    toast('í”„ë¡¬í”„íŠ¸ ë³µì‚¬ë¨!');
    setTimeout(()=>{b.className='btn btn-green';b.innerHTML='ğŸ“‹ í”„ë¡¬í”„íŠ¸ ì „ì²´ ë³µì‚¬'},3000);
  }).catch(()=>{toast('ë³µì‚¬ ì‹¤íŒ¨ - ìˆ˜ë™ìœ¼ë¡œ ì„ íƒ í›„ ë³µì‚¬í•˜ì„¸ìš”')})}

function goStep3(){goStep(3);$('i-result').value='';$('r-chars').textContent='0'}

// ====== STEP 3â†’4: PROCESS RESULT ======
function processResult(){
  const txt=$('i-result').value.trim();
  if(txt.length<200){showErr('err3','AI ê²°ê³¼ë¥¼ ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”. (ìµœì†Œ 200ì)');return}
  hideErr('err3');

  const num=parseInt($('i-num').value);
  const name=$('i-name').value||'í•™ìƒ'+num;
  const major=$('i-major').value||'';
  const club=$('i-club').value||'';

  // Save student data
  const existing=D.students.findIndex(s=>s.num===num);
  const record={num,name,major,club,resultText:txt,date:new Date().toLocaleDateString('ko-KR')};
  if(existing>=0)D.students[existing]=record;else D.students.push(record);
  D.students.sort((a,b)=>a.num-b.num);
  try{localStorage.setItem('sgb_students',JSON.stringify(D.students))}catch(e){}
  updateCount();

  // Show step 4
  $('done-title').textContent=`${name} í•™ìƒ ë³´ê³ ì„œ ì™„ì„±!`;
  $('done-sub').textContent=`${num}ë²ˆ | ${major||'ì§„ë¡œ ë¯¸ì…ë ¥'} | ${new Date().toLocaleDateString('ko-KR')}`;
  $('preview-box').textContent=txt.substring(0,1500)+(txt.length>1500?'\n\n... (ì „ì²´ ë‚´ìš©ì€ PDFì—ì„œ í™•ì¸)':'');

  // Render student list
  $('stu-list').innerHTML=D.students.map(s=>`<div class="stu-row"><div class="stu-num">${s.num}</div><span class="stu-name">${s.name}</span><span style="font-size:11px;color:rgba(255,255,255,0.3)">${s.major||''}</span><span class="stu-done">âœ“ ${s.date}</span></div>`).join('');

  goStep(4);
}

// ====== PDF DOWNLOAD ======
function downloadPdf(){
  const num=parseInt($('i-num').value);
  const stu=D.students.find(s=>s.num===num);
  if(!stu){toast('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');return}

  const name=stu.name;
  // Convert markdown-like text to HTML
  let html=stu.resultText
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/^### (.+)$/gm,'<h3 style="color:#1e40af;border-left:4px solid #3b82f6;padding-left:10px;margin:20px 0 10px;font-size:15px">$1</h3>')
    .replace(/^## (.+)$/gm,'<h2 style="font-size:17px;color:#1e40af;border-bottom:2px solid #3b82f6;padding-bottom:6px;margin:28px 0 14px">$1</h2>')
    .replace(/^# (.+)$/gm,'<h1 style="font-size:22px;text-align:center;margin-bottom:8px">$1</h1>')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/^- (.+)$/gm,'<div style="padding-left:16px;margin-bottom:4px">â€¢ $1</div>')
    .replace(/^(\d+)\. (.+)$/gm,'<div style="padding-left:16px;margin-bottom:4px">$1. $2</div>')
    .replace(/\n\n/g,'<br><br>')
    .replace(/\n/g,'<br>');

  const doc=`<!DOCTYPE html><html><head><meta charset="utf-8"><style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;900&display=swap');
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Noto Sans KR',sans-serif;color:#1e293b;line-height:1.7;padding:40px;max-width:800px;margin:0 auto;font-size:13px}
    @media print{body{padding:20px}h2{page-break-before:always}h2:first-of-type{page-break-before:avoid}}
    h1{font-size:22px;text-align:center;margin-bottom:4px}
    h2{font-size:17px;color:#1e40af;border-bottom:2px solid #3b82f6;padding-bottom:6px;margin:28px 0 14px}
    h3{color:#1e40af;border-left:4px solid #3b82f6;padding-left:10px;margin:20px 0 10px;font-size:15px}
    table{width:100%;border-collapse:collapse;margin:14px 0;font-size:12px}
    th,td{border:1px solid #e2e8f0;padding:8px;vertical-align:top}
    th{background:#1e40af;color:white;font-weight:600;text-align:center}
    strong{color:#1e293b}
  </style></head><body>
    <div style="text-align:center;margin-bottom:24px">
      <div style="font-size:11px;color:#64748b;margin-bottom:4px">3í•™ë…„ ë‹´ì„ ìƒê¸°ë¶€ ì»¨ì„¤íŒ… ë³´ê³ ì„œ</div>
      <h1>${name} í•™ìƒì˜ ì„±ì¥ ë¶„ì„ ë° 3í•™ë…„ í™œë™ ë°©í–¥ ì œì–¸</h1>
      <div style="font-size:12px;color:#64748b;margin-top:4px">${stu.major?'í¬ë§ ì§„ë¡œ: '+stu.major:''} ${stu.club?'| ë™ì•„ë¦¬: '+stu.club:''} | ë¶„ì„ì¼: ${stu.date}</div>
    </div>
    <div style="line-height:1.8;font-size:13px">${html}</div>
    <div style="text-align:center;margin-top:40px;padding-top:16px;border-top:1px solid #e2e8f0;font-size:10px;color:#94a3b8">
      AI ìƒê¸°ë¶€ ì„±ì¥ ë¶„ì„ê¸° | ${stu.date}
    </div>
  </body></html>`;

  const w=window.open('','_blank');
  w.document.write(doc);w.document.close();
  setTimeout(()=>w.print(),600);
}

// ====== XLSX DOWNLOAD ======
function downloadXlsx(){
  if(!D.students.length){toast('ì €ì¥ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤');return}
  const wb=XLSX.utils.book_new();

  // Sheet 1: í•™ìƒ ëª©ë¡
  const s1=[['ë²ˆí˜¸','ì´ë¦„','í¬ë§ì§„ë¡œ','ë™ì•„ë¦¬','ë¶„ì„ì¼','ë¶„ì„ê²°ê³¼ (ì²˜ìŒ 500ì)']];
  D.students.forEach(s=>{s1.push([s.num,s.name,s.major||'',s.club||'',s.date,s.resultText.substring(0,500)])});
  const w1=XLSX.utils.aoa_to_sheet(s1);
  w1['!cols']=[{wch:6},{wch:10},{wch:16},{wch:14},{wch:12},{wch:80}];
  XLSX.utils.book_append_sheet(wb,w1,'í•™ìƒëª©ë¡');

  // Sheet per student
  D.students.forEach(s=>{
    const lines=s.resultText.split('\n');
    const data=lines.map(l=>[l]);
    const ws=XLSX.utils.aoa_to_sheet([
      [`${s.num}ë²ˆ ${s.name} - ìƒê¸°ë¶€ ë¶„ì„ ë³´ê³ ì„œ`],
      [`í¬ë§ì§„ë¡œ: ${s.major||'-'} | ë™ì•„ë¦¬: ${s.club||'-'} | ë¶„ì„ì¼: ${s.date}`],
      [''],
      ...data
    ]);
    ws['!cols']=[{wch:100}];
    const sheetName=`${s.num}_${s.name}`.substring(0,31);
    XLSX.utils.book_append_sheet(wb,ws,sheetName);
  });

  XLSX.writeFile(wb,`ìƒê¸°ë¶€_ë¶„ì„_ì „ì²´_${D.students.length}ëª….xlsx`);
  toast('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!');
}

// ====== NEXT STUDENT ======
function nextStudent(){
  const nextNum=D.students.length>0?Math.min(Math.max(...D.students.map(s=>s.num))+1,25):1;
  $('i-num').value=nextNum;
  $('i-name').value='';$('i-major').value='';$('i-club').value='';$('i-extra').value='';
  D.pdfText='';resetUp();
  goStep(1);
}

// ====== UTILS ======
function showErr(id,m){$(id).innerHTML='âš ï¸ '+m;$(id).classList.remove('hidden')}
function hideErr(id){$(id).classList.add('hidden')}
function toast(m){const t=$('toast');t.textContent='âœ… '+m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500)}
</script>
</body>
</html>
