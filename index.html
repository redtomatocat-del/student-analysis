<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìƒê¸°ë¶€ ì„±ì¥ë¶„ì„ê¸°</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--pri:#2563eb;--pri-d:#1d4ed8;--bg:#f8fafc;--card:#fff;--border:#e2e8f0;--text:#1e293b;--sub:#64748b;--green:#10b981;--red:#ef4444;--orange:#f59e0b;--purple:#8b5cf6}
body{font-family:'Pretendard',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);line-height:1.6}
.container{max-width:960px;margin:0 auto;padding:20px}
h1{font-size:1.8em;text-align:center;padding:24px 0;background:linear-gradient(135deg,var(--pri),var(--purple));color:#fff;border-radius:16px;margin-bottom:24px}
h1 small{display:block;font-size:0.45em;font-weight:400;opacity:0.85;margin-top:4px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px}
.card-title{font-size:1.1em;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
label{font-size:0.9em;font-weight:600;color:var(--sub);display:block;margin-bottom:4px}
input[type=text],input[type=password],textarea,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;font-size:0.95em;transition:border 0.2s}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--pri);box-shadow:0 0 0 3px rgba(37,99,235,0.1)}
textarea{resize:vertical;min-height:80px}
.row{display:grid;gap:12px}.row2{grid-template-columns:1fr 1fr}.row3{grid-template-columns:1fr 1fr 1fr}.row4{grid-template-columns:1fr 1fr 1fr 1fr}
@media(max-width:640px){.row2,.row3,.row4{grid-template-columns:1fr}}
.btn{padding:12px 24px;border:none;border-radius:10px;font-size:1em;font-weight:700;cursor:pointer;transition:all 0.2s;display:inline-flex;align-items:center;gap:8px}
.btn-pri{background:var(--pri);color:#fff}.btn-pri:hover{background:var(--pri-d)}
.btn-pri:disabled{background:#94a3b8;cursor:not-allowed}
.btn-green{background:var(--green);color:#fff}.btn-green:hover{background:#059669}
.btn-purple{background:var(--purple);color:#fff}.btn-purple:hover{background:#7c3aed}
.btn-outline{background:#fff;color:var(--pri);border:2px solid var(--pri)}.btn-outline:hover{background:#eff6ff}
.btn-sm{padding:8px 16px;font-size:0.85em;border-radius:8px}

/* API Key */
.api-section{display:flex;gap:8px;align-items:end}
.api-section .field{flex:1}
.api-status{font-size:0.8em;margin-top:4px}
.api-ok{color:var(--green)}.api-no{color:var(--red)}

/* Drop Zone */
.dropzone{border:2px dashed var(--border);border-radius:12px;padding:40px 20px;text-align:center;cursor:pointer;transition:all 0.3s;background:#fafbfc}
.dropzone:hover,.dropzone.drag{border-color:var(--pri);background:#eff6ff}
.dropzone.done{border-color:var(--green);background:#f0fdf4}
.dropzone-icon{font-size:2.5em;margin-bottom:8px}
.dropzone-main{font-size:1em;font-weight:600}
.dropzone-sub{font-size:0.85em;color:var(--sub);margin-top:4px}
.file-input{display:none}

/* Priority */
.preset-btns{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.preset-btn{padding:10px 16px;border:2px solid var(--border);border-radius:10px;background:#fff;cursor:pointer;font-size:0.9em;font-weight:600;transition:all 0.2s}
.preset-btn:hover{border-color:var(--pri);background:#eff6ff}
.preset-btn.active{border-color:var(--pri);background:var(--pri);color:#fff}
.priority-display{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.priority-tag{padding:6px 14px;border-radius:20px;font-size:0.85em;font-weight:700;color:#fff}
.p1{background:var(--pri)}.p2{background:var(--purple)}.p3{background:#94a3b8}

/* Keywords */
.kw-grid{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
.kw-chip{padding:6px 14px;border:2px solid var(--border);border-radius:20px;font-size:0.85em;cursor:pointer;transition:all 0.2s;user-select:none}
.kw-chip:hover{border-color:var(--pri)}
.kw-chip.sel{border-color:var(--pri);background:var(--pri);color:#fff}

/* Progress */
.progress-bar{width:100%;height:8px;background:var(--border);border-radius:4px;overflow:hidden;margin:12px 0}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--pri),var(--purple));border-radius:4px;transition:width 0.5s;width:0}
.status-text{text-align:center;font-size:0.95em;color:var(--sub);min-height:24px}

/* Results */
.result-section{display:none}
.tab-bar{display:flex;gap:4px;border-bottom:2px solid var(--border);margin-bottom:16px;overflow-x:auto}
.tab{padding:10px 16px;cursor:pointer;font-size:0.9em;font-weight:600;color:var(--sub);border-bottom:3px solid transparent;white-space:nowrap;transition:all 0.2s}
.tab:hover{color:var(--text)}.tab.active{color:var(--pri);border-bottom-color:var(--pri)}
.tab-content{display:none}.tab-content.active{display:block}

/* Report content */
.report-block{background:#f8fafc;border-radius:10px;padding:16px;margin-bottom:12px;border-left:4px solid var(--pri)}
.report-block h4{font-size:0.95em;margin-bottom:8px;color:var(--pri)}
.report-block p,.report-block li{font-size:0.9em;line-height:1.7;color:#334155}
.option-box{border:1px solid var(--border);border-radius:10px;padding:14px;margin:8px 0;background:#fff}
.option-label{font-weight:700;font-size:0.9em;margin-bottom:6px;display:flex;align-items:center;gap:6px}
.option-text{font-size:0.88em;color:#475569;line-height:1.7;white-space:pre-wrap}
.option-meta{font-size:0.8em;color:var(--sub);margin-top:6px;display:flex;gap:12px}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:0.75em;font-weight:700;color:#fff}
.badge-blue{background:var(--pri)}.badge-purple{background:var(--purple)}.badge-gray{background:#94a3b8}
.badge-green{background:var(--green)}.badge-orange{background:var(--orange)}

/* Student list */
.student-list{max-height:200px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;margin-top:8px}
.student-item{padding:8px 12px;display:flex;justify-content:space-between;font-size:0.85em;border-bottom:1px solid #f1f5f9}
.student-item:last-child{border:none}
.student-item .num{font-weight:700;color:var(--pri)}
.student-item .done-mark{color:var(--green);font-weight:700}

/* Actions bar */
.actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:20px 0}

/* Print */
@media print{body{background:#fff}.no-print{display:none!important}}
.hidden{display:none}
.loading-spinner{display:inline-block;width:20px;height:20px;border:3px solid #e2e8f0;border-top-color:var(--pri);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="container">
<h1>ğŸ“Š ìƒê¸°ë¶€ ì„±ì¥ë¶„ì„ê¸°<small>AI ê¸°ë°˜ í•™ìƒë¶€ ì¢…í•© ë¶„ì„ Â· PDF ë³´ê³ ì„œ Â· ì—‘ì…€ ìƒë‹´ê¸°ë¡</small></h1>

<!-- API Key -->
<div class="card no-print" id="apiCard">
<div class="card-title">ğŸ”‘ API ì„¤ì •</div>
<div class="api-section">
<div class="field">
<label>Anthropic API Key</label>
<input type="password" id="apiKey" placeholder="sk-ant-..." />
</div>
<button class="btn btn-pri btn-sm" onclick="saveApiKey()">ì €ì¥</button>
</div>
<div class="api-status" id="apiStatus"></div>
</div>

<!-- PDF Upload -->
<div class="card no-print" id="uploadCard">
<div class="card-title">ğŸ“„ ìƒê¸°ë¶€ PDF ì—…ë¡œë“œ</div>
<div class="dropzone" id="dropzone" onclick="document.getElementById('fileInput').click()">
<div class="dropzone-icon">ğŸ“</div>
<div class="dropzone-main">PDF íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</div>
<div class="dropzone-sub">í•™ìƒ ìƒê¸°ë¶€ PDF (1,2í•™ë…„ ê¸°ë¡ í¬í•¨)</div>
</div>
<input type="file" id="fileInput" class="file-input" accept=".pdf" />
<div id="fileInfo" class="hidden" style="margin-top:12px;padding:10px;background:#f0fdf4;border-radius:8px;font-size:0.9em">
<strong>âœ… ì—…ë¡œë“œ ì™„ë£Œ</strong> Â· <span id="fileName"></span> Â· <span id="fileSize"></span>
</div>
</div>

<!-- Student Info -->
<div class="card no-print" id="infoCard">
<div class="card-title">ğŸ‘¤ í•™ìƒ ê¸°ë³¸ì •ë³´</div>
<div class="row row4">
<div><label>í•™ìƒ ë²ˆí˜¸</label><select id="stuNum"><option value="">ì„ íƒ</option></select></div>
<div><label>ì´ë¦„</label><input type="text" id="stuName" placeholder="í™ê¸¸ë™" /></div>
<div><label>í¬ë§ ì§„ë¡œ</label><input type="text" id="stuCareer" placeholder="ê°„í˜¸ì‚¬, êµì‚¬ ë“±" /></div>
<div><label>ë™ì•„ë¦¬ëª…</label><input type="text" id="stuClub" placeholder="ê³¼í•™íƒêµ¬ë°˜ ë“±" /></div>
</div>
</div>

<!-- Priority Setting -->
<div class="card no-print" id="priorityCard">
<div class="card-title">ğŸ¯ ë³´ê³ ì„œ ìš°ì„ ìˆœìœ„ ì„¤ì •</div>
<div class="preset-btns">
<div class="preset-btn" onclick="setPreset('top')" id="preTop">ğŸ† 1~2ë“±ê¸‰ìš© (í•™ì—…â†’ì§„ë¡œâ†’ê³µë™ì²´)</div>
<div class="preset-btn" onclick="setPreset('mid')" id="preMid">ğŸ¯ 3~5ë“±ê¸‰ìš© (ì§„ë¡œâ†’í•™ì—…â†’ê³µë™ì²´)</div>
<div class="preset-btn" onclick="setPreset('custom')" id="preCus">âš™ï¸ ì§ì ‘ ì„¤ì •</div>
</div>
<div id="customPriority" class="hidden">
<div class="row row3">
<div><label>1ìˆœìœ„</label><select id="pri1" onchange="updatePriority()"><option value="í•™ì—…">í•™ì—…</option><option value="ì§„ë¡œ">ì§„ë¡œ</option><option value="ê³µë™ì²´">ê³µë™ì²´</option></select></div>
<div><label>2ìˆœìœ„</label><select id="pri2" onchange="updatePriority()"><option value="ì§„ë¡œ">ì§„ë¡œ</option><option value="í•™ì—…">í•™ì—…</option><option value="ê³µë™ì²´">ê³µë™ì²´</option></select></div>
<div><label>3ìˆœìœ„</label><select id="pri3" disabled><option value="ê³µë™ì²´">ê³µë™ì²´</option></select></div>
</div>
</div>
<div class="priority-display" id="priorityDisplay" style="margin-top:10px">
<span class="priority-tag p1" id="pTag1">1ìˆœìœ„: í•™ì—…</span>
<span style="color:var(--sub)">â†’</span>
<span class="priority-tag p2" id="pTag2">2ìˆœìœ„: ì§„ë¡œ</span>
<span style="color:var(--sub)">â†’</span>
<span class="priority-tag p3" id="pTag3">3ìˆœìœ„: ê³µë™ì²´</span>
</div>
</div>

<!-- Keywords -->
<div class="card no-print" id="kwCard">
<div class="card-title">ğŸ·ï¸ í‚¤ì›Œë“œ ì„ íƒ (ë³´ê³ ì„œì— ë°˜ì˜)</div>
<div class="kw-grid" id="kwGrid"></div>
<div style="margin-top:8px">
<label>ì§ì ‘ ì…ë ¥ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
<input type="text" id="kwCustom" placeholder="ì˜ˆ: ESGê²½ì˜, ë¹…ë°ì´í„°, ì§€ì—­ì‚¬íšŒë´‰ì‚¬" />
</div>
</div>

<!-- Counseling Memo -->
<div class="card no-print" id="memoCard">
<div class="card-title">ğŸ’¡ ìƒë‹´ ë©”ëª¨ (ì„ íƒ)</div>
<textarea id="counselMemo" placeholder="í•™ìƒ íŠ¹ì´ì‚¬í•­, ê°•ì¡°í•  ì , ë³´ì™„í•  ì  ë“± ììœ ë¡­ê²Œ ì‘ì„±"></textarea>
</div>

<!-- Analyze Button -->
<div class="actions no-print">
<button class="btn btn-pri" id="analyzeBtn" onclick="startAnalysis()" disabled>ğŸ” AI ì¢…í•© ë¶„ì„ ì‹œì‘</button>
</div>
<div class="progress-bar no-print" id="progressBar" style="display:none"><div class="progress-fill" id="progressFill"></div></div>
<div class="status-text no-print" id="statusText"></div>

<!-- Results -->
<div class="result-section" id="resultSection">
<div class="card">
<div class="tab-bar" id="tabBar">
<div class="tab active" onclick="switchTab('overview')">ğŸ“Š ì¢…í•©ë¶„ì„</div>
<div class="tab" onclick="switchTab('jarhaeng')">ğŸ“ ììœ¨Â·ì§„ë¡œÂ·í–‰ë°œ</div>
<div class="tab" onclick="switchTab('setuk')">ğŸ¯ ì„¸íŠ¹ë°©í–¥</div>
<div class="tab" onclick="switchTab('club')">ğŸ« ë™ì•„ë¦¬ê³„íš</div>
<div class="tab" onclick="switchTab('counsel')">ğŸ’¬ ìƒë‹´ê°€ì´ë“œ</div>
</div>
<div class="tab-content active" id="tab-overview"></div>
<div class="tab-content" id="tab-jarhaeng"></div>
<div class="tab-content" id="tab-setuk"></div>
<div class="tab-content" id="tab-club"></div>
<div class="tab-content" id="tab-counsel"></div>
</div>
<div class="actions no-print">
<button class="btn btn-green" onclick="downloadPDF()">ğŸ“„ PDF ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ</button>
<button class="btn btn-purple" onclick="downloadExcel()">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
<button class="btn btn-outline" onclick="nextStudent()">â¡ï¸ ë‹¤ìŒ í•™ìƒ ë¶„ì„</button>
</div>
</div>

<!-- Student Summary -->
<div class="card no-print" id="summaryCard">
<div class="card-title">ğŸ“‹ ë¶„ì„ ì™„ë£Œ í•™ìƒ ëª©ë¡</div>
<div class="student-list" id="studentList"><div style="padding:12px;color:var(--sub);text-align:center">ì•„ì§ ë¶„ì„ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</div></div>
<div class="actions" style="margin-top:12px">
<button class="btn btn-purple btn-sm" onclick="downloadAllExcel()">ğŸ“Š ì „ì²´ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
</div>
</div>
</div>

<script>
// State
let pdfText='',apiKeyVal='',priorities=['í•™ì—…','ì§„ë¡œ','ê³µë™ì²´'],selectedKW=[],students={},currentResult=null;
const KW_LIST=['ìê¸°ì£¼ë„í•™ìŠµ','ë¹„íŒì ì‚¬ê³ ','ë°ì´í„°ë¶„ì„','ë¦¬ë”ì‹­','í˜‘ì—…','ë¬¸ì œí•´ê²°','ë°œí‘œë ¥','ë´‰ì‚¬í™œë™','ìœµí•©ì‚¬ê³ ','ì°½ì˜ì„±','ì˜ì‚¬ì†Œí†µ','ê¸€ë¡œë²Œì—­ëŸ‰','ë””ì§€í„¸ë¦¬í„°ëŸ¬ì‹œ','ì—°êµ¬ì—­ëŸ‰','ì§„ë¡œíƒìƒ‰','ë©˜í† ë§','í”„ë¡œì íŠ¸ê¸°íš','ë…ì„œí™œë™'];
const BYTE_LIMITS={ììœ¨:1500,ì§„ë¡œ:2100,ë™ì•„ë¦¬:1500,í–‰ë°œ:1500};

// Init
(function init(){
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
const sel=document.getElementById('stuNum');
for(let i=1;i<=25;i++){const o=document.createElement('option');o.value=i;o.textContent=i+'ë²ˆ';sel.appendChild(o)}
const g=document.getElementById('kwGrid');
KW_LIST.forEach(k=>{const d=document.createElement('div');d.className='kw-chip';d.textContent=k;d.onclick=()=>{d.classList.toggle('sel');if(d.classList.contains('sel'))selectedKW.push(k);else selectedKW=selectedKW.filter(x=>x!==k)};g.appendChild(d)});
const saved=localStorage.getItem('sgb_apikey');
if(saved){apiKeyVal=saved;document.getElementById('apiKey').value=saved;showApiOk()}
const savedStu=localStorage.getItem('sgb_students');
if(savedStu){try{students=JSON.parse(savedStu);renderStudentList()}catch(e){}}
checkReady();
setPreset('top');
})();

// API Key
function saveApiKey(){
apiKeyVal=document.getElementById('apiKey').value.trim();
if(!apiKeyVal){document.getElementById('apiStatus').innerHTML='<span class="api-no">âŒ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”</span>';return}
localStorage.setItem('sgb_apikey',apiKeyVal);showApiOk();checkReady();
}
function showApiOk(){document.getElementById('apiStatus').innerHTML='<span class="api-ok">âœ… API í‚¤ ì €ì¥ë¨ (ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥, ì™¸ë¶€ ì „ì†¡ ì—†ìŒ)</span>'}

// Dropzone
const dz=document.getElementById('dropzone'),fi=document.getElementById('fileInput');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag')});
dz.addEventListener('dragleave',()=>dz.classList.remove('drag'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('drag');if(e.dataTransfer.files[0])handleFile(e.dataTransfer.files[0])});
fi.addEventListener('change',e=>{if(e.target.files[0])handleFile(e.target.files[0])});

async function handleFile(file){
if(file.type!=='application/pdf'){alert('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');return}
dz.classList.add('done');
document.getElementById('fileInfo').classList.remove('hidden');
document.getElementById('fileName').textContent=file.name;
document.getElementById('fileSize').textContent=(file.size/1024).toFixed(0)+'KB';
dz.querySelector('.dropzone-icon').textContent='âœ…';
dz.querySelector('.dropzone-main').textContent=file.name;
dz.querySelector('.dropzone-sub').textContent='í…ìŠ¤íŠ¸ ì¶”ì¶œ ì¤‘...';
try{
const buf=await file.arrayBuffer();
const pdf=await pdfjsLib.getDocument({data:buf}).promise;
let txt='';
for(let i=1;i<=pdf.numPages;i++){const pg=await pdf.getPage(i);const tc=await pg.getTextContent();txt+=tc.items.map(x=>x.str).join(' ')+'\n'}
pdfText=txt;
dz.querySelector('.dropzone-sub').textContent=`${pdf.numPages}í˜ì´ì§€ Â· ${pdfText.length.toLocaleString()}ì ì¶”ì¶œ ì™„ë£Œ`;
checkReady();
}catch(e){dz.querySelector('.dropzone-sub').textContent='âŒ PDF ì¶”ì¶œ ì‹¤íŒ¨: '+e.message;pdfText=''}
}

// Priority
function setPreset(type){
document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
document.getElementById('customPriority').classList.add('hidden');
if(type==='top'){priorities=['í•™ì—…','ì§„ë¡œ','ê³µë™ì²´'];document.getElementById('preTop').classList.add('active')}
else if(type==='mid'){priorities=['ì§„ë¡œ','í•™ì—…','ê³µë™ì²´'];document.getElementById('preMid').classList.add('active')}
else{document.getElementById('preCus').classList.add('active');document.getElementById('customPriority').classList.remove('hidden');updatePriority()}
renderPriority();
}
function updatePriority(){
const a=document.getElementById('pri1').value,b=document.getElementById('pri2').value;
const all=['í•™ì—…','ì§„ë¡œ','ê³µë™ì²´'];
const c=all.find(x=>x!==a&&x!==b)||'ê³µë™ì²´';
document.getElementById('pri3').innerHTML=`<option>${c}</option>`;
priorities=[a,b,c];renderPriority();
}
function renderPriority(){
document.getElementById('pTag1').textContent='1ìˆœìœ„: '+priorities[0];
document.getElementById('pTag2').textContent='2ìˆœìœ„: '+priorities[1];
document.getElementById('pTag3').textContent='3ìˆœìœ„: '+priorities[2];
}

// Check ready
function checkReady(){
const ok=apiKeyVal&&pdfText;
document.getElementById('analyzeBtn').disabled=!ok;
}

// Analysis
async function startAnalysis(){
const name=document.getElementById('stuName').value.trim()||'í•™ìƒ';
const career=document.getElementById('stuCareer').value.trim()||'ë¯¸ì •';
const club=document.getElementById('stuClub').value.trim()||'ë¯¸ì •';
const num=document.getElementById('stuNum').value||'1';
const memo=document.getElementById('counselMemo').value.trim();
const kwAll=[...selectedKW];
const kwCustom=document.getElementById('kwCustom').value.trim();
if(kwCustom)kwAll.push(...kwCustom.split(',').map(s=>s.trim()).filter(Boolean));

document.getElementById('progressBar').style.display='block';
document.getElementById('analyzeBtn').disabled=true;
setProgress(10,'PDF í…ìŠ¤íŠ¸ ë¶„ì„ ì¤‘...');

const prompt=buildPrompt(name,career,club,kwAll,memo);

try{
setProgress(30,'AI ë¶„ì„ ìš”ì²­ ì¤‘...');
const resp=await fetch('https://api.anthropic.com/v1/messages',{
method:'POST',
headers:{'Content-Type':'application/json','x-api-key':apiKeyVal,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
body:JSON.stringify({model:'claude-sonnet-4-5-20250514',max_tokens:8000,messages:[{role:'user',content:prompt}]})
});
setProgress(70,'ì‘ë‹µ ì²˜ë¦¬ ì¤‘...');
if(!resp.ok){const err=await resp.json();throw new Error(err.error?.message||'API ì˜¤ë¥˜')}
const data=await resp.json();
const text=data.content.map(c=>c.text||'').join('');
setProgress(90,'ë³´ê³ ì„œ ìƒì„± ì¤‘...');
currentResult=parseResult(text,name,career,club,num,kwAll);
students[num]={name,career,club,num,date:new Date().toLocaleDateString('ko-KR'),result:currentResult};
localStorage.setItem('sgb_students',JSON.stringify(students));
renderResult(currentResult);
renderStudentList();
setProgress(100,'ë¶„ì„ ì™„ë£Œ!');
setTimeout(()=>{document.getElementById('progressBar').style.display='none';document.getElementById('statusText').textContent=''},1500);
}catch(e){
setProgress(0,'âŒ ì˜¤ë¥˜: '+e.message);
document.getElementById('analyzeBtn').disabled=false;
}
}

function setProgress(pct,msg){
document.getElementById('progressFill').style.width=pct+'%';
document.getElementById('statusText').textContent=msg;
}

function buildPrompt(name,career,club,kw,memo){
return `ë‹¹ì‹ ì€ í•œêµ­ ê³ ë“±í•™êµ ìƒê¸°ë¶€(í•™êµìƒí™œê¸°ë¡ë¶€) ì „ë¬¸ ë¶„ì„ê°€ì…ë‹ˆë‹¤.

ì•„ë˜ í•™ìƒì˜ 1,2í•™ë…„ ìƒê¸°ë¶€ ê¸°ë¡ì„ ë¶„ì„í•˜ì—¬ 3í•™ë…„ ë‹´ì„êµì‚¬ë¥¼ ìœ„í•œ ì¢…í•© ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”.

[í•™ìƒ ì •ë³´]
- ì´ë¦„: ${name}
- í¬ë§ ì§„ë¡œ: ${career}
- ë™ì•„ë¦¬: ${club}
- ê°•ì¡° í‚¤ì›Œë“œ: ${kw.join(', ')||'ì—†ìŒ'}
${memo?'- ìƒë‹´ ë©”ëª¨: '+memo:''}

[ìš°ì„ ìˆœìœ„]
- 1ìˆœìœ„: ${priorities[0]} (ë³´ê³ ì„œ ë¬¸êµ¬ ì‘ì„± ì‹œ ê°€ì¥ ì¤‘ì )
- 2ìˆœìœ„: ${priorities[1]}
- 3ìˆœìœ„: ${priorities[2]}

[ë°”ì´íŠ¸ ì œí•œ]
- ììœ¨í™œë™: 1500ë°”ì´íŠ¸ ì´ë‚´
- ì§„ë¡œí™œë™: 2100ë°”ì´íŠ¸ ì´ë‚´
- ë™ì•„ë¦¬í™œë™: 1500ë°”ì´íŠ¸ ì´ë‚´
- í–‰ë™íŠ¹ì„±ë°ì¢…í•©ì˜ê²¬(í–‰ë°œ): 1500ë°”ì´íŠ¸ ì´ë‚´

[ìƒê¸°ë¶€ ì›ë¬¸]
${pdfText.substring(0,15000)}

[ì¶œë ¥ í˜•ì‹ - ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µ]
{
  "overview": {
    "summary": "í•™ìƒ ì¢…í•© ìš”ì•½ (3-4ë¬¸ì¥)",
    "strengths": ["ê°•ì 1","ê°•ì 2","ê°•ì 3"],
    "improvements": ["ë³´ì™„ì 1","ë³´ì™„ì 2"],
    "competencies": {
      "career": {"grade1":"1í•™ë…„ ì§„ë¡œì—­ëŸ‰ ì„¤ëª…","grade2":"2í•™ë…„ ì§„ë¡œì—­ëŸ‰ ì„¤ëª…","growth":"ì„±ì¥ ë¶„ì„"},
      "academic": {"grade1":"","grade2":"","growth":""},
      "community": {"grade1":"","grade2":"","growth":""},
      "character": {"grade1":"","grade2":"","growth":""}
    }
  },
  "jarhaeng": {
    "jayul": {
      "evaluation": "1,2í•™ë…„ ììœ¨í™œë™ í‰ê°€",
      "option1": {"title":"${priorities[0]} ì¤‘ì‹¬","text":"3í•™ë…„ ììœ¨í™œë™ ê¸°ë¡ ì˜ˆì‹œ (1500ë°”ì´íŠ¸ ì´ë‚´)","focus":"ì¶”ì²œ í¬ì¸íŠ¸","supplement":"ë³´ì™„ í¬ì¸íŠ¸"},
      "option2": {"title":"${priorities[1]} ì¤‘ì‹¬","text":"3í•™ë…„ ììœ¨í™œë™ ê¸°ë¡ ì˜ˆì‹œ (1500ë°”ì´íŠ¸ ì´ë‚´)","focus":"ì¶”ì²œ í¬ì¸íŠ¸","supplement":"ë³´ì™„ í¬ì¸íŠ¸"}
    },
    "jinro": {
      "evaluation": "1,2í•™ë…„ ì§„ë¡œí™œë™ í‰ê°€",
      "option1": {"title":"${priorities[0]} ì¤‘ì‹¬","text":"3í•™ë…„ ì§„ë¡œí™œë™ ê¸°ë¡ ì˜ˆì‹œ (2100ë°”ì´íŠ¸ ì´ë‚´)","focus":"","supplement":""},
      "option2": {"title":"${priorities[1]} ì¤‘ì‹¬","text":"3í•™ë…„ ì§„ë¡œí™œë™ ê¸°ë¡ ì˜ˆì‹œ (2100ë°”ì´íŠ¸ ì´ë‚´)","focus":"","supplement":""}
    },
    "dongari": {
      "evaluation": "1,2í•™ë…„ ë™ì•„ë¦¬ í™œë™ í‰ê°€",
      "option1": {"title":"${priorities[0]} ì¤‘ì‹¬","text":"3í•™ë…„ ë™ì•„ë¦¬í™œë™ ê¸°ë¡ ì˜ˆì‹œ (1500ë°”ì´íŠ¸ ì´ë‚´)","focus":"","supplement":""},
      "option2": {"title":"${priorities[1]} ì¤‘ì‹¬","text":"3í•™ë…„ ë™ì•„ë¦¬í™œë™ ê¸°ë¡ ì˜ˆì‹œ (1500ë°”ì´íŠ¸ ì´ë‚´)","focus":"","supplement":""}
    },
    "hangbal": {
      "evaluation": "1,2í•™ë…„ í–‰ë°œ í‰ê°€",
      "option1": {"title":"${priorities[0]} ì¤‘ì‹¬","text":"3í•™ë…„ í–‰ë°œ ê¸°ë¡ ì˜ˆì‹œ (1500ë°”ì´íŠ¸ ì´ë‚´)","focus":"","supplement":""},
      "option2": {"title":"${priorities[1]} ì¤‘ì‹¬","text":"3í•™ë…„ í–‰ë°œ ê¸°ë¡ ì˜ˆì‹œ (1500ë°”ì´íŠ¸ ì´ë‚´)","focus":"","supplement":""}
    }
  },
  "setuk": {
    "direction": "3í•™ë…„ ì„¸íŠ¹ ì „ì²´ ë°©í–¥",
    "subjects": [
      {"name":"ê³¼ëª©ëª…","theme":"ì¶”ì²œ ì£¼ì œ","reason":"ì´ìœ ","keywords":["í‚¤ì›Œë“œ1","í‚¤ì›Œë“œ2"]}
    ]
  },
  "club": {
    "name": "ì¶”ì²œ ë™ì•„ë¦¬ëª… ë˜ëŠ” ê¸°ì¡´ ë™ì•„ë¦¬",
    "goal": "ì—°ê°„ ëª©í‘œ",
    "monthly": [
      {"month":"3ì›”","activity":"í™œë™ ë‚´ìš©","record":"ê¸°ë¡ í¬ì¸íŠ¸"},
      {"month":"4ì›”","activity":"","record":""},
      {"month":"5ì›”","activity":"","record":""},
      {"month":"6ì›”","activity":"","record":""},
      {"month":"7ì›”","activity":"","record":""},
      {"month":"8ì›”","activity":"","record":""},
      {"month":"9ì›”","activity":"","record":""},
      {"month":"10ì›”","activity":"","record":""},
      {"month":"11ì›”","activity":"","record":""}
    ]
  },
  "counsel": {
    "talk_points": ["ìƒë‹´ ì‹œ í™•ì¸í•  í¬ì¸íŠ¸1","í¬ì¸íŠ¸2","í¬ì¸íŠ¸3"],
    "questions": ["ì§ˆë¬¸ ì˜ˆì‹œ1","ì§ˆë¬¸ ì˜ˆì‹œ2","ì§ˆë¬¸ ì˜ˆì‹œ3"],
    "parent_points": ["í•™ë¶€ëª¨ ìƒë‹´ í¬ì¸íŠ¸1","í¬ì¸íŠ¸2"],
    "recommended_activities": ["ì¶”ì²œ í™œë™1","ì¶”ì²œ í™œë™2","ì¶”ì²œ í™œë™3"]
  }
}

ì¤‘ìš”: ë°˜ë“œì‹œ ìœ„ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. JSON ì™¸ì˜ í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”. ê° ê¸°ë¡ ì˜ˆì‹œëŠ” ë°˜ë“œì‹œ í•´ë‹¹ ë°”ì´íŠ¸ ì œí•œì„ ì§€í‚¤ì„¸ìš”. í•œê¸€ 1ì=3ë°”ì´íŠ¸ë¡œ ê³„ì‚°í•˜ì„¸ìš”.`;
}

function parseResult(text,name,career,club,num,kw){
try{
let clean=text.replace(/```json\s*/g,'').replace(/```\s*/g,'').trim();
const jsonStart=clean.indexOf('{');
const jsonEnd=clean.lastIndexOf('}');
if(jsonStart>=0&&jsonEnd>jsonStart)clean=clean.substring(jsonStart,jsonEnd+1);
const obj=JSON.parse(clean);
obj._meta={name,career,club,num,kw,priorities:[...priorities],date:new Date().toLocaleDateString('ko-KR')};
return obj;
}catch(e){
return {_meta:{name,career,club,num,kw,priorities:[...priorities],date:new Date().toLocaleDateString('ko-KR')},_raw:text,_parseError:true};
}
}

function renderResult(r){
document.getElementById('resultSection').style.display='block';
if(r._parseError){
document.getElementById('tab-overview').innerHTML=`<div class="report-block"><h4>âš ï¸ JSON íŒŒì‹± ì‹¤íŒ¨ - ì›ë³¸ ê²°ê³¼</h4><pre style="white-space:pre-wrap;font-size:0.85em">${escHtml(r._raw||'')}</pre></div>`;
return;
}
const m=r._meta;
// Overview
const ov=r.overview||{};
const comp=ov.competencies||{};
document.getElementById('tab-overview').innerHTML=`
<div class="report-block"><h4>ğŸ“‹ ${m.name} í•™ìƒ ì¢…í•© ë¶„ì„</h4><p>${ov.summary||''}</p></div>
<div class="report-block"><h4>ğŸ’ª ê°•ì </h4>${(ov.strengths||[]).map(s=>`<p>âœ… ${s}</p>`).join('')}</div>
<div class="report-block"><h4>ğŸ“Œ ë³´ì™„ì </h4>${(ov.improvements||[]).map(s=>`<p>âš¡ ${s}</p>`).join('')}</div>
<div class="report-block"><h4>ğŸ“Š 4ëŒ€ ì—­ëŸ‰ ì„±ì¥ ë¶„ì„</h4>
${['career','academic','community','character'].map(k=>{
const c=comp[k]||{};const labels={career:'ì§„ë¡œ',academic:'í•™ì—…',community:'ê³µë™ì²´',character:'ì¸ì„±'};
return `<div style="margin:10px 0;padding:10px;background:#fff;border-radius:8px;border:1px solid #e2e8f0">
<strong>${labels[k]} ì—­ëŸ‰</strong>
<p style="font-size:0.85em;margin:4px 0"><span class="badge badge-blue">1í•™ë…„</span> ${c.grade1||'-'}</p>
<p style="font-size:0.85em;margin:4px 0"><span class="badge badge-purple">2í•™ë…„</span> ${c.grade2||'-'}</p>
<p style="font-size:0.85em;margin:4px 0"><span class="badge badge-green">ì„±ì¥</span> ${c.growth||'-'}</p>
</div>`}).join('')}</div>`;

// ììœ¨ì§„ë¡œí–‰ë°œ
const jh=r.jarhaeng||{};
document.getElementById('tab-jarhaeng').innerHTML=renderJarhaeng(jh);

// ì„¸íŠ¹
const st=r.setuk||{};
document.getElementById('tab-setuk').innerHTML=`
<div class="report-block"><h4>ğŸ¯ 3í•™ë…„ ì„¸íŠ¹ ì „ì²´ ë°©í–¥</h4><p>${st.direction||''}</p></div>
${(st.subjects||[]).map(s=>`<div class="report-block"><h4>ğŸ“˜ ${s.name}</h4>
<p><strong>ì¶”ì²œ ì£¼ì œ:</strong> ${s.theme||''}</p><p><strong>ì´ìœ :</strong> ${s.reason||''}</p>
<p><strong>í‚¤ì›Œë“œ:</strong> ${(s.keywords||[]).map(k=>`<span class="badge badge-blue" style="margin:2px">${k}</span>`).join(' ')}</p>
</div>`).join('')}`;

// ë™ì•„ë¦¬
const cl=r.club||{};
document.getElementById('tab-club').innerHTML=`
<div class="report-block"><h4>ğŸ« ${cl.name||'ë™ì•„ë¦¬'} ì—°ê°„ ê³„íš</h4><p><strong>ëª©í‘œ:</strong> ${cl.goal||''}</p></div>
<div class="report-block"><h4>ğŸ“… ì›”ë³„ í™œë™ ê³„íš</h4>
<table style="width:100%;font-size:0.85em;border-collapse:collapse">
<tr style="background:#f1f5f9"><th style="padding:8px;border:1px solid #e2e8f0">ì›”</th><th style="padding:8px;border:1px solid #e2e8f0">í™œë™</th><th style="padding:8px;border:1px solid #e2e8f0">ê¸°ë¡ í¬ì¸íŠ¸</th></tr>
${(cl.monthly||[]).map(m=>`<tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700">${m.month}</td><td style="padding:8px;border:1px solid #e2e8f0">${m.activity}</td><td style="padding:8px;border:1px solid #e2e8f0">${m.record}</td></tr>`).join('')}
</table></div>`;

// ìƒë‹´
const co=r.counsel||{};
document.getElementById('tab-counsel').innerHTML=`
<div class="report-block"><h4>ğŸ’¬ ìƒë‹´ ì‹œ í™•ì¸ í¬ì¸íŠ¸</h4>${(co.talk_points||[]).map(s=>`<p>ğŸ”¹ ${s}</p>`).join('')}</div>
<div class="report-block"><h4>â“ ì§ˆë¬¸ ì˜ˆì‹œ</h4>${(co.questions||[]).map(s=>`<p>â€¢ "${s}"</p>`).join('')}</div>
<div class="report-block"><h4>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ í•™ë¶€ëª¨ ìƒë‹´ í¬ì¸íŠ¸</h4>${(co.parent_points||[]).map(s=>`<p>ğŸ”¸ ${s}</p>`).join('')}</div>
<div class="report-block"><h4>ğŸš€ ì¶”ì²œ í™œë™</h4>${(co.recommended_activities||[]).map(s=>`<p>âœ¨ ${s}</p>`).join('')}</div>`;

switchTab('overview');
}

function renderJarhaeng(jh){
const areas=[
{key:'jayul',label:'ììœ¨í™œë™',bytes:1500,icon:'ğŸ“—'},
{key:'jinro',label:'ì§„ë¡œí™œë™',bytes:2100,icon:'ğŸ“™'},
{key:'dongari',label:'ë™ì•„ë¦¬í™œë™',bytes:1500,icon:'ğŸ“˜'},
{key:'hangbal',label:'í–‰ë™íŠ¹ì„±ë°ì¢…í•©ì˜ê²¬',bytes:1500,icon:'ğŸ“•'}
];
return areas.map(a=>{
const d=jh[a.key]||{};
const o1=d.option1||{},o2=d.option2||{};
const b1=getByteLen(o1.text||''),b2=getByteLen(o2.text||'');
return `<div class="report-block"><h4>${a.icon} ${a.label} (${a.bytes}ë°”ì´íŠ¸ ì´ë‚´)</h4>
<p style="margin-bottom:10px">${d.evaluation||''}</p>
<div class="option-box">
<div class="option-label"><span class="badge badge-blue">1ì•ˆ</span> ${o1.title||''}</div>
<div class="option-text">${o1.text||''}</div>
<div class="option-meta"><span>âœ… ${o1.focus||''}</span><span>ğŸ“Œ ${o1.supplement||''}</span><span>${b1}/${a.bytes} bytes</span></div>
</div>
<div class="option-box">
<div class="option-label"><span class="badge badge-purple">2ì•ˆ</span> ${o2.title||''}</div>
<div class="option-text">${o2.text||''}</div>
<div class="option-meta"><span>âœ… ${o2.focus||''}</span><span>ğŸ“Œ ${o2.supplement||''}</span><span>${b2}/${a.bytes} bytes</span></div>
</div></div>`}).join('');
}

function getByteLen(s){return new Blob([s||'']).size}
function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

// Tabs
function switchTab(id){
document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
document.querySelector(`.tab[onclick="switchTab('${id}')"]`).classList.add('active');
document.getElementById('tab-'+id).classList.add('active');
}

// PDF Download
function downloadPDF(){
if(!currentResult)return;
const m=currentResult._meta;
const w=window.open('','_blank');
w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${m.name} ìƒê¸°ë¶€ ë¶„ì„ ë³´ê³ ì„œ</title>
<style>
body{font-family:'Pretendard',-apple-system,sans-serif;max-width:800px;margin:0 auto;padding:30px;color:#1e293b;line-height:1.7}
h1{text-align:center;font-size:1.5em;border-bottom:3px solid #2563eb;padding-bottom:12px;color:#2563eb}
h2{font-size:1.15em;color:#2563eb;margin-top:24px;border-left:4px solid #2563eb;padding-left:10px}
h3{font-size:1em;color:#475569;margin-top:16px}
.info{background:#f8fafc;padding:12px;border-radius:8px;margin:16px 0;font-size:0.9em}
.option{border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin:8px 0;background:#fafbfc}
.option-title{font-weight:700;color:#2563eb;margin-bottom:6px}
.meta{font-size:0.8em;color:#94a3b8;margin-top:4px}
table{width:100%;border-collapse:collapse;font-size:0.85em;margin:10px 0}
th,td{border:1px solid #e2e8f0;padding:8px;text-align:left}
th{background:#f1f5f9}
.footer{text-align:center;margin-top:30px;font-size:0.8em;color:#94a3b8;border-top:1px solid #e2e8f0;padding-top:10px}
@media print{body{padding:10px}}
</style></head><body>
<h1>ğŸ“Š ìƒê¸°ë¶€ ì„±ì¥ë¶„ì„ ë³´ê³ ì„œ</h1>
<div class="info"><strong>${m.num}ë²ˆ ${m.name}</strong> Â· í¬ë§ì§„ë¡œ: ${m.career} Â· ë™ì•„ë¦¬: ${m.club} Â· ë¶„ì„ì¼: ${m.date}<br>ìš°ì„ ìˆœìœ„: ${m.priorities.map((p,i)=>['1ìˆœìœ„','2ìˆœìœ„','3ìˆœìœ„'][i]+' '+p).join(' â†’ ')}</div>
${document.getElementById('resultSection').querySelector('.card').innerHTML}
<div class="footer">ìƒê¸°ë¶€ ì„±ì¥ë¶„ì„ê¸° Â· AI ê¸°ë°˜ ìë™ ë¶„ì„ ë³´ê³ ì„œ Â· ${m.date}</div>
</body></html>`);
w.document.close();
setTimeout(()=>w.print(),500);
}

// Excel Download
function downloadExcel(){
if(!currentResult||currentResult._parseError)return;
const r=currentResult,m=r._meta;
const wb=XLSX.utils.book_new();

// Sheet1: AI ë¶„ì„ ê²°ê³¼ (ì°¸ê³ ìš©)
const s1Data=[
['ìƒê¸°ë¶€ AI ë¶„ì„ ê²°ê³¼ - ì°¸ê³ ìš©','',' ','',''],
['í•™ìƒ: '+m.name,'ì§„ë¡œ: '+m.career,'ë™ì•„ë¦¬: '+m.club,'ë¶„ì„ì¼: '+m.date,'ìš°ì„ ìˆœìœ„: '+m.priorities.join('â†’')],
[],
['ì˜ì—­','êµ¬ë¶„','ë‚´ìš©','ë°”ì´íŠ¸ìˆ˜','ì œí•œ'],
];
const areas=[
{key:'jayul',label:'ììœ¨í™œë™',limit:1500},
{key:'jinro',label:'ì§„ë¡œí™œë™',limit:2100},
{key:'dongari',label:'ë™ì•„ë¦¬í™œë™',limit:1500},
{key:'hangbal',label:'í–‰ë°œ',limit:1500}
];
const jh=r.jarhaeng||{};
areas.forEach(a=>{
const d=jh[a.key]||{};const o1=d.option1||{},o2=d.option2||{};
s1Data.push([a.label,'í‰ê°€',d.evaluation||'','','']);
s1Data.push([a.label,'1ì•ˆ: '+(o1.title||''),o1.text||'',getByteLen(o1.text||''),a.limit]);
s1Data.push(['','ì¶”ì²œ',o1.focus||'','','']);
s1Data.push(['','ë³´ì™„',o1.supplement||'','','']);
s1Data.push([a.label,'2ì•ˆ: '+(o2.title||''),o2.text||'',getByteLen(o2.text||''),a.limit]);
s1Data.push(['','ì¶”ì²œ',o2.focus||'','','']);
s1Data.push(['','ë³´ì™„',o2.supplement||'','','']);
s1Data.push([]);
});
// ì„¸íŠ¹
s1Data.push([],['ì„¸íŠ¹ ë°©í–¥','','','','']);
(r.setuk?.subjects||[]).forEach(s=>{
s1Data.push([s.name,s.theme,s.reason,(s.keywords||[]).join(', '),'']);
});
const ws1=XLSX.utils.aoa_to_sheet(s1Data);
ws1['!cols']=[{wch:14},{wch:18},{wch:60},{wch:10},{wch:8}];
XLSX.utils.book_append_sheet(wb,ws1,'AIë¶„ì„ê²°ê³¼');

// Sheet2: ì„ ìƒë‹˜ ì‘ì„±ìš©
const s2Data=[
['ìƒë‹´ ê¸°ë¡ ì‘ì„± ì‹œíŠ¸ - '+m.name+' ('+m.num+'ë²ˆ)','',' ',''],
['ì˜ì—­','ë°”ì´íŠ¸ì œí•œ','ì£¼ìš” í‚¤ì›Œë“œ (ì°¸ê³ )','ì„ ìƒë‹˜ ì‘ì„±ë€'],
['ììœ¨í™œë™','1500',extractKeywords(jh.jayul),''],
['ì§„ë¡œí™œë™','2100',extractKeywords(jh.jinro),''],
['ë™ì•„ë¦¬í™œë™','1500',extractKeywords(jh.dongari),''],
['í–‰ë™íŠ¹ì„±ë°ì¢…í•©ì˜ê²¬','1500',extractKeywords(jh.hangbal),''],
[],['â€» AIë¶„ì„ê²°ê³¼ ì‹œíŠ¸ë¥¼ ì°¸ê³ í•˜ì—¬ ì‘ì„±í•˜ì„¸ìš”.']
];
const ws2=XLSX.utils.aoa_to_sheet(s2Data);
ws2['!cols']=[{wch:20},{wch:10},{wch:40},{wch:60}];
XLSX.utils.book_append_sheet(wb,ws2,'ì„ ìƒë‹˜ì‘ì„±ìš©');

XLSX.writeFile(wb,`ìƒê¸°ë¶€ë¶„ì„_${m.num}ë²ˆ_${m.name}.xlsx`);
}

function extractKeywords(area){
if(!area)return '';
const t=(area.option1?.text||'')+(area.option2?.text||'');
return t.substring(0,100)+'...';
}

// All Excel
function downloadAllExcel(){
if(!Object.keys(students).length){alert('ë¶„ì„ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.');return}
const wb=XLSX.utils.book_new();

// Sheet1: ì „ì²´ í•™ìƒ ëª©ë¡
const listData=[['ë²ˆí˜¸','ì´ë¦„','í¬ë§ì§„ë¡œ','ë™ì•„ë¦¬','ë¶„ì„ì¼','ìš°ì„ ìˆœìœ„']];
Object.values(students).sort((a,b)=>Number(a.num)-Number(b.num)).forEach(s=>{
listData.push([s.num,s.name,s.career,s.club,s.date,(s.result?._meta?.priorities||[]).join('â†’')]);
});
const wsList=XLSX.utils.aoa_to_sheet(listData);
wsList['!cols']=[{wch:6},{wch:10},{wch:15},{wch:15},{wch:12},{wch:20}];
XLSX.utils.book_append_sheet(wb,wsList,'í•™ìƒëª©ë¡');

// Sheet2: ì „ì²´ ìƒë‹´ê¸°ë¡ (ì‘ì„±ìš©)
const recData=[['ë²ˆí˜¸','ì´ë¦„','ììœ¨í™œë™(1500)','ì§„ë¡œí™œë™(2100)','ë™ì•„ë¦¬í™œë™(1500)','í–‰ë°œ(1500)']];
for(let i=1;i<=25;i++){
const s=students[String(i)];
recData.push([i,s?.name||'','','','','']);
}
const wsRec=XLSX.utils.aoa_to_sheet(recData);
wsRec['!cols']=[{wch:6},{wch:10},{wch:50},{wch:60},{wch:50},{wch:50}];
XLSX.utils.book_append_sheet(wb,wsRec,'ìƒë‹´ê¸°ë¡ì‘ì„±');

// Individual sheets
Object.values(students).sort((a,b)=>Number(a.num)-Number(b.num)).forEach(s=>{
if(!s.result||s.result._parseError)return;
const r=s.result,jh=r.jarhaeng||{};
const d=[[`${s.num}ë²ˆ ${s.name} - AI ë¶„ì„ í‚¤ì›Œë“œ ë° ì˜ˆì‹œ`],
['ì˜ì—­','1ì•ˆ','2ì•ˆ','ì¶”ì²œí¬ì¸íŠ¸','ë³´ì™„í¬ì¸íŠ¸']];
['jayul','jinro','dongari','hangbal'].forEach(k=>{
const area=jh[k]||{};const o1=area.option1||{},o2=area.option2||{};
const labels={jayul:'ììœ¨',jinro:'ì§„ë¡œ',dongari:'ë™ì•„ë¦¬',hangbal:'í–‰ë°œ'};
d.push([labels[k],o1.text||'',o2.text||'',o1.focus||'',o1.supplement||'']);
});
const ws=XLSX.utils.aoa_to_sheet(d);
ws['!cols']=[{wch:10},{wch:50},{wch:50},{wch:25},{wch:25}];
XLSX.utils.book_append_sheet(wb,ws,`${s.num}_${s.name}`);
});

XLSX.writeFile(wb,'ìƒê¸°ë¶€ë¶„ì„_ì „ì²´_'+new Date().toLocaleDateString('ko-KR').replace(/\./g,'')+'.xlsx');
}

// Student list
function renderStudentList(){
const list=document.getElementById('studentList');
const entries=Object.values(students).sort((a,b)=>Number(a.num)-Number(b.num));
if(!entries.length){list.innerHTML='<div style="padding:12px;color:var(--sub);text-align:center">ì•„ì§ ë¶„ì„ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</div>';return}
list.innerHTML=entries.map(s=>`<div class="student-item"><span><span class="num">${s.num}ë²ˆ</span> ${s.name}</span><span>${s.career} Â· ${s.date} <span class="done-mark">âœ…</span></span></div>`).join('');
}

// Next student
function nextStudent(){
document.getElementById('resultSection').style.display='none';
document.getElementById('stuName').value='';
document.getElementById('stuCareer').value='';
document.getElementById('stuClub').value='';
document.getElementById('counselMemo').value='';
pdfText='';
document.getElementById('dropzone').classList.remove('done');
document.getElementById('dropzone').querySelector('.dropzone-icon').textContent='ğŸ“';
document.getElementById('dropzone').querySelector('.dropzone-main').textContent='PDF íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”';
document.getElementById('dropzone').querySelector('.dropzone-sub').textContent='í•™ìƒ ìƒê¸°ë¶€ PDF (1,2í•™ë…„ ê¸°ë¡ í¬í•¨)';
document.getElementById('fileInfo').classList.add('hidden');
document.getElementById('fileInput').value='';
const curNum=parseInt(document.getElementById('stuNum').value)||0;
if(curNum<25)document.getElementById('stuNum').value=curNum+1;
checkReady();
window.scrollTo({top:0,behavior:'smooth'});
}
</script>
</body>
</html>
